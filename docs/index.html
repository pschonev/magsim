<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>Magical Athlete Simulator</title>
    <script type="module" crossorigin src="./assets/index-Cq_ZnpmP.js"></script>
    <link rel="modulepreload" crossorigin href="./assets/preload-helper-BW0IMuFq.js">
    <link rel="modulepreload" crossorigin href="./assets/hotkeys-uKX61F1_.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-BLUna9fQ.js">
    <link rel="modulepreload" crossorigin href="./assets/precisionRound-Cl9k9ZmS.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-DzliDDTm.js">
    <link rel="modulepreload" crossorigin href="./assets/vega-loader.browser-C8wT63Va.js">
    <link rel="modulepreload" crossorigin href="./assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-CrRUCOBw.js">
    <link rel="modulepreload" crossorigin href="./assets/clsx-D0MtrJOx.js">
    <link rel="modulepreload" crossorigin href="./assets/cn-C1rgT0yh.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin href="./assets/react-BGmjiNul.js">
    <link rel="modulepreload" crossorigin href="./assets/compiler-runtime-DeeZ7FnK.js">
    <link rel="modulepreload" crossorigin href="./assets/jsx-runtime-DN_bIXfG.js">
    <link rel="modulepreload" crossorigin href="./assets/badge-DAnNhy3O.js">
    <link rel="modulepreload" crossorigin href="./assets/useEventListener-COkmyg1v.js">
    <link rel="modulepreload" crossorigin href="./assets/button-B8cGZzP5.js">
    <link rel="modulepreload" crossorigin href="./assets/react-dom-C9fstfnp.js">
    <link rel="modulepreload" crossorigin href="./assets/Combination-D1TsGrBC.js">
    <link rel="modulepreload" crossorigin href="./assets/menu-items-9PZrU2e0.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CBrDuocE.js">
    <link rel="modulepreload" crossorigin href="./assets/createLucideIcon-CW2xpJ57.js">
    <link rel="modulepreload" crossorigin href="./assets/check-CrAQug3q.js">
    <link rel="modulepreload" crossorigin href="./assets/select-D9lTzMzP.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-CvjcEpZC.js">
    <link rel="modulepreload" crossorigin href="./assets/use-toast-Bzf3rpev.js">
    <link rel="modulepreload" crossorigin href="./assets/_getTag-BWqNuuwU.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseIsEqual-Cz9Tt_-E.js">
    <link rel="modulepreload" crossorigin href="./assets/useEvent-DlWF5OMa.js">
    <link rel="modulepreload" crossorigin href="./assets/invariant-C6yE60hi.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin href="./assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin href="./assets/zod-Cg4WLWh2.js">
    <link rel="modulepreload" crossorigin href="./assets/utils-pfqq9IdB.js">
    <link rel="modulepreload" crossorigin href="./assets/constants-Bkp4R3bQ.js">
    <link rel="modulepreload" crossorigin href="./assets/Deferred-DzyBMRsy.js">
    <link rel="modulepreload" crossorigin href="./assets/config-D6nhy4FA.js">
    <link rel="modulepreload" crossorigin href="./assets/uuid-ClFZlR7U.js">
    <link rel="modulepreload" crossorigin href="./assets/DeferredRequestRegistry-B3BENoUa.js">
    <link rel="modulepreload" crossorigin href="./assets/requests-C0HaHO6a.js">
    <link rel="modulepreload" crossorigin href="./assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin href="./assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin href="./assets/_hasUnicode-zBEpxwYe.js">
    <link rel="modulepreload" crossorigin href="./assets/useLifecycle-CmDXEyIC.js">
    <link rel="modulepreload" crossorigin href="./assets/useNonce-EAuSVK-5.js">
    <link rel="modulepreload" crossorigin href="./assets/useTheme-CNj0G_ol.js">
    <link rel="modulepreload" crossorigin href="./assets/once-CTiSlR1m.js">
    <link rel="modulepreload" crossorigin href="./assets/capabilities-BmAOeMOK.js">
    <link rel="modulepreload" crossorigin href="./assets/createReducer-DDa-hVe3.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CAcX026F.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-DKNOF5xd.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CI6_zMIl.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BVf1IY4_.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Cq_4nPfh.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CVj-_Iiz.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-HGZzCB0y.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-RKnr9SNh.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BuhT82Xx.js">
    <link rel="modulepreload" crossorigin href="./assets/stex-0ac7Aukl.js">
    <link rel="modulepreload" crossorigin href="./assets/toDate-5JckKRQn.js">
    <link rel="modulepreload" crossorigin href="./assets/cjs-Bj40p_Np.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayReduce-bZBYsK-u.js">
    <link rel="modulepreload" crossorigin href="./assets/type-BdyvjzTI.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseProperty-DuoFhI7N.js">
    <link rel="modulepreload" crossorigin href="./assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin href="./assets/debounce-BbFlGgjv.js">
    <link rel="modulepreload" crossorigin href="./assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin href="./assets/database-zap-CaVvnK_o.js">
    <link rel="modulepreload" crossorigin href="./assets/main-CwSdzVhm.js">
    <link rel="modulepreload" crossorigin href="./assets/cells-CpvLRFsM.js">
    <link rel="modulepreload" crossorigin href="./assets/ErrorBoundary-C7JBxSzd.js">
    <link rel="modulepreload" crossorigin href="./assets/kbd-Czc5z_04.js">
    <link rel="modulepreload" crossorigin href="./assets/useInstallPackage-RldLPyJs.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-dialog-jcHA5geR.js">
    <link rel="modulepreload" crossorigin href="./assets/dialog-CF5DtF1E.js">
    <link rel="modulepreload" crossorigin href="./assets/useDebounce-em3gna-v.js">
    <link rel="modulepreload" crossorigin href="./assets/numbers-C9_R_vlY.js">
    <link rel="modulepreload" crossorigin href="./assets/SSRProvider-DD7JA3RM.js">
    <link rel="modulepreload" crossorigin href="./assets/context-DHfVoQfl.js">
    <link rel="modulepreload" crossorigin href="./assets/useNumberFormatter-FoXhpyAb.js">
    <link rel="modulepreload" crossorigin href="./assets/usePress-DTwIUo40.js">
    <link rel="modulepreload" crossorigin href="./assets/input-B80Yt1uu.js">
    <link rel="modulepreload" crossorigin href="./assets/ImperativeModal-DVhvP4lH.js">
    <link rel="modulepreload" crossorigin href="./assets/cell-link-Dz1jd8Ir.js">
    <link rel="modulepreload" crossorigin href="./assets/multi-map-CQd4MZr5.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-BEdExd6A.js">
    <link rel="modulepreload" crossorigin href="./assets/chevron-right-CqEd11Di.js">
    <link rel="modulepreload" crossorigin href="./assets/dropdown-menu-BP4_BZLr.js">
    <link rel="modulepreload" crossorigin href="./assets/links-DNmjkr65.js">
    <link rel="modulepreload" crossorigin href="./assets/datasource-Bm5VLYk2.js">
    <link rel="modulepreload" crossorigin href="./assets/state-CJMywDNY.js">
    <link rel="modulepreload" crossorigin href="./assets/MarimoErrorOutput-By2cOynM.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-DRhpWiOq.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-gBVL4NN-.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-icon-jWsqdLn1.js">
    <link rel="modulepreload" crossorigin href="./assets/spinner-C1czjtp7.js">
    <link rel="modulepreload" crossorigin href="./assets/es-Biy2OCfF.js">
    <link rel="modulepreload" crossorigin href="./assets/focus-DmVMvj8M.js">
    <link rel="modulepreload" crossorigin href="./assets/LazyAnyLanguageCodeMirror-Cp2punaU.js">
    <link rel="modulepreload" crossorigin href="./assets/katex-AwOI3EvM.js">
    <link rel="modulepreload" crossorigin href="./assets/marked.esm-CHnOtnr3.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-OGVTOU66-CjNLT2C3.js">
    <link rel="modulepreload" crossorigin href="./assets/markdown-renderer-ueIadUZx.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Dg7UO_Vw.js">
    <link rel="modulepreload" crossorigin href="./assets/command-CiJW14cR.js">
    <link rel="modulepreload" crossorigin href="./assets/popover-DtnzNVk-.js">
    <link rel="modulepreload" crossorigin href="./assets/useRunCells-Cm_P3BT1.js">
    <link rel="modulepreload" crossorigin href="./assets/mode-wovPGH9p.js">
    <link rel="modulepreload" crossorigin href="./assets/purify.es-N-2faAGj.js">
    <link rel="modulepreload" crossorigin href="./assets/RenderHTML-B8p715zK.js">
    <link rel="modulepreload" crossorigin href="./assets/table--_20dwBZ.js">
    <link rel="modulepreload" crossorigin href="./assets/tabs-Ctk4D03n.js">
    <link rel="modulepreload" crossorigin href="./assets/useAsyncData-BJJJOr9W.js">
    <link rel="modulepreload" crossorigin href="./assets/useIframeCapabilities-CU-WWxnz.js">
    <link rel="modulepreload" crossorigin href="./assets/error-banner-DvT0IGDZ.js">
    <link rel="modulepreload" crossorigin href="./assets/formats-B9CrBoaO.js">
    <link rel="modulepreload" crossorigin href="./assets/en-US-DhMN8sxe.js">
    <link rel="modulepreload" crossorigin href="./assets/isValid-DhzaK-Y1.js">
    <link rel="modulepreload" crossorigin href="./assets/dates-CdsE1R40.js">
    <link rel="modulepreload" crossorigin href="./assets/download-CcAOzx6T.js">
    <link rel="modulepreload" crossorigin href="./assets/maps-s2pQkyf5.js">
    <link rel="modulepreload" crossorigin href="./assets/extends-B9D0JO9U.js">
    <link rel="modulepreload" crossorigin href="./assets/emotion-is-prop-valid.esm-lG8j6oqk.js">
    <link rel="modulepreload" crossorigin href="./assets/useDateFormatter-DsANziQR.js">
    <link rel="modulepreload" crossorigin href="./assets/range-sshwVRcP.js">
    <link rel="modulepreload" crossorigin href="./assets/capitalize-DQeWKRGx.js">
    <link rel="modulepreload" crossorigin href="./assets/table-BLx7B_us.js">
    <link rel="modulepreload" crossorigin href="./assets/JsonOutput-aB5dKsM0.js">
    <link rel="modulepreload" crossorigin href="./assets/file-BnFXtaZZ.js">
    <link rel="modulepreload" crossorigin href="./assets/play-BJDBXApx.js">
    <link rel="modulepreload" crossorigin href="./assets/chat-components-ZPMBgudd.js">
    <link rel="modulepreload" crossorigin href="./assets/isEmpty-DIxUV1UR.js">
    <link rel="modulepreload" crossorigin href="./assets/circle-check-big-OIMTUpe6.js">
    <link rel="modulepreload" crossorigin href="./assets/chat-display-Bru4OSNG.js">
    <link rel="modulepreload" crossorigin href="./assets/ai-model-dropdown-BmUQTAgw.js">
    <link rel="modulepreload" crossorigin href="./assets/renderShortcut-eU5Hsfml.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeleteCell-DMZ3UAH-.js">
    <link rel="modulepreload" crossorigin href="./assets/icons-D4lB4En9.js">
    <link rel="modulepreload" crossorigin href="./assets/process-output-BbPyu6EM.js">
    <link rel="modulepreload" crossorigin href="./assets/blob-Dg_vNTSs.js">
    <link rel="modulepreload" crossorigin href="./assets/objectWithoutPropertiesLoose-CboCOq4o.js">
    <link rel="modulepreload" crossorigin href="./assets/esm-B3JckBtM.js">
    <link rel="modulepreload" crossorigin href="./assets/add-cell-with-ai-DIVGdu6r.js">
    <link rel="modulepreload" crossorigin href="./assets/chart-no-axes-column-D42sFB6d.js">
    <link rel="modulepreload" crossorigin href="./assets/square-function-DxXFdbn8.js">
    <link rel="modulepreload" crossorigin href="./assets/spec-qp_XZeSS.js">
    <link rel="modulepreload" crossorigin href="./assets/column-preview-DtmhBN9V.js">
    <link rel="modulepreload" crossorigin href="./assets/switch-D8i8UxCP.js">
    <link rel="modulepreload" crossorigin href="./assets/toggle-G1t0cQyf.js">
    <link rel="modulepreload" crossorigin href="./assets/globals-h0vQaXwS.js">
    <link rel="modulepreload" crossorigin href="./assets/share-CXQVxivL.js">
    <link rel="modulepreload" crossorigin href="./assets/memoize-DN0TMY36.js">
    <link rel="modulepreload" crossorigin href="./assets/get-CyLJYAfP.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSet-6FYvpjrm.js">
    <link rel="modulepreload" crossorigin href="./assets/react-resizable-panels.browser.esm-BqxQegSf.js">
    <link rel="modulepreload" crossorigin href="./assets/utilities.esm-DvUjESxl.js">
    <link rel="modulepreload" crossorigin href="./assets/floating-outline-DBJNk57_.js">
    <link rel="modulepreload" crossorigin href="./assets/useAddCell-Cc3-yOhX.js">
    <link rel="modulepreload" crossorigin href="./assets/eye-off-D9zAYqG9.js">
    <link rel="modulepreload" crossorigin href="./assets/plus-CHesBJpY.js">
    <link rel="modulepreload" crossorigin href="./assets/readonly-python-code-CoXhoNRa.js">
    <link rel="modulepreload" crossorigin href="./assets/file-video-camera-CZUg-nFA.js">
    <link rel="modulepreload" crossorigin href="./assets/types-DJ8nLAfz.js">
    <link rel="modulepreload" crossorigin href="./assets/label-CNZLffHW.js">
    <link rel="modulepreload" crossorigin href="./assets/textarea-DfnWQ2d8.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-ccw-DbW1_PHb.js">
    <link rel="modulepreload" crossorigin href="./assets/trash-2-C-lF7BNB.js">
    <link rel="modulepreload" crossorigin href="./assets/form-BlH9lWzg.js">
    <link rel="modulepreload" crossorigin href="./assets/field-Clr_fqUr.js">
    <link rel="modulepreload" crossorigin href="./assets/useBoolean-B_S7yTZz.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeepCompareMemoize-gzLRYatP.js">
    <link rel="modulepreload" crossorigin href="./assets/types-B42u_5hF.js">
    <link rel="modulepreload" crossorigin href="./assets/prop-types-C638SUfx.js">
    <link rel="modulepreload" crossorigin href="./assets/es-FiXEquL2.js">
    <link rel="modulepreload" crossorigin href="./assets/VisuallyHidden-B9t3FhTP.js">
    <link rel="modulepreload" crossorigin href="./assets/hasIn-DydgU7lx.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFlatten-CLPh0yMf.js">
    <link rel="modulepreload" crossorigin href="./assets/flatten-Buk63LQO.js">
    <link rel="modulepreload" crossorigin href="./assets/pick-DeQioq0G.js">
    <link rel="modulepreload" crossorigin href="./assets/code-xml-MBUyxNtK.js">
    <link rel="modulepreload" crossorigin href="./assets/download-DobaYJPt.js">
    <link rel="modulepreload" crossorigin href="./assets/house-CncUa_LL.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-cw-Din9uFKE.js">
    <link rel="modulepreload" crossorigin href="./assets/settings-MTlHVxz3.js">
    <link rel="modulepreload" crossorigin href="./assets/square-leQTJTJJ.js">
    <link rel="modulepreload" crossorigin href="./assets/triangle-alert-CbD0f2J6.js">
    <link rel="modulepreload" crossorigin href="./assets/bundle.esm-B0Sy2M4C.js">
    <link rel="stylesheet" crossorigin href="./assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin href="./assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin href="./assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin href="./assets/index-DDc_1b-N.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <style title='marimo-custom'>/* DARK BUTTONS */

/* Button Styling */
button,
.marimo-btn,
[role="button"] {
    /* Very dark grey, almost black */
    background-color: #222222 !important;
    
    /* Text Color */
    color: #e0e0e0 !important;
    
    /* Remove borders/outlines */
    border: white !important;
}

/* Hover State - Subtle Lift */
button:hover,
.marimo-btn:hover,
[role="button"]:hover {
    /* Slightly lighter on hover to show interactivity */
    background-color: #2d2d2d !important; 
    color: #ffffff !important;
}


/* 4. Active/Pressed State */
button:active,
.marimo-btn:active,
[role="button"]:active {
    background-color: #3d3d3d !important; /* Pure black on click */
}

/* 5. Disabled State */
button:disabled,
button[disabled] {
    background-color: #111111 !important;
    color: #444444 !important;
    cursor: not-allowed !important;
}
</style><marimo-code hidden="">%23%20%2F%2F%2F%20script%0A%23%20requires-python%20%3D%20%22%3E%3D3.14%22%0A%23%20dependencies%20%3D%20%5B%0A%23%20%20%20%20%20%22altair%3D%3D6.0.0%22%2C%0A%23%20%20%20%20%20%22marimo%3E%3D0.19.0%22%2C%0A%23%20%20%20%20%20%22polars%3D%3D1.36.1%22%2C%0A%23%20%20%20%20%20%22sqlmodel%3D%3D0.0.31%22%2C%0A%23%20%20%20%20%20%22numpy%3E%3D2.4.1%22%0A%23%20%5D%0A%23%20%5Btool.marimo.display%5D%0A%23%20theme%20%3D%20%22dark%22%0A%23%20%2F%2F%2F%0A%0Aimport%20marimo%0A%0A__generated_with%20%3D%20%220.19.4%22%0Aapp%20%3D%20marimo.App(%0A%20%20%20%20width%3D%22full%22%2C%0A%20%20%20%20app_title%3D%22Magical%20Athlete%20Simulator%22%2C%0A%20%20%20%20css_file%3D%22docs%2Fmagical_athlete_analysis.css%22%2C%0A)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20sys%0A%0A%20%20%20%20print(sys.version)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Aasync%20def%20_()%3A%0A%20%20%20%20from%20__future__%20import%20annotations%0A%0A%20%20%20%20import%20logging%0A%20%20%20%20import%20math%0A%20%20%20%20import%20micropip%0A%20%20%20%20import%20re%0A%20%20%20%20from%20typing%20import%20get_args%2C%20Any%2C%20Literal%0A%20%20%20%20import%20dataclasses%0A%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20altair%20as%20alt%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20from%20rich.console%20import%20Console%0A%20%20%20%20from%20rich.logging%20import%20RichHandler%0A%0A%20%20%20%20MAGICAL_ATHLETE_SIMULATOR_VERSION%20%3D%20%220.7.1%22%0A%20%20%20%20await%20micropip.install(%0A%20%20%20%20%20%20%20%20f%22magical-athlete-simulator%3D%3D%7BMAGICAL_ATHLETE_SIMULATOR_VERSION%7D%22%2C%0A%20%20%20%20%20%20%20%20keep_going%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20from%20magical_athlete_simulator.core.events%20import%20(%0A%20%20%20%20%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magical_athlete_simulator.core.types%20import%20RacerName%0A%20%20%20%20from%20magical_athlete_simulator.engine.board%20import%20(%0A%20%20%20%20%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20%20%20%20%20TripTile%2C%0A%20%20%20%20%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magical_athlete_simulator.engine.logging%20import%20(%0A%20%20%20%20%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magical_athlete_simulator.simulation.telemetry%20import%20StepSnapshot%0A%0A%20%20%20%20%23%20Imports%0A%20%20%20%20from%20magical_athlete_simulator.engine.scenario%20import%20GameScenario%2C%20RacerConfig%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Any%2C%0A%20%20%20%20%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20%20%20%20%20Console%2C%0A%20%20%20%20%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20%20%20%20%20GameScenario%2C%0A%20%20%20%20%20%20%20%20Literal%2C%0A%20%20%20%20%20%20%20%20MAGICAL_ATHLETE_SIMULATOR_VERSION%2C%0A%20%20%20%20%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20%20%20%20%20RacerConfig%2C%0A%20%20%20%20%20%20%20%20RacerName%2C%0A%20%20%20%20%20%20%20%20RichHandler%2C%0A%20%20%20%20%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20%20%20%20%20StepSnapshot%2C%0A%20%20%20%20%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20%20%20%20%20TripTile%2C%0A%20%20%20%20%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20%20%20%20%20alt%2C%0A%20%20%20%20%20%20%20%20dataclasses%2C%0A%20%20%20%20%20%20%20%20get_args%2C%0A%20%20%20%20%20%20%20%20logging%2C%0A%20%20%20%20%20%20%20%20math%2C%0A%20%20%20%20%20%20%20%20mo%2C%0A%20%20%20%20%20%20%20%20np%2C%0A%20%20%20%20%20%20%20%20re%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20import%20polars%20as%20pl%0A%20%20%20%20from%20pathlib%20import%20Path%0A%0A%20%20%20%20reload_data_btn%20%3D%20mo.ui.button(label%3D%22%E2%9F%B3%20Reload%20Data%22)%0A%0A%20%20%20%20%23%201.%20Get%20location%20and%20check%20type%0A%20%20%20%20notebook_loc%20%3D%20mo.notebook_location()%0A%20%20%20%20is_url%20%3D%20isinstance(notebook_loc%2C%20mo._runtime.runtime.URLPath)%0A%0A%20%20%20%20default_results_path%20%3D%20(%0A%20%20%20%20%20%20%20%20notebook_loc%20%2F%20%22results%22%20if%20is_url%20else%20notebook_loc%20%2F%20%22..%22%20%2F%20%22results%22%0A%20%20%20%20)%0A%0A%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20%23%20If%20running%20via%20URL%20(e.g.%20WASM)%2C%20we%20can't%20use%20a%20local%20file%20browser%0A%20%20%20%20%20%20%20%20results_folder_browser%20%3D%20None%0A%20%20%20%20%20%20%20%20print(f%22Running%20in%20URL%20mode.%20Base%3A%20%7Bdefault_results_path%7D%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%23%20If%20local%2C%20create%20the%20browser%0A%20%20%20%20%20%20%20%20%23%20Ensure%20we%20convert%20Path%20to%20string%20for%20the%20widget%0A%20%20%20%20%20%20%20%20results_folder_browser%20%3D%20mo.ui.file_browser(%0A%20%20%20%20%20%20%20%20%20%20%20%20selection_mode%3D%22directory%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22Select%20Results%20Folder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20initial_path%3Dstr(default_results_path)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20print(f%22Running%20locally.%20Default%20results%20path%3A%20%7Bdefault_results_path%7D%22)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Path%2C%0A%20%20%20%20%20%20%20%20default_results_path%2C%0A%20%20%20%20%20%20%20%20is_url%2C%0A%20%20%20%20%20%20%20%20pl%2C%0A%20%20%20%20%20%20%20%20reload_data_btn%2C%0A%20%20%20%20%20%20%20%20results_folder_browser%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20Path%2C%0A%20%20%20%20default_results_path%2C%0A%20%20%20%20is_url%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20reload_data_btn%2C%0A%20%20%20%20results_folder_browser%2C%0A)%3A%0A%20%20%20%20reload_data_btn.value%0A%0A%20%20%20%20%23%201.%20Determine%20the%20Base%20Folder%0A%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20%23%20URL%20Mode%3A%20Use%20the%20URLPath%20object%20directly%0A%20%20%20%20%20%20%20%20base_folder%20%3D%20default_results_path%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%23%20Local%20Mode%3A%20Use%20browser%20value%20if%20selected%2C%20else%20default%0A%20%20%20%20%20%20%20%20if%20results_folder_browser.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20base_folder%20%3D%20Path(results_folder_browser.value%5B0%5D.path)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20base_folder%20%3D%20Path(%22results%22)%0A%0A%20%20%20%20%23%202.%20Construct%20Paths%0A%20%20%20%20%23%20(The%20%2F%20operator%20works%20on%20both%20pathlib.Path%20and%20marimo%20URLPath%20objects)%0A%20%20%20%20path_races%20%3D%20base_folder%20%2F%20%22races.parquet%22%0A%20%20%20%20path_res%20%3D%20base_folder%20%2F%20%22racer_results.parquet%22%0A%20%20%20%20path_positions%20%3D%20base_folder%20%2F%20%22race_positions.parquet%22%0A%0A%20%20%20%20%23%203.%20Load%20Data%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20if%20not%20is_url%3A%20%20%23%20noqa%3A%20SIM102%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20not%20Path(path_races).exists()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20or%20not%20Path(path_res).exists()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20or%20not%20Path(path_positions).exists()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20FileNotFoundError(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Folder%20'%7Bbase_folder%7D'%20must%20contain%20'races.parquet'%2C%20'racer_results.parquet'%20and%20'race_positions.parquet'%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20io%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20urllib.request%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20pyarrow%20as%20pa%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_wasm_read_parquet(path%3A%20Path)%20-%3E%20pl.DataFrame%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20with%20urllib.request.urlopen(path)%20as%20response%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parquet_bytes%20%3D%20response.read()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20pl.read_parquet(io.BytesIO(parquet_bytes)%2C%20use_pyarrow%3DTrue)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results%20%3D%20_wasm_read_parquet(path_res)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races%20%3D%20_wasm_read_parquet(path_races)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_positions%20%3D%20_wasm_read_parquet(path_positions)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results%20%3D%20pl.read_parquet(path_res)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races%20%3D%20pl.read_parquet(path_races)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_positions%20%3D%20pl.read_parquet(path_positions)%0A%20%20%20%20%20%20%20%20load_status%20%3D%20f%22%E2%9C%85%20Loaded%20from%3A%20%60%7Bbase_folder%7D%60%22%0A%0A%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20df_racer_results%20%3D%20pl.DataFrame()%0A%20%20%20%20%20%20%20%20df_races%20%3D%20pl.DataFrame()%0A%20%20%20%20%20%20%20%20df_positions%20%3D%20pl.DataFrame()%0A%20%20%20%20%20%20%20%20load_status%20%3D%20f%22%E2%9D%8C%20Error%3A%20%7Bstr(e)%7D%22%0A%20%20%20%20%20%20%20%20print(load_status)%0A%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22df_racer_results%3A%20%7Bdf_racer_results.height%7D%20rows%2C%20path%20%60%7Bpath_races%7D%60%20and%20columns%3A%20%7Bdf_racer_results.columns%7D%22%0A%20%20%20%20)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22df_racer_results%3A%20%7Bdf_races.height%7D%20rows%2C%20path%20%60%7Bpath_res%7D%60%20and%20columns%3A%20%7Bdf_races.columns%7D%22%0A%20%20%20%20)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22df_racer_results%3A%20%7Bdf_positions.height%7D%20rows%2C%20path%20%60%7Bpath_positions%7D%60%20and%20columns%3A%20%7Bdf_positions.columns%7D%22%0A%20%20%20%20)%0A%20%20%20%20return%20df_positions%2C%20df_racer_results%2C%20df_races%2C%20load_status%0A%0A%0A%40app.cell%0Adef%20_(df_racer_results%2C%20df_races%2C%20mo%2C%20pl)%3A%0A%20%20%20%20import%20json%20%20%23%20Required%20for%20the%20WASM%20fix%0A%0A%20%20%20%20HASH_COL%20%3D%20%22config_hash%22%0A%0A%20%20%20%20%23%201.%20Get%20unique%20racers%20for%20column%20headers%0A%20%20%20%20unique_racers%20%3D%20sorted(df_racer_results.get_column(%22racer_name%22).unique().to_list())%0A%0A%20%20%20%20%23%202.%20FIX%20DATA%20TYPE%3A%20Decode%20JSON%20-%3E%20List%20(WASM%20Compatible)%0A%20%20%20%20df_races_clean%20%3D%20df_races.with_columns(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_names%22)%0A%20%20%20%20%20%20%20%20.cast(pl.String)%0A%20%20%20%20%20%20%20%20.map_elements(json.loads%2C%20return_dtype%3Dpl.List(pl.String))%0A%20%20%20%20%20%20%20%20.alias(%22racer_names%22)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%203.%20EXPAND%3A%20Create%20Display%20%26%20Boolean%20Columns%0A%20%20%20%20exprs%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%23%20Readable%20string%20for%20searching%0A%20%20%20%20%20%20%20%20pl.col(%22racer_names%22).list.join(%22%2C%20%22).alias(%22roster_display%22)%0A%20%20%20%20%5D%0A%20%20%20%20for%20r%20in%20unique_racers%3A%0A%20%20%20%20%20%20%20%20exprs.append(pl.col(%22racer_names%22).list.contains(r).alias(f%22Has%20%7Br%7D%22))%0A%0A%20%20%20%20df_races_expanded%20%3D%20df_races_clean.with_columns(exprs)%0A%0A%20%20%20%20%23%204.%20DEFINE%20COLUMN%20GROUPS%0A%0A%20%20%20%20%23%20A.%20Priority%20Columns%20(Frozen%20on%20left)%0A%20%20%20%20priority_cols%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22roster_display%22%2C%0A%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%22seed%22%2C%0A%20%20%20%20%20%20%20%20%22error_code%22%2C%0A%20%20%20%20%20%20%20%20%22total_turns%22%2C%0A%20%20%20%20%5D%0A%0A%20%20%20%20%23%20B.%20Matrix%20Columns%20(The%20boolean%20flags)%0A%20%20%20%20matrix_cols%20%3D%20%5Bf%22Has%20%7Br%7D%22%20for%20r%20in%20unique_racers%5D%0A%0A%20%20%20%20%23%20C.%20Columns%20to%20Hide%2FDrop%20explicitly%0A%20%20%20%20drop_cols%20%3D%20%5B%22timestamp%22%5D%20%20%23%20Redundant%20with%20created_at%0A%0A%20%20%20%20%23%20D.%20%22The%20Rest%22%20-%20Calculate%20dynamically%0A%20%20%20%20other_cols%20%3D%20%5B%0A%20%20%20%20%20%20%20%20c%0A%20%20%20%20%20%20%20%20for%20c%20in%20df_races_expanded.columns%0A%20%20%20%20%20%20%20%20if%20c%20not%20in%20priority_cols%20and%20c%20not%20in%20matrix_cols%20and%20c%20not%20in%20drop_cols%0A%20%20%20%20%5D%0A%0A%20%20%20%20racer_results_table%20%3D%20mo.ui.table(%0A%20%20%20%20%20%20%20%20df_racer_results.sort(%5B%22config_hash%22%2C%20%22racer_id%22%5D).select(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.all().exclude(HASH_COL)%2C%20pl.col(HASH_COL)%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20selection%3D%22single%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20Results%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20races_table%20%3D%20mo.ui.table(%0A%20%20%20%20%20%20%20%20df_races_expanded.select(priority_cols%20%2B%20matrix_cols%20%2B%20other_cols)%2C%0A%20%20%20%20%20%20%20%20selection%3D%22single%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Races%20(Matrix%20View)%22%2C%0A%20%20%20%20%20%20%20%20freeze_columns_left%3Dpriority_cols%2C%0A%20%20%20%20)%0A%20%20%20%20return%20df_races_clean%2C%20racer_results_table%2C%20races_table%0A%0A%0A%40app.cell%0Adef%20_(math)%3A%0A%20%20%20%20from%20typing%20import%20NamedTuple%0A%0A%20%20%20%20BG_COLOR%20%3D%20%22%23181c1a%22%0A%0A%20%20%20%20class%20RacerPalette(NamedTuple)%3A%0A%20%20%20%20%20%20%20%20primary%3A%20str%0A%20%20%20%20%20%20%20%20secondary%3A%20str%20%7C%20None%20%3D%20None%0A%20%20%20%20%20%20%20%20outline%3A%20str%20%3D%20%22%23000000%22%0A%0A%20%20%20%20RACER_PALETTES%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22HugeBaby%22%3A%20RacerPalette(%22%23FFB7C5%22%2C%20%22%23FFFFFF%22%2C%20%22%2339FF14%22)%2C%20%20%23%20Pastel%20Pink%20(Baby)%0A%20%20%20%20%20%20%20%20%22Scoocher%22%3A%20RacerPalette(%22%238B4513%22%2C%20%22%23FF0000%22%2C%20%22%23800080%22)%2C%20%20%23%20Brown%20(Snail%2FDog%3F)%0A%20%20%20%20%20%20%20%20%22Genius%22%3A%20RacerPalette(%22%23FF0000%22%2C%20%22%230000FF%22%2C%20%22%23FFFF00%22)%2C%20%20%23%20Bright%20Red%20(Shirt)%0A%20%20%20%20%20%20%20%20%22Banana%22%3A%20RacerPalette(%22%23FFE135%22%2C%20%22%23000000%22%2C%20%22%23800080%22)%2C%20%20%23%20Standard%20Yellow%0A%20%20%20%20%20%20%20%20%22Skipper%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%231A4099%22%2C%20%22%23FFD700%22%2C%20%22%23800080%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Royal%20Blue%20(Primary)%0A%20%20%20%20%20%20%20%20%22PartyAnimal%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%2332CD32%22%2C%20%22%23FFFF00%22%2C%20%22%23FF00FF%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Lime%20Green%20(Primary)%0A%20%20%20%20%20%20%20%20%22Romantic%22%3A%20RacerPalette(%22%23DA70D6%22%2C%20%22%23FFFF00%22%2C%20%22%23800080%22)%2C%20%20%23%20Orchid%20(Primary)%0A%20%20%20%20%20%20%20%20%22Mastermind%22%3A%20RacerPalette(%22%23800080%22%2C%20%22%23FFD700%22%2C%20%22%23008000%22)%2C%20%20%23%20Purple%20(Primary)%0A%20%20%20%20%20%20%20%20%22Copycat%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%2300BFFF%22%2C%20%22%23FFFFFF%22%2C%20%22%23FFA500%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Deep%20Sky%20Blue%20(Cat%3F)%0A%20%20%20%20%20%20%20%20%22Magician%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%235D3FD3%22%2C%20%22%239370DB%22%2C%20%22%23FFA500%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Electric%20Indigo%20%2F%20Iris%20(Lighter%20than%20Midnight%20Blue)%0A%20%20%20%20%20%20%20%20%22Gunk%22%3A%20RacerPalette(%22%23556B2F%22%2C%20%22%238B4513%22%2C%20%22%23FFA500%22)%2C%20%20%23%20Olive%20Drab%0A%20%20%20%20%20%20%20%20%22Centaur%22%3A%20RacerPalette(%22%23D2691E%22%2C%20%22%238B4513%22%2C%20%22%23800080%22)%2C%20%20%23%20Chocolate%0A%20%20%20%20%20%20%20%20%22FlipFlop%22%3A%20RacerPalette(%22%239370DB%22%2C%20%22%23FFFF00%22%2C%20%22%23FF0000%22)%2C%20%20%23%20Medium%20Purple%0A%20%20%20%20%20%20%20%20%22Hare%22%3A%20RacerPalette(%22%2387CEEB%22%2C%20None%2C%20%22%23FF8C00%22)%2C%20%20%23%20Sky%20Blue%20%26%20Dark%20Orange%0A%20%20%20%20%20%20%20%20%22Blimp%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23D3D3D3%22%2C%20%22%234169E1%22%2C%20%22%23000000%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Light%20Grey%20%26%20Royal%20Blue%0A%20%20%20%20%20%20%20%20%22Suckerfish%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23808000%22%2C%20%22%23FF4500%22%2C%20%22%231E90FF%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Olive%20(Muddy)%20%26%20OrangeRed%20%26%20Dodger%20Blue%0A%20%20%20%20%20%20%20%20%22Leapfrog%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%231E90FF%22%2C%20%22%2332CD32%22%2C%20%22%23FF8C00%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Dodger%20Blue%20%26%20Lime%20Green%20%26%20Dark%20Orange%0A%20%20%20%20%20%20%20%20%22Sisyphus%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23C0C0C0%22%2C%20%22%23FFFFFF%22%2C%20%22%23FFD700%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Silver%20%26%20White%20%26%20Gold%0A%20%20%20%20%20%20%20%20%22LovableLoser%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23008000%22%2C%20%22%23FF00FF%22%2C%20%22%23FFA500%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Green%20%26%20Magenta%20%26%20Orange%0A%20%20%20%20%20%20%20%20%22Coach%22%3A%20RacerPalette(%22%23636829%22%2C%20%22%23DC143C%22%2C%20%22%238A2BE2%22)%2C%20%20%23%20Muddy%20Lizard%20Green%0A%20%20%20%20%20%20%20%20%22Stickler%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23C71585%22%2C%20%22%23FF69B4%22%2C%20%22%230000FF%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Medium%20Violet%20Red%20%26%20Hot%20Pink%20%26%20Blue%0A%20%20%20%20%20%20%20%20%22BabaYaga%22%3A%20RacerPalette(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%234682B4%22%2C%20%22%23FFD700%22%2C%20%22%23FF0000%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20Steel%20Blue%20%26%20Gold%20%26%20Red%0A%20%20%20%20%7D%0A%0A%20%20%20%20FALLBACK_PALETTES%20%3D%20%5B%0A%20%20%20%20%20%20%20%20RacerPalette(%22%238A2BE2%22%2C%20None%2C%20%22%23000%22)%2C%0A%20%20%20%20%20%20%20%20RacerPalette(%22%235F9EA0%22%2C%20None%2C%20%22%23000%22)%2C%0A%20%20%20%20%20%20%20%20RacerPalette(%22%23D2691E%22%2C%20None%2C%20%22%23000%22)%2C%0A%20%20%20%20%5D%0A%0A%20%20%20%20%23%20---%20CONSTANTS%3A%20BOARD%20THEME%20---%0A%20%20%20%20BOARD_THEME%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22background%22%3A%20BG_COLOR%2C%0A%20%20%20%20%20%20%20%20%22tile_1%22%3A%20%22%232d3432%22%2C%0A%20%20%20%20%20%20%20%20%22tile_2%22%3A%20%22%23363e3b%22%2C%0A%20%20%20%20%20%20%20%20%22stroke_default%22%3A%20%22%23555%22%2C%0A%20%20%20%20%20%20%20%20%22text_default%22%3A%20%22%23aaa%22%2C%0A%20%20%20%20%20%20%20%20%23%20Special%20Tiles%0A%20%20%20%20%20%20%20%20%22start_fill%22%3A%20%22%234CAF50%22%2C%0A%20%20%20%20%20%20%20%20%22start_text%22%3A%20%22%234CAF50%22%2C%0A%20%20%20%20%20%20%20%20%22start_stroke%22%3A%20%22%23D3D3D3%22%2C%20%20%23%20%5BNEW%5D%20Light%20Grey%0A%20%20%20%20%20%20%20%20%22goal_fill%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22goal_text%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22goal_stroke%22%3A%20%22%23C5A059%22%2C%20%20%23%20%5BNEW%5D%20Muted%20Golden%0A%20%20%20%20%20%20%20%20%22trip_fill%22%3A%20%22%23111111%22%2C%0A%20%20%20%20%20%20%20%20%22trip_text%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22vp_fill%22%3A%20%22%2381D4FA%22%2C%0A%20%20%20%20%20%20%20%20%22vp_text%22%3A%20%22%23000000%22%2C%0A%20%20%20%20%20%20%20%20%22move_pos_fill%22%3A%20%22%23A5D6A7%22%2C%0A%20%20%20%20%20%20%20%20%22move_pos_text%22%3A%20%22%231B5E20%22%2C%0A%20%20%20%20%20%20%20%20%22move_neg_fill%22%3A%20%22%23EF9A9A%22%2C%0A%20%20%20%20%20%20%20%20%22move_neg_text%22%3A%20%22%23B71C1C%22%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%20---%20HELPER%20FUNCTIONS%20---%0A%20%20%20%20def%20get_racer_palette(name%3A%20str)%20-%3E%20RacerPalette%3A%0A%20%20%20%20%20%20%20%20if%20name%20in%20RACER_PALETTES%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20RACER_PALETTES%5Bname%5D%0A%20%20%20%20%20%20%20%20return%20FALLBACK_PALETTES%5Bhash(name)%20%25%20len(FALLBACK_PALETTES)%5D%0A%0A%20%20%20%20def%20get_racer_color(name%3A%20str)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20return%20get_racer_palette(name).primary%0A%0A%20%20%20%20def%20generate_racetrack_positions(%0A%20%20%20%20%20%20%20%20num_spaces%2C%20start_x%2C%20start_y%2C%20straight_len%2C%20radius%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Generates%20a%20Clockwise%20stadium%20track%20starting%20from%20the%20Top-Left%20straight.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20positions%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20perimeter%20%3D%20(2%20*%20straight_len)%20%2B%20(2%20*%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20step_distance%20%3D%20perimeter%20%2F%20num_spaces%0A%0A%20%20%20%20%20%20%20%20right_circle_cx%20%3D%20start_x%20%2B%20straight_len%0A%20%20%20%20%20%20%20%20right_circle_cy%20%3D%20start_y%20%2B%20radius%0A%20%20%20%20%20%20%20%20left_circle_cx%20%3D%20start_x%0A%20%20%20%20%20%20%20%20left_circle_cy%20%3D%20start_y%20%2B%20radius%0A%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(num_spaces)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20dist%20%3D%20i%20*%20step_distance%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Top%20Straight%20(Moving%20Right)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20dist%20%3C%20straight_len%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20start_x%20%2B%20dist%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20start_y%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Right%20Curve%20(Moving%20Clockwise%2FDown)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20dist%20%3C%20(straight_len%20%2B%20math.pi%20*%20radius)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arc_dist%20%3D%20dist%20-%20straight_len%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fraction%20%3D%20arc_dist%20%2F%20(math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20theta%20%3D%20(-math.pi%20%2F%202)%20%2B%20(fraction%20*%20math.pi)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20right_circle_cx%20%2B%20radius%20*%20math.cos(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20right_circle_cy%20%2B%20radius%20*%20math.sin(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20math.degrees(theta)%20%2B%2090%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20Bottom%20Straight%20(Moving%20Left)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20dist%20%3C%20(2%20*%20straight_len%20%2B%20math.pi%20*%20radius)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20top_dist%20%3D%20dist%20-%20(straight_len%20%2B%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20(start_x%20%2B%20straight_len)%20-%20top_dist%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20start_y%20%2B%20(2%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20180%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Left%20Curve%20(Moving%20Clockwise%2FUp)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arc_dist%20%3D%20dist%20-%20(2%20*%20straight_len%20%2B%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fraction%20%3D%20arc_dist%20%2F%20(math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20theta%20%3D%20(math.pi%20%2F%202)%20%2B%20(fraction%20*%20math.pi)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20left_circle_cx%20%2B%20radius%20*%20math.cos(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20left_circle_cy%20%2B%20radius%20*%20math.sin(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20math.degrees(theta)%20%2B%2090%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20positions.append((x%2C%20y%2C%20angle))%0A%0A%20%20%20%20%20%20%20%20return%20positions%0A%0A%20%20%20%20%23%20Constants%0A%20%20%20%20NUM_TILES%20%3D%2031%0A%20%20%20%20board_positions%20%3D%20generate_racetrack_positions(NUM_TILES%2C%20120%2C%20150%2C%20350%2C%20100)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20BG_COLOR%2C%0A%20%20%20%20%20%20%20%20BOARD_THEME%2C%0A%20%20%20%20%20%20%20%20board_positions%2C%0A%20%20%20%20%20%20%20%20get_racer_color%2C%0A%20%20%20%20%20%20%20%20get_racer_palette%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BOARD_THEME%2C%0A%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20StepSnapshot%2C%0A%20%20%20%20TripTile%2C%0A%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20get_racer_palette%2C%0A%20%20%20%20math%2C%0A)%3A%0A%20%20%20%20%23%20---%20RENDERER%20(RAW%20%2F%20UNPATCHED)%20---%0A%20%20%20%20def%20render_game_track(turn_data%3A%20StepSnapshot%2C%20positions_map%2C%20board%3DNone)%3A%0A%20%20%20%20%20%20%20%20import%20html%20as%20_html%0A%0A%20%20%20%20%20%20%20%20%23%20---%20VISUALIZATION%20CONSTANTS%20---%0A%20%20%20%20%20%20%20%20MAIN_RADIUS%20%3D%209.0%0A%20%20%20%20%20%20%20%20SECONDARY_RADIUS%20%3D%208.0%0A%20%20%20%20%20%20%20%20OUTLINE_WIDTH%20%3D%201.5%0A%20%20%20%20%20%20%20%20SECONDARY_WIDTH%20%3D%201.5%0A%20%20%20%20%20%20%20%20TEXT_STROKE_WIDTH%20%3D%20%224px%22%0A%0A%20%20%20%20%20%20%20%20if%20not%20turn_data%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22%3Cp%3ENo%20Data%3C%2Fp%3E%22%0A%0A%20%20%20%20%20%20%20%20svg_elements%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Dimensions%20%26%20Scaling%0A%20%20%20%20%20%20%20%20W%2C%20H%20%3D%201000%2C%20600%0A%20%20%20%20%20%20%20%20scale_factor%20%3D%201.45%0A%20%20%20%20%20%20%20%20trans_x%20%3D%2075%0A%20%20%20%20%20%20%20%20trans_y%20%3D%20-60%0A%20%20%20%20%20%20%20%20rw%2C%20rh%20%3D%2050%2C%2030%0A%0A%20%20%20%20%20%20%20%20%23%201.%20Track%20Groups%0A%20%20%20%20%20%20%20%20track_group_start%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20f'%3Cg%20transform%3D%22translate(%7Btrans_x%7D%2C%20%7Btrans_y%7D)%20scale(%7Bscale_factor%7D)%22%3E'%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Track%20Spaces%0A%20%20%20%20%20%20%20%20for%20i%2C%20(cx%2C%20cy%2C%20rot)%20in%20enumerate(positions_map)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20transform%20%3D%20f%22rotate(%7Brot%7D%2C%20%7Bcx%7D%2C%20%7Bcy%7D)%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%201.%20DEFAULT%20STYLES%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20is_start%20%3D%20i%20%3D%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20is_end%20%3D%20i%20%3D%3D%20len(positions_map)%20-%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(i%20%2F%2F%202)%20%25%202%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22tile_1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22tile_2%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22stroke_default%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%222%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20str(i)%0A%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22text_default%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20font_weight%20%3D%20%22bold%22%0A%20%20%20%20%20%20%20%20%20%20%20%20font_size%20%3D%20%2210%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%202.%20SPECIAL%20TILE%20LOGIC%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20board%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mods%20%3D%20board.static_features.get(i%2C%20%5B%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20mod%20in%20mods%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(mod%2C%20VictoryPointTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22vp_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22VP%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22vp_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(mod%2C%20TripTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22trip_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22T%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22trip_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font_size%20%3D%20%2216%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(mod%2C%20MoveDeltaTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20d%20%3D%20mod.delta%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20d%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22move_pos_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20f%22%2B%7Bd%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22move_pos_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20d%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22move_neg_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20f%22%7Bd%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22move_neg_text%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%203.%20START%20%2F%20END%20OVERRIDES%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20is_start%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22start_stroke%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20text_content%20%3D%3D%20str(i)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22S%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22start_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20is_end%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22goal_stroke%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20text_content%20%3D%3D%20str(i)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22G%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22goal_text%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Crect%20x%3D%22%7Bcx%20-%20rw%20%2F%202%3A.1f%7D%22%20y%3D%22%7Bcy%20-%20rh%20%2F%202%3A.1f%7D%22%20width%3D%22%7Brw%7D%22%20height%3D%22%7Brh%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'fill%3D%22%7Bfill_color%7D%22%20stroke%3D%22%7Bstroke_color%7D%22%20stroke-width%3D%22%7Bstroke_width%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'transform%3D%22%7Btransform%7D%22%20rx%3D%224%22%20%2F%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcx%3A.1f%7D%22%20y%3D%22%7Bcy%3A.1f%7D%22%20dy%3D%224%22%20font-family%3D%22sans-serif%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'font-size%3D%22%7Bfont_size%7D%22%20font-weight%3D%22%7Bfont_weight%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'text-anchor%3D%22middle%22%20fill%3D%22%7Btext_fill%7D%22%20transform%3D%22%7Btransform%7D%22%3E%7Btext_content%7D%3C%2Ftext%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Racers%0A%20%20%20%20%20%20%20%20occupancy%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20for%20idx%2C%20pos%20in%20enumerate(turn_data.positions)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20draw_pos%20%3D%20min(pos%2C%20len(positions_map)%20-%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20name%20%3D%20turn_data.names%5Bidx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20palette%20%3D%20get_racer_palette(name)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mods%20%3D%20turn_data.modifiers%0A%20%20%20%20%20%20%20%20%20%20%20%20abils%20%3D%20turn_data.abilities%0A%20%20%20%20%20%20%20%20%20%20%20%20mod_str%20%3D%20str(mods%5Bidx%5D)%20if%20idx%20%3C%20len(mods)%20else%20%22%5B%5D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20abil_str%20%3D%20str(abils%5Bidx%5D)%20if%20idx%20%3C%20len(abils)%20else%20%22%5B%5D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip_text%20%3D%20f%22%7Bname%7D%20(ID%3A%20%7Bidx%7D)%5CnVP%3A%20%7Bturn_data.vp%5Bidx%5D%7D%5CnTripped%3A%20%7Bturn_data.tripped%5Bidx%5D%7D%5CnAbils%3A%20%7Babil_str%7D%5CnMods%3A%20%7Bmod_str%7D%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20occupancy.setdefault(draw_pos%2C%20%5B%5D).append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22palette%22%3A%20palette%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22is_current%22%3A%20(idx%20%3D%3D%20turn_data.current_racer)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tripped%22%3A%20turn_data.tripped%5Bidx%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tooltip%22%3A%20tooltip_text%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Render%20Racers%0A%20%20%20%20%20%20%20%20for%20space_idx%2C%20racers_here%20in%20occupancy.items()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20bx%2C%20by%2C%20brot%20%3D%20positions_map%5Bspace_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20count%20%3D%20len(racers_here)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20count%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(0%2C%200)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20count%20%3D%3D%202%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%200)%2C%20(15%2C%200)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20count%20%3D%3D%203%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%20-8)%2C%20(15%2C%20-8)%2C%20(0%2C%208)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%20-8)%2C%20(15%2C%20-8)%2C%20(-15%2C%208)%2C%20(15%2C%208)%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20racer%20in%20enumerate(racers_here)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20i%20%3E%3D%20len(offsets)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ox%2C%20oy%20%3D%20offsets%5Bi%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rad%20%3D%20math.radians(brot)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cx%20%3D%20bx%20%2B%20(ox%20*%20math.cos(rad)%20-%20oy%20*%20math.sin(rad))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cy%20%3D%20by%20%2B%20(ox%20*%20math.sin(rad)%20%2B%20oy%20*%20math.cos(rad))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_dx%20%3D%20cx%20-%20bx%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_dy%20%3D%20cy%20-%20by%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22middle%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%2024%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ty%20%3D%20cy%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20count%20%3E%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20abs(vis_dy)%20%3E%20abs(vis_dx)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20vis_dy%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%20-14%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%2024%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%205%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20vis_dx%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22end%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%20-%2014%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22start%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%20%2B%2014%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pal%20%3D%20racer%5B%22palette%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke%20%3D%20pal.outline%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(f%22%3Cg%3E%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(f%22%3Ctitle%3E%7B_html.escape(racer%5B'tooltip'%5D)%7D%3C%2Ftitle%3E%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ccircle%20cx%3D%22%7Bcx%7D%22%20cy%3D%22%7Bcy%7D%22%20r%3D%22%7BMAIN_RADIUS%7D%22%20fill%3D%22%7Bpal.primary%7D%22%20stroke%3D%22%7Bstroke%7D%22%20stroke-width%3D%22%7BOUTLINE_WIDTH%7D%22%20%2F%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20pal.secondary%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ccircle%20cx%3D%22%7Bcx%7D%22%20cy%3D%22%7Bcy%7D%22%20r%3D%22%7BSECONDARY_RADIUS%7D%22%20fill%3D%22none%22%20stroke%3D%22%7Bpal.secondary%7D%22%20stroke-width%3D%22%7BSECONDARY_WIDTH%7D%22%20%2F%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Btx%7D%22%20y%3D%22%7Bty%7D%22%20dy%3D%22%7Bdy_text%7D%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'font-weight%3D%22900%22%20text-anchor%3D%22%7Btext_anchor%7D%22%20fill%3D%22%7Bpal.primary%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'style%3D%22paint-order%3A%20stroke%3B%20stroke%3A%20%23000%3B%20stroke-width%3A%20%7BTEXT_STROKE_WIDTH%7D%3B%22%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7B_html.escape(racer%5B'name'%5D)%7D%3C%2Ftext%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20racer%5B%22tripped%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcx%7D%22%20y%3D%22%7Bcy%7D%22%20dy%3D%225%22%20fill%3D%22%23ff0000%22%20font-weight%3D%22bold%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%3EX%3C%2Ftext%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(f%22%3C%2Fg%3E%22)%0A%0A%20%20%20%20%20%20%20%20svg_elements.append(%22%3C%2Fg%3E%22)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Center%20Display%20(No%20Box)%0A%20%20%20%20%20%20%20%20center_x%20%3D%20(100%20%2B%20500)%20%2F%202%20*%20scale_factor%20%2B%20trans_x%0A%20%20%20%20%20%20%20%20center_y%20%3D%20(350%20-%20100)%20*%20scale_factor%20%2B%20trans_y%0A%0A%20%20%20%20%20%20%20%20active_idx%20%3D%20turn_data.current_racer%0A%20%20%20%20%20%20%20%20active_name%20%3D%20turn_data.names%5Bactive_idx%5D%0A%20%20%20%20%20%20%20%20active_pal%20%3D%20get_racer_palette(active_name)%0A%20%20%20%20%20%20%20%20roll%3A%20int%20%7C%20None%20%3D%20turn_data.last_roll%0A%0A%20%20%20%20%20%20%20%20%23%20Active%20Racer%20Name%20(Floating)%0A%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20-%2015%7D%22%20font-size%3D%2228%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%7Bactive_pal.primary%7D%22%20style%3D%22paint-order%3A%20stroke%3B%20stroke%3A%20%7Bactive_pal.outline%7D%3B%20stroke-width%3A%202px%3B%20filter%3A%20drop-shadow(0px%200px%202px%20black)%3B%22%3E%7B_html.escape(active_name)%7D%3C%2Ftext%3E'%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20roll%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20%2B%2035%7D%22%20font-size%3D%2240%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%23eee%22%20%3E%F0%9F%8E%B2%20%7Broll%7D%3C%2Ftext%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20elif%20turn_data.turn_index%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20%2B%2035%7D%22%20font-size%3D%2260%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ff0000%22%20%3EX%3C%2Ftext%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20f%22%22%22%3Csvg%20width%3D%22%7BW%7D%22%20height%3D%22%7BH%7D%22%20style%3D%22background%3A%7BBOARD_THEME%5B%22background%22%5D%7D%3B%22%3E%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Btrack_group_start%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%22%22.join(svg_elements)%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fsvg%3E%22%22%22%0A%20%20%20%20return%20(render_game_track%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20---%20PERSISTENCE%20STATE%20---%0A%20%20%20%20%23%20We%20only%20use%20this%20to%20remember%20values%20when%20the%20UI%20refreshes%20(Add%2FRemove).%0A%20%20%20%20get_selected_racers%2C%20set_selected_racers%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20%5B%22Banana%22%2C%20%22Centaur%22%2C%20%22Magician%22%2C%20%22Scoocher%22%5D%2C%20allow_self_loops%3DTrue%0A%20%20%20%20)%0A%20%20%20%20get_racer_to_add%2C%20set_racer_to_add%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20get_saved_positions%2C%20set_saved_positions%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20%7B%22Banana%22%3A%200%2C%20%22Centaur%22%3A%200%2C%20%22Magician%22%3A%200%2C%20%22Scoocher%22%3A%200%7D%2C%0A%20%20%20%20%20%20%20%20allow_self_loops%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20get_use_scripted_dice%2C%20set_use_scripted_dice%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20False%2C%20allow_self_loops%3DFalse%0A%20%20%20%20)%0A%20%20%20%20get_dice_rolls_text%2C%20set_dice_rolls_text%20%3D%20mo.state(%22%22%2C%20allow_self_loops%3DFalse)%0A%0A%20%20%20%20get_debug_mode%2C%20set_debug_mode%20%3D%20mo.state(False%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20%23%20---%20NEW%20STATES%20FOR%20CONFIG%20LOADING%20---%0A%20%20%20%20get_seed%2C%20set_seed%20%3D%20mo.state(42%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20get_board%2C%20set_board%20%3D%20mo.state(%22standard%22%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20%23%20Track%20the%20last%20seen%20selection%20for%20EACH%20table%20to%20prevent%20fighting%2Floops%0A%20%20%20%20get_last_race_hash%2C%20set_last_race_hash%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20get_last_result_hash%2C%20set_last_result_hash%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20get_board%2C%0A%20%20%20%20%20%20%20%20get_debug_mode%2C%0A%20%20%20%20%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20%20%20%20%20get_last_race_hash%2C%0A%20%20%20%20%20%20%20%20get_last_result_hash%2C%0A%20%20%20%20%20%20%20%20get_racer_to_add%2C%0A%20%20%20%20%20%20%20%20get_saved_positions%2C%0A%20%20%20%20%20%20%20%20get_seed%2C%0A%20%20%20%20%20%20%20%20get_selected_racers%2C%0A%20%20%20%20%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20%20%20%20%20set_board%2C%0A%20%20%20%20%20%20%20%20set_debug_mode%2C%0A%20%20%20%20%20%20%20%20set_dice_rolls_text%2C%0A%20%20%20%20%20%20%20%20set_last_race_hash%2C%0A%20%20%20%20%20%20%20%20set_last_result_hash%2C%0A%20%20%20%20%20%20%20%20set_racer_to_add%2C%0A%20%20%20%20%20%20%20%20set_saved_positions%2C%0A%20%20%20%20%20%20%20%20set_seed%2C%0A%20%20%20%20%20%20%20%20set_selected_racers%2C%0A%20%20%20%20%20%20%20%20set_use_scripted_dice%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20RacerName%2C%0A%20%20%20%20get_args%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20get_debug_mode%2C%0A%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20get_racer_to_add%2C%0A%20%20%20%20get_saved_positions%2C%0A%20%20%20%20get_seed%2C%0A%20%20%20%20get_selected_racers%2C%0A%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20set_board%2C%0A%20%20%20%20set_debug_mode%2C%0A%20%20%20%20set_dice_rolls_text%2C%0A%20%20%20%20set_racer_to_add%2C%0A%20%20%20%20set_saved_positions%2C%0A%20%20%20%20set_seed%2C%0A%20%20%20%20set_selected_racers%2C%0A%20%20%20%20set_step_idx%2C%0A%20%20%20%20set_use_scripted_dice%2C%0A)%3A%0A%20%20%20%20%23%20---%20UI%20DEFINITION%20---%0A%20%20%20%20AVAILABLE_RACERS%20%3D%20sorted(list(get_args(RacerName)))%0A%20%20%20%20current_roster%20%3D%20get_selected_racers()%0A%20%20%20%20saved_positions%20%3D%20get_saved_positions()%0A%0A%20%20%20%20%23%201.%20Main%20Controls%0A%20%20%20%20reset_button%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%9F%B3Reset%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(0)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20manual_change(setter%2C%20value)%3A%0A%20%20%20%20%20%20%20%20setter(value)%0A%20%20%20%20%20%20%20%20set_step_idx(0)%0A%20%20%20%20%20%20%20%20return%20value%0A%0A%20%20%20%20scenario_seed%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D10000%2C%0A%20%20%20%20%20%20%20%20value%3Dget_seed()%2C%0A%20%20%20%20%20%20%20%20label%3D%22Random%20Seed%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20manual_change(set_seed%2C%20v)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20board_selector%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Dsorted(list(BOARD_DEFINITIONS.keys()))%2C%0A%20%20%20%20%20%20%20%20value%3Dget_board()%2C%0A%20%20%20%20%20%20%20%20label%3D%22Board%20Map%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20manual_change(set_board%2C%20v)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20use_scripted_dice_ui%20%3D%20mo.ui.switch(%0A%20%20%20%20%20%20%20%20value%3Dget_use_scripted_dice()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20(set_use_scripted_dice(v)%2C%20set_step_idx(0))%5B1%5D%2C%0A%20%20%20%20%20%20%20%20label%3D%22Use%20scripted%20dice%22%2C%0A%20%20%20%20)%0A%20%20%20%20dice_rolls_text_ui%20%3D%20mo.ui.text(%0A%20%20%20%20%20%20%20%20value%3Dget_dice_rolls_text()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20(set_dice_rolls_text(v)%2C%20set_step_idx(0))%5B1%5D%2C%0A%20%20%20%20%20%20%20%20label%3D%22Dice%20rolls%22%2C%0A%20%20%20%20%20%20%20%20placeholder%3D%22e.g.%204%2C5%2C6%22%2C%0A%20%20%20%20)%0A%20%20%20%20debug_mode_ui%20%3D%20mo.ui.switch(%0A%20%20%20%20%20%20%20%20value%3Dget_debug_mode()%2C%20on_change%3Dset_debug_mode%2C%20label%3D%22Debug%20logging%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20NEW%3A%20Share%20%26%20Load%20Logic%20---%0A%20%20%20%20encoded_config_input%20%3D%20mo.ui.text(%0A%20%20%20%20%20%20%20%20label%3D%22Paste%20Encoded%20Config%22%2C%20placeholder%3D%22eyJ...%22%2C%20full_width%3DTrue%0A%20%20%20%20)%0A%0A%20%20%20%20def%20_on_load_click(_)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Parse%20encoded%20string%20using%20the%20existing%20class%20and%20update%20UI%20state.%22%22%22%0A%20%20%20%20%20%20%20%20val%20%3D%20encoded_config_input.value%0A%20%20%20%20%20%20%20%20if%20not%20val%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%0A%20%20%20%20%20%20%20%20from%20magical_athlete_simulator.simulation.hashing%20import%20GameConfiguration%0A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Decode%20using%20your%20existing%20Single%20Source%20of%20Truth%0A%20%20%20%20%20%20%20%20%20%20%20%20config%20%3D%20GameConfiguration.from_encoded(val)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Update%20the%20Shared%20State%20directly%0A%20%20%20%20%20%20%20%20%20%20%20%20set_seed(config.seed)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_board(config.board)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(list(config.racers))%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(%7Bn%3A%200%20for%20n%20in%20config.racers%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_use_scripted_dice(False)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%20%20%23%20Reset%20simulation%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20load_encoded_btn%20%3D%20mo.ui.button(label%3D%22Load%20Configuration%22%2C%20on_click%3D_on_load_click)%0A%0A%20%20%20%20%23%202.%20Position%20Inputs%20%26%20Logic%0A%20%20%20%20def%20_make_pos_on_change(racer_name)%3A%0A%20%20%20%20%20%20%20%20def%20_on_change(new_val)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%3D%20int(new_val)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(lambda%20cur%3A%20%7B**cur%2C%20racer_name%3A%20v%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%20%20%20%20return%20_on_change%0A%0A%20%20%20%20pos_widget_map%20%3D%20%7B%0A%20%20%20%20%20%20%20%20ui_racer%3A%20mo.ui.number(%0A%20%20%20%20%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stop%3D29%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20value%3Dint(saved_positions.get(ui_racer%2C%200))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_change%3D_make_pos_on_change(ui_racer)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20for%20ui_racer%20in%20current_roster%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%203.%20Snapshot%20Logic%0A%20%20%20%20def%20_snapshot_values(exclude%3DNone)%3A%0A%20%20%20%20%20%20%20%20return%20%7Br%3A%20w.value%20for%20r%2C%20w%20in%20pos_widget_map.items()%20if%20r%20!%3D%20exclude%7D%0A%0A%20%20%20%20%23%20---%20REORDERING%20LOGIC%20---%0A%20%20%20%20def%20move_racer(index%2C%20direction)%3A%0A%20%20%20%20%20%20%20%20def%20_move(_)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20roster%20%3D%20list(get_selected_racers())%0A%20%20%20%20%20%20%20%20%20%20%20%20new_index%20%3D%20index%20%2B%20direction%0A%20%20%20%20%20%20%20%20%20%20%20%20if%200%20%3C%3D%20new_index%20%3C%20len(roster)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20roster%5Bindex%5D%2C%20roster%5Bnew_index%5D%20%3D%20roster%5Bnew_index%5D%2C%20roster%5Bindex%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(roster)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%20%20%20%20return%20_move%0A%0A%20%20%20%20%23%204.%20Action%20Buttons%0A%20%20%20%20action_buttons%20%3D%20%7B%7D%0A%20%20%20%20for%20i%2C%20ui_racer%20in%20enumerate(current_roster)%3A%0A%20%20%20%20%20%20%20%20btn_remove%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%E2%9C%96%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%2C%20r%3Dui_racer%3A%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(_snapshot_values(exclude%3Dr))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(lambda%20cur%3A%20%5Bx%20for%20x%20in%20cur%20if%20x%20!%3D%20r%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20disabled%3D(len(current_roster)%20%3C%3D%201)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20btn_up%20%3D%20mo.ui.button(label%3D%22%E2%86%91%22%2C%20on_click%3Dmove_racer(i%2C%20-1)%2C%20disabled%3D(i%20%3D%3D%200))%0A%20%20%20%20%20%20%20%20btn_down%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%E2%86%93%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_click%3Dmove_racer(i%2C%201)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20disabled%3D(i%20%3D%3D%20len(current_roster)%20-%201)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20action_buttons%5Bui_racer%5D%20%3D%20(btn_remove%2C%20btn_up%2C%20btn_down)%0A%0A%20%20%20%20%23%205.%20Add%20Racer%20Logic%0A%20%20%20%20available_options%20%3D%20%5Br%20for%20r%20in%20AVAILABLE_RACERS%20if%20r%20not%20in%20current_roster%5D%0A%20%20%20%20add_racer_dropdown%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Davailable_options%2C%0A%20%20%20%20%20%20%20%20value%3Dget_racer_to_add()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dset_racer_to_add%2C%0A%20%20%20%20%20%20%20%20label%3D%22Add%20racer%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20_add_racer(v)%3A%0A%20%20%20%20%20%20%20%20r%20%3D%20get_racer_to_add()%0A%20%20%20%20%20%20%20%20if%20r%20and%20r%20not%20in%20get_selected_racers()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_pos%20%3D%20_snapshot_values()%0A%20%20%20%20%20%20%20%20%20%20%20%20new_pos%5Br%5D%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(new_pos)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(lambda%20cur%3A%20cur%20%2B%20%5Br%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_racer_to_add(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%20%20%20%20%20%20%20%20return%20v%0A%0A%20%20%20%20add_button%20%3D%20mo.ui.button(label%3D%22Add%22%2C%20on_click%3D_add_racer)%0A%0A%20%20%20%20%23%206.%20Layout%20Table%0A%20%20%20%20table_rows%20%3D%20%5B%5D%0A%20%20%20%20for%20i%2C%20ui_racer%20in%20enumerate(current_roster)%3A%0A%20%20%20%20%20%20%20%20w_pos%20%3D%20pos_widget_map%5Bui_racer%5D%0A%20%20%20%20%20%20%20%20b_rem%2C%20b_up%2C%20b_down%20%3D%20action_buttons%5Bui_racer%5D%0A%20%20%20%20%20%20%20%20move_grp%20%3D%20mo.hstack(%5Bb_up%2C%20b_down%5D%2C%20justify%3D%22center%22%2C%20gap%3D0)%0A%20%20%20%20%20%20%20%20table_rows.append(f%22%7C%20%7Bi%20%2B%201%7D.%20%7Bui_racer%7D%20%7C%20%7Bw_pos%7D%20%7C%20%7Bmove_grp%7D%20%7C%20%7Bb_rem%7D%20%7C%22)%0A%0A%20%20%20%20racer_table%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%7C%20Racer%20%7C%20Start%20Pos%20%7C%20Order%20%7C%20Remove%20%7C%5Cn%22%0A%20%20%20%20%20%20%20%20%22%7C%20%3A---%20%7C%20%3A---%20%7C%20%3A---%3A%20%7C%20%3A---%3A%20%7C%5Cn%22%20%2B%20%22%5Cn%22.join(table_rows)%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20add_button%2C%0A%20%20%20%20%20%20%20%20add_racer_dropdown%2C%0A%20%20%20%20%20%20%20%20board_selector%2C%0A%20%20%20%20%20%20%20%20current_roster%2C%0A%20%20%20%20%20%20%20%20debug_mode_ui%2C%0A%20%20%20%20%20%20%20%20dice_rolls_text_ui%2C%0A%20%20%20%20%20%20%20%20encoded_config_input%2C%0A%20%20%20%20%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20%20%20%20%20racer_table%2C%0A%20%20%20%20%20%20%20%20reset_button%2C%0A%20%20%20%20%20%20%20%20scenario_seed%2C%0A%20%20%20%20%20%20%20%20use_scripted_dice_ui%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(board_selector%2C%20current_roster%2C%20mo%2C%20scenario_seed)%3A%0A%20%20%20%20from%20magical_athlete_simulator.simulation.hashing%20import%20GameConfiguration%0A%0A%20%20%20%20%23%20Generate%20string%20from%20current%20state%0A%20%20%20%20current_config_obj%20%3D%20GameConfiguration(%0A%20%20%20%20%20%20%20%20racers%3Dtuple(current_roster)%2C%0A%20%20%20%20%20%20%20%20board%3Dboard_selector.value%2C%0A%20%20%20%20%20%20%20%20seed%3Dscenario_seed.value%2C%0A%20%20%20%20)%0A%0A%20%20%20%20share_widget%20%3D%20mo.ui.text_area(%0A%20%20%20%20%20%20%20%20value%3Dcurrent_config_obj.encoded%2C%0A%20%20%20%20%20%20%20%20disabled%3DTrue%2C%20%20%23%20Read-only%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20%20%20%20%20rows%3D5%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(share_widget%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20add_button%2C%0A%20%20%20%20add_racer_dropdown%2C%0A%20%20%20%20board_selector%2C%0A%20%20%20%20debug_mode_ui%2C%0A%20%20%20%20dice_input%2C%0A%20%20%20%20encoded_config_input%2C%0A%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20racer_table%2C%0A%20%20%20%20reset_button%2C%0A%20%20%20%20results_tabs%2C%0A%20%20%20%20scenario_seed%2C%0A%20%20%20%20share_widget%2C%0A%20%20%20%20use_scripted_dice_ui%2C%0A)%3A%0A%20%20%20%20%23%20---%20CONFIG%20DISPLAY%20---%0A%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%20Configure%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bscenario_seed%2C%20board_selector%2C%20reset_button%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D2%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Buse_scripted_dice_ui%2C%20dice_input%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bdebug_mode_ui%5D%2C%20justify%3D%22start%22%2C%20gap%3D2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Racers%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20racer_table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Badd_racer_dropdown%2C%20add_button%5D%2C%20justify%3D%22start%22%2C%20gap%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20).style(%7B%22overflow-x%22%3A%20%22auto%22%2C%20%22max-width%22%3A%20%22100%25%22%7D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20results_tabs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22Enter%20encoded%20config%3A%20%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20encoded_config_input%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22Copy%20encoded%20config%3A%20%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20share_widget%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20).style(%7B%22overflow-x%22%3A%20%22auto%22%2C%20%22max-width%22%3A%20%22100%25%22%7D)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20df_races_clean%2C%0A%20%20%20%20get_last_race_hash%2C%0A%20%20%20%20get_last_result_hash%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20racer_results_table%2C%0A%20%20%20%20races_table%2C%0A%20%20%20%20set_board%2C%0A%20%20%20%20set_last_race_hash%2C%0A%20%20%20%20set_last_result_hash%2C%0A%20%20%20%20set_saved_positions%2C%0A%20%20%20%20set_seed%2C%0A%20%20%20%20set_selected_racers%2C%0A%20%20%20%20set_step_idx%2C%0A%20%20%20%20set_use_scripted_dice%2C%0A)%3A%0A%20%20%20%20%23%20---%20CONFIGURATION%20LOADER%20(Stable%20Version)%20---%0A%0A%20%20%20%20%23%201.%20Capture%20Current%20Table%20Selections%0A%20%20%20%20curr_race_hash%20%3D%20None%0A%20%20%20%20curr_race_row%20%3D%20None%0A%20%20%20%20if%20races_table.value%20is%20not%20None%20and%20races_table.value.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20curr_race_hash%20%3D%20races_table.value.item(0%2C%20%22config_hash%22)%0A%20%20%20%20%20%20%20%20curr_race_row%20%3D%20races_table.value.row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20curr_res_hash%20%3D%20None%0A%20%20%20%20if%20racer_results_table.value%20is%20not%20None%20and%20racer_results_table.value.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20curr_res_hash%20%3D%20racer_results_table.value.item(0%2C%20%22config_hash%22)%0A%0A%20%20%20%20%23%202.%20Get%20Last%20Known%20States%0A%20%20%20%20last_race%20%3D%20get_last_race_hash()%0A%20%20%20%20last_res%20%3D%20get_last_result_hash()%0A%0A%20%20%20%20%23%203.%20Detect%20Changes%20(Delta%20Check)%0A%20%20%20%20%23%20We%20only%20react%20if%20the%20current%20selection%20differs%20from%20the%20last%20recorded%20selection%20for%20that%20specific%20table.%0A%20%20%20%20race_changed%20%3D%20curr_race_hash%20is%20not%20None%20and%20curr_race_hash%20!%3D%20last_race%0A%20%20%20%20res_changed%20%3D%20curr_res_hash%20is%20not%20None%20and%20curr_res_hash%20!%3D%20last_res%0A%0A%20%20%20%20target_config%20%3D%20None%0A%0A%20%20%20%20%23%20Priority%3A%20Races%20Table%20%3E%20Results%20Table%0A%20%20%20%20%23%20But%20only%20if%20it%20actually%20changed!%0A%20%20%20%20if%20race_changed%3A%0A%20%20%20%20%20%20%20%20target_config%20%3D%20curr_race_row%0A%20%20%20%20elif%20res_changed%3A%0A%20%20%20%20%20%20%20%20%23%20Use%20the%20CLEANED%20races%20frame%20so%20racer_names%20is%20already%20a%20list%0A%20%20%20%20%20%20%20%20filtered%20%3D%20df_races_clean.filter(pl.col(%22config_hash%22)%20%3D%3D%20curr_res_hash)%0A%20%20%20%20%20%20%20%20if%20filtered.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20target_config%20%3D%20filtered.row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20%23%204.%20Apply%20Configuration%20(if%20any%20change%20detected)%0A%20%20%20%20if%20target_config%3A%0A%20%20%20%20%20%20%20%20raw_names%20%3D%20target_config.get(%22racer_names%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Now%20always%20expect%20a%20list%20from%20both%20paths%0A%20%20%20%20%20%20%20%20if%20isinstance(raw_names%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_roster%20%3D%20%5Bstr(n)%20for%20n%20in%20raw_names%5D%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_roster%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20new_seed%20%3D%20int(target_config.get(%22seed%22%2C%2042))%0A%20%20%20%20%20%20%20%20new_board%20%3D%20target_config.get(%22board%22%2C%20%22standard%22)%0A%0A%20%20%20%20%20%20%20%20set_seed(new_seed)%0A%20%20%20%20%20%20%20%20set_board(new_board)%0A%20%20%20%20%20%20%20%20set_selected_racers(new_roster)%0A%20%20%20%20%20%20%20%20set_saved_positions(%7Bn%3A%200%20for%20n%20in%20new_roster%7D)%0A%20%20%20%20%20%20%20%20set_use_scripted_dice(False)%0A%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%23%205.%20SYNC%20STATE%20(CRITICAL)%0A%20%20%20%20%23%20Always%20update%20the%20%22last%20seen%22%20hashes%20to%20match%20the%20current%20table%20values.%0A%20%20%20%20%23%20This%20prevents%20the%20%22other%22%20table%20from%20triggering%20a%20change%20in%20the%20next%20cycle%0A%20%20%20%20%23%20just%20because%20we%20ignored%20it%20this%20time.%0A%20%20%20%20if%20curr_race_hash%20!%3D%20last_race%3A%0A%20%20%20%20%20%20%20%20set_last_race_hash(curr_race_hash)%0A%0A%20%20%20%20if%20curr_res_hash%20!%3D%20last_res%3A%0A%20%20%20%20%20%20%20%20set_last_result_hash(curr_res_hash)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(dice_rolls_text_ui%2C%20mo%2C%20use_scripted_dice_ui)%3A%0A%20%20%20%20dice_input%20%3D%20dice_rolls_text_ui%20if%20use_scripted_dice_ui.value%20else%20mo.Html(%22%22)%0A%20%20%20%20return%20(dice_input%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20MAGICAL_ATHLETE_SIMULATOR_VERSION%2C%0A%20%20%20%20load_status%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20racer_results_table%2C%0A%20%20%20%20races_table%2C%0A%20%20%20%20reload_data_btn%2C%0A%20%20%20%20results_folder_browser%2C%0A)%3A%0A%20%20%20%20def%20_header()%3A%0A%20%20%20%20%20%20%20%20return%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bmo.md(f%22**v%7BMAGICAL_ATHLETE_SIMULATOR_VERSION%7D**%22)%2C%20reload_data_btn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22end%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20results_tabs%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Racer%20Results%22%3A%20mo.vstack(%5B_header()%2C%20racer_results_table%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Races%22%3A%20mo.vstack(%5B_header()%2C%20races_table%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Source%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Data%20Directory%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Select%20the%20folder%20containing%20%60races.parquet%60%20and%20%60racer_results.parquet%60.%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bresults_folder_browser%2C%20reload_data_btn%5D%2C%20align%3D%22center%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.callout(mo.md(f%22Current%20Status%3A%20%7Bload_status%7D%22)%2C%20kind%3D%22neutral%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20).style(%7B%22width%22%3A%20%22100%25%22%2C%20%22min-height%22%3A%20%22400px%22%7D)%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20)%0A%20%20%20%20return%20(results_tabs%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20Console%2C%0A%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20GameScenario%2C%0A%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20RacerConfig%2C%0A%20%20%20%20RichHandler%2C%0A%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20StepSnapshot%2C%0A%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20current_roster%2C%0A%20%20%20%20dataclasses%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20get_debug_mode%2C%0A%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20get_saved_positions%2C%0A%20%20%20%20get_seed%2C%0A%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20logging%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20re%2C%0A%20%20%20%20reset_button%2C%0A)%3A%0A%20%20%20%20from%20magical_athlete_simulator.simulation.telemetry%20import%20(%0A%20%20%20%20%20%20%20%20SnapshotPolicy%2C%0A%20%20%20%20%20%20%20%20SnapshotRecorder%2C%0A%20%20%20%20%20%20%20%20MetricsAggregator%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magical_athlete_simulator.core.events%20import%20AbilityTriggeredEvent%0A%0A%20%20%20%20%23%20Reactivity%20triggers%0A%20%20%20%20reset_button.value%0A%20%20%20%20%23%20Use%20state%20getters%0A%20%20%20%20current_seed_val%20%3D%20get_seed()%0A%20%20%20%20current_board_val%20%3D%20get_board()%0A%0A%20%20%20%20get_saved_positions()%0A%20%20%20%20get_use_scripted_dice()%0A%20%20%20%20get_dice_rolls_text()%0A%0A%20%20%20%20log_console%20%3D%20Console(%0A%20%20%20%20%20%20%20%20record%3DTrue%2C%20width%3D120%2C%20force_terminal%3DTrue%2C%20color_system%3D%22truecolor%22%0A%20%20%20%20)%0A%20%20%20%20root_logger%20%3D%20logging.getLogger()%0A%20%20%20%20for%20h%20in%20root_logger.handlers%5B%3A%5D%3A%0A%20%20%20%20%20%20%20%20root_logger.removeHandler(h)%0A%0A%20%20%20%20log_handler%20%3D%20RichHandler(%0A%20%20%20%20%20%20%20%20console%3Dlog_console%2C%0A%20%20%20%20%20%20%20%20markup%3DTrue%2C%0A%20%20%20%20%20%20%20%20show_path%3DFalse%2C%0A%20%20%20%20%20%20%20%20show_time%3DFalse%2C%0A%20%20%20%20%20%20%20%20highlighter%3DGameLogHighlighter()%2C%0A%20%20%20%20)%0A%20%20%20%20log_handler.setFormatter(RichMarkupFormatter())%0A%20%20%20%20root_logger.addHandler(log_handler)%0A%20%20%20%20log_level%20%3D%20logging.DEBUG%20if%20get_debug_mode()%20else%20logging.INFO%0A%20%20%20%20root_logger.setLevel(log_level)%0A%0A%20%20%20%20dice_rolls%20%3D%20None%0A%20%20%20%20if%20get_use_scripted_dice()%3A%0A%20%20%20%20%20%20%20%20raw%20%3D%20get_dice_rolls_text().strip()%0A%20%20%20%20%20%20%20%20if%20raw%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dice_rolls%20%3D%20%5Bint(t)%20for%20t%20in%20re.split(r%22%5B%2C%5Cs%5D%2B%22%2C%20raw)%20if%20t%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20%23%20Updated%3A%20Use%20dynamic%20board%20and%20seed%0A%20%20%20%20scenario%20%3D%20GameScenario(%0A%20%20%20%20%20%20%20%20racers_config%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20RacerConfig(i%2C%20n%2C%20start_pos%3Dint(get_saved_positions().get(n%2C%200)))%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20n%20in%20enumerate(current_roster)%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20dice_rolls%3Ddice_rolls%2C%0A%20%20%20%20%20%20%20%20seed%3DNone%20if%20dice_rolls%20else%20current_seed_val%2C%0A%20%20%20%20%20%20%20%20board%3DBOARD_DEFINITIONS.get(current_board_val%2C%20BOARD_DEFINITIONS%5B%22standard%22%5D)()%2C%0A%20%20%20%20)%0A%0A%20%20%20%20step_history%20%3D%20%5B%5D%0A%20%20%20%20turn_map%20%3D%20%7B%7D%0A%20%20%20%20SNAPSHOT_EVENTS%20%3D%20(MoveCmdEvent%2C%20WarpCmdEvent%2C%20TripCmdEvent)%0A%0A%20%20%20%20class%20RichLogSource%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20console)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self._console%20%3D%20console%0A%0A%20%20%20%20%20%20%20%20def%20export_text(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self._console.export_text(clear%3DFalse)%0A%0A%20%20%20%20%20%20%20%20def%20export_html(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self._console.export_html(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20clear%3DFalse%2C%20inline_styles%3DTrue%2C%20code_format%3D%22%7Bcode%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20policy%20%3D%20SnapshotPolicy(%0A%20%20%20%20%20%20%20%20snapshot_event_types%3DSNAPSHOT_EVENTS%2C%0A%20%20%20%20%20%20%20%20ensure_snapshot_each_turn%3DTrue%2C%0A%20%20%20%20%20%20%20%20fallback_event_name%3D%22TurnSkipped%2FRecovery%22%2C%0A%20%20%20%20%20%20%20%20snapshot_on_turn_end%3DFalse%2C%0A%20%20%20%20)%0A%0A%20%20%20%20snapshot_recorder%20%3D%20SnapshotRecorder(%0A%20%20%20%20%20%20%20%20policy%3Dpolicy%2C%0A%20%20%20%20%20%20%20%20log_source%3DRichLogSource(log_console)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20CHANGED%20BLOCK%20START%20---%0A%20%20%20%20metrics_aggregator%20%3D%20MetricsAggregator(config_hash%3D%22interactive-session%22)%0A%20%20%20%20metrics_aggregator.initialize_racers(scenario.engine)%0A%0A%20%20%20%20%23%20FIX%201%3A%20Start%20the%20counter%20at%201.%0A%20%20%20%20%23%20Turn%200%20is%20reserved%20for%20%22Board%20Setup%22.%20Turn%201%20is%20the%20first%20actual%20move.%0A%20%20%20%20sim_turn_counter%20%3D%20%7B%22current%22%3A%201%7D%0A%0A%20%20%20%20def%20on_event(engine%2C%20event)%3A%0A%20%20%20%20%20%20%20%20t_idx%20%3D%20sim_turn_counter%5B%22current%22%5D%0A%20%20%20%20%20%20%20%20snapshot_recorder.on_event(engine%2C%20event%2C%20turn_index%3Dt_idx)%0A%20%20%20%20%20%20%20%20metrics_aggregator.on_event(event)%0A%0A%20%20%20%20if%20hasattr(scenario.engine%2C%20%22on_event_processed%22)%3A%0A%20%20%20%20%20%20%20%20scenario.engine.on_event_processed%20%3D%20on_event%0A%20%20%20%20%23%20---%20CHANGED%20BLOCK%20END%20---%0A%0A%20%20%20%20engine%20%3D%20scenario.engine%0A%0A%20%20%20%20%23%20FIX%202%3A%20Capture%20Initial%20State%20as%20Turn%200%0A%20%20%20%20snapshot_recorder.capture(engine%2C%20%22InitialState%22%2C%20turn_index%3D0)%0A%0A%20%20%20%20with%20mo.status.spinner(title%3D%22Simulating...%22)%3A%0A%20%20%20%20%20%20%20%20while%20not%20engine.state.race_over%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20log_console.export_html(clear%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20t_idx%20%3D%20sim_turn_counter%5B%22current%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20actual_racer_idx%20%3D%20engine.state.current_racer_idx%0A%20%20%20%20%20%20%20%20%20%20%20%20pre_turn_serial%20%3D%20engine.state.roll_state.serial_id%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20scenario.run_turn()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20post_turn_serial%20%3D%20engine.state.roll_state.serial_id%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20metrics_aggregator.on_turn_end(engine%2C%20turn_index%3Dt_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20snapshot_recorder.on_turn_end(engine%2C%20turn_index%3Dt_idx)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20last_snap%20%3D%20snapshot_recorder.step_history%5B-1%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fix%201%3A%20Ensure%20snapshot%20points%20to%20the%20actor%0A%20%20%20%20%20%20%20%20%20%20%20%20updates%20%3D%20%7B%22current_racer%22%3A%20actual_racer_idx%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fix%202%3A%20%22Red%20X%22%20logic%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20We%20check%20(t_idx%20%3E%201)%20because%20Turn%201%20is%20the%20first%20roll.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20a%20%22Recovery%22%20happens%20on%20Turn%202%2B%2C%20the%20serial%20won't%20change.%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20t_idx%20%3E%201%20and%20post_turn_serial%20%3D%3D%20pre_turn_serial%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20updates%5B%22last_roll%22%5D%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fixed_snap%20%3D%20dataclasses.replace(last_snap%2C%20**updates)%0A%20%20%20%20%20%20%20%20%20%20%20%20snapshot_recorder.step_history%5B-1%5D%20%3D%20fixed_snap%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20sim_turn_counter%5B%22current%22%5D%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(snapshot_recorder.step_history)%20%3E%201000%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%0A%20%20%20%20step_history%3A%20list%5BStepSnapshot%5D%20%3D%20snapshot_recorder.step_history%0A%20%20%20%20turn_map%20%3D%20snapshot_recorder.turn_map%0A%0A%20%20%20%20info_md%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20f%22%E2%9C%85%20**Simulation%20complete!**%20%7Blen(current_roster)%7D%20racers%2C%20%7Bsim_turn_counter%5B'current'%5D%20-%201%7D%20turns%22%0A%20%20%20%20)%0A%20%20%20%20return%20info_md%2C%20step_history%2C%20turn_map%0A%0A%0A%40app.cell%0Adef%20_(info_md)%3A%0A%20%20%20%20info_md%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20get_step_idx%2C%20set_step_idx%20%3D%20mo.state(0%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20return%20get_step_idx%2C%20set_step_idx%0A%0A%0A%40app.cell%0Adef%20_(get_step_idx%2C%20mo%2C%20set_step_idx%2C%20step_history%2C%20turn_map)%3A%0A%20%20%20%20%23%20---%20NAVIGATION%20LOGIC%20---%0A%20%20%20%20current_step_idx%20%3D%20get_step_idx()%0A%0A%20%20%20%20if%20not%20step_history%3A%0A%20%20%20%20%20%20%20%20current_data%2C%20current_turn_idx%2C%20max_s%20%3D%20None%2C%200%2C%200%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20current_step_idx%20%3D%20min(max(0%2C%20current_step_idx)%2C%20len(step_history)%20-%201)%0A%20%20%20%20%20%20%20%20current_data%20%3D%20step_history%5Bcurrent_step_idx%5D%0A%20%20%20%20%20%20%20%20current_turn_idx%20%3D%20current_data.turn_index%0A%20%20%20%20%20%20%20%20max_s%20%3D%20len(step_history)%20-%201%0A%0A%20%20%20%20next_step_val%20%3D%20min(max_s%2C%20current_step_idx%20%2B%201)%0A%20%20%20%20prev_step_val%20%3D%20max(0%2C%20current_step_idx%20-%201)%0A%0A%20%20%20%20next_turn_target%20%3D%20current_turn_idx%20%2B%201%0A%20%20%20%20prev_turn_target%20%3D%20current_turn_idx%20-%201%0A%0A%20%20%20%20if%20next_turn_target%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20next_turn_step_val%20%3D%20turn_map%5Bnext_turn_target%5D%5B-1%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20next_turn_step_val%20%3D%20current_step_idx%0A%0A%20%20%20%20if%20prev_turn_target%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20prev_turn_step_val%20%3D%20turn_map%5Bprev_turn_target%5D%5B0%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20prev_turn_step_val%20%3D%200%0A%0A%20%20%20%20btn_prev_turn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%97%80%E2%97%80Turn%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(prev_turn_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_turn_idx%20%3C%3D%200)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_next_turn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22Turn%E2%96%B6%E2%96%B6%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(next_turn_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(next_turn_target%20not%20in%20turn_map)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_prev_step%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%97%80%20Step%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(prev_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_step_idx%20%3C%3D%200)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_next_step%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22Step%20%E2%96%B6%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(next_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_step_idx%20%3E%3D%20max_s)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20on_slider_change(v)%3A%0A%20%20%20%20%20%20%20%20if%20v%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(turn_map%5Bv%5D%5B0%5D)%0A%0A%20%20%20%20nav_max_turn%20%3D%20max(turn_map.keys())%20if%20turn_map%20else%200%0A%20%20%20%20turn_slider%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D-1%2C%0A%20%20%20%20%20%20%20%20stop%3Dnav_max_turn%2C%0A%20%20%20%20%20%20%20%20value%3Dcurrent_turn_idx%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Turn%20Timeline%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Don_slider_change%2C%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20btn_next_step%2C%0A%20%20%20%20%20%20%20%20btn_next_turn%2C%0A%20%20%20%20%20%20%20%20btn_prev_step%2C%0A%20%20%20%20%20%20%20%20btn_prev_turn%2C%0A%20%20%20%20%20%20%20%20current_data%2C%0A%20%20%20%20%20%20%20%20current_turn_idx%2C%0A%20%20%20%20%20%20%20%20turn_slider%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20Any%2C%0A%20%20%20%20Literal%2C%0A%20%20%20%20btn_next_step%2C%0A%20%20%20%20btn_next_turn%2C%0A%20%20%20%20btn_prev_step%2C%0A%20%20%20%20btn_prev_turn%2C%0A%20%20%20%20current_data%2C%0A%20%20%20%20current_turn_idx%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20step_history%2C%0A%20%20%20%20turn_slider%2C%0A)%3A%0A%20%20%20%20%23%20---%20NAV%20LAYOUT%20---%0A%20%20%20%20curr_step%3A%20Any%20%7C%20Literal%5B0%5D%20%3D%20current_data.global_step_index%20if%20current_data%20else%200%0A%20%20%20%20tot_steps%20%3D%20len(step_history)%20if%20step_history%20else%200%0A%0A%20%20%20%20status_text%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20f%22**Turn%20%7Bcurrent_turn_idx%7D**%20(Step%20%7Bcurr_step%20%2B%201%7D%2F%7Btot_steps%7D)%22%0A%20%20%20%20)%0A%0A%20%20%20%20nav_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bbtn_prev_turn%2C%20turn_slider%2C%20btn_next_turn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bbtn_prev_step%2C%20status_text%2C%20btn_next_step%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(nav_ui%2C)%0A%0A%0A%40app.cell%0Adef%20_(BG_COLOR%2C%20current_data%2C%20current_turn_idx%2C%20mo%2C%20step_history%2C%20turn_map)%3A%0A%20%20%20%20%23%20---%20LOG%20VIEWER%20---%0A%20%20%20%20if%20not%20current_data%3A%0A%20%20%20%20%20%20%20%20log_ui%20%3D%20mo.md(%22No%20logs%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20container_id%20%3D%20%22log-container-main%22%0A%20%20%20%20%20%20%20%20segments%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20log_max_turn%20%3D%20max(turn_map.keys())%0A%0A%20%20%20%20%20%20%20%20for%20t%20in%20range(log_max_turn%20%2B%201)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20t%20not%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%20%20%20%20%20%20%20%20%20%20%20%20is_active%20%3D%20t%20%3D%3D%20current_turn_idx%0A%20%20%20%20%20%20%20%20%20%20%20%20end_of_turn_idx%20%3D%20turn_map%5Bt%5D%5B-1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20full_turn_log%20%3D%20step_history%5Bend_of_turn_idx%5D.log_html%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20is_active%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bg%2C%20border%2C%20opacity%20%3D%20%22%23000000%22%2C%20%22%2300FF00%22%2C%20%221.0%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lines%20%3D%20full_turn_log.split(%22%5Cn%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_line%20%3D%20current_data.log_line_index%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20safe_idx%20%3D%20min(len(lines)%2C%20target_line%20%2B%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lines.insert(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20safe_idx%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3Ared%3B%20font-size%3A10px%3B%20border-top%3A1px%20dashed%20red%3B%20margin-top%3A2px%3B%20margin-bottom%3A2px%3B%22%3E%E2%96%B2%20CURRENT%20STEP%3C%2Fdiv%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content_html%20%3D%20%22%3Cbr%3E%22.join(lines)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bg%2C%20border%2C%20opacity%20%3D%20BG_COLOR%2C%20%22%23333%22%2C%20%220.5%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content_html%20%3D%20full_turn_log.replace(%22%5Cn%22%2C%20%22%3Cbr%3E%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20segments.append(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22turn-log-%7Bt%7D%22%20style%3D%22padding%3A4px%3B%20border-left%3A4px%20solid%20%7Bborder%7D%3B%20background%3A%7Bbg%7D%3B%20opacity%3A%7Bopacity%7D%3B%20border-bottom%3A1px%20solid%20%23333%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22font-size%3A9px%3B%20color%3A%23666%3B%20font-weight%3Abold%3B%22%3ETURN%20%7Bt%7D%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22rich-wrapper%22%3E%7Bcontent_html%7D%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20full_html%20%3D%20%22%22.join(segments)%0A%20%20%20%20%20%20%20%20scroll_script%20%3D%20f%22%22%22%3Cscript%3Etry%20%7B%7Bconst%20p%20%3D%20window.parent.document%3B%20const%20c%20%3D%20p.getElementById(%22%7Bcontainer_id%7D%22)%3B%20const%20t%20%3D%20p.getElementById(%22turn-log-%7Bcurrent_turn_idx%7D%22)%3B%20if(c%20%26%26%20t)%20c.scrollTo(%7B%7Btop%3A%20t.offsetTop%20-%20c.offsetTop%20-%2020%2C%20behavior%3A%20'smooth'%7D%7D)%3B%7D%7D%20catch(e)%20%7B%7B%7D%7D%3C%2Fscript%3E%22%22%22%0A%0A%20%20%20%20%20%20%20%20log_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.Html(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%22%22%3Cdiv%20id%3D%22%7Bcontainer_id%7D%22%20style%3D%22height%3A750px%3B%20overflow-y%3Aauto%3B%20background%3A%7BBG_COLOR%7D%3B%20font-family%3Amonospace%3B%22%3E%7Bfull_html%7D%3C%2Fdiv%3E%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.iframe(scroll_script%2C%20width%3D%220%22%2C%20height%3D%220%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(log_ui%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20board_positions%2C%0A%20%20%20%20current_data%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20log_ui%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20nav_ui%2C%0A%20%20%20%20render_game_track%2C%0A)%3A%0A%20%20%20%20%23%20---%20COMPOSITION%20---%0A%20%20%20%20if%20not%20current_data%3A%0A%20%20%20%20%20%20%20%20layout%20%3D%20mo.md(%22Waiting%20for%20simulation...%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20factory%20%3D%20BOARD_DEFINITIONS.get(get_board())%0A%20%20%20%20%20%20%20%20if%20not%20factory%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20factory%20%3D%20BOARD_DEFINITIONS%5B%22standard%22%5D%0A%20%20%20%20%20%20%20%20board_instance%20%3D%20factory()%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Render%0A%20%20%20%20%20%20%20%20track_svg%20%3D%20mo.Html(%0A%20%20%20%20%20%20%20%20%20%20%20%20render_game_track(current_data%2C%20board_positions%2C%20board%3Dboard_instance)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20layout%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bmo.vstack(%5Bnav_ui%2C%20track_svg%5D%2C%20align%3D%22center%22)%2C%20log_ui%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20gap%3D2%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20layout%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20magical_athlete_simulator.core.registry%20import%20RACER_ABILITIES%0A%20%20%20%20from%20magical_athlete_simulator.racers%20import%20get_ability_classes%0A%20%20%20%20from%20magical_athlete_simulator.core.agent%20import%20(%0A%20%20%20%20%20%20%20%20BooleanInteractive%2C%0A%20%20%20%20%20%20%20%20SelectionInteractive%2C%0A%20%20%20%20)%0A%0A%20%20%20%20ability_classes%20%3D%20get_ability_classes()%0A%0A%20%20%20%20%23%20Filter%3A%20Keep%20racer%20if%20NONE%20of%20their%20abilities%20are%20interactive%0A%20%20%20%20%23%20This%20checks%20if%20the%20racer%20class%20implements%20the%20interactive%20protocols%0A%20%20%20%20automatic_racers_list%20%3D%20%5B%0A%20%20%20%20%20%20%20%20racer%0A%20%20%20%20%20%20%20%20for%20racer%2C%20abilities%20in%20RACER_ABILITIES.items()%0A%20%20%20%20%20%20%20%20if%20not%20any(%0A%20%20%20%20%20%20%20%20%20%20%20%20issubclass(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ability_classes.get(a)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(BooleanInteractive%2C%20SelectionInteractive)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20a%20in%20abilities%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20ability_classes.get(a)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%5D%0A%20%20%20%20return%20(automatic_racers_list%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20last_run_config%20starts%20as%20None.%0A%20%20%20%20%23%20It%20only%20updates%20when%20%22Run%20Analysis%22%20is%20clicked.%0A%20%20%20%20last_run_config%2C%20set_last_run_config%20%3D%20mo.state(None)%0A%20%20%20%20return%20last_run_config%2C%20set_last_run_config%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20select_auto_racers_btn%20%3D%20mo.ui.run_button(%0A%20%20%20%20%20%20%20%20label%3D%22%F0%9F%A4%96%20Select%20automatic%20racers%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22neutral%22%2C%0A%20%20%20%20%20%20%20%20tooltip%3D%22Select%20all%20racers%20that%20do%20not%20require%20human%2FAI%20decisions.%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(select_auto_racers_btn%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20automatic_racers_list%2C%0A%20%20%20%20df_racer_results%2C%0A%20%20%20%20df_races%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20select_auto_racers_btn%2C%0A%20%20%20%20set_last_run_config%2C%0A)%3A%0A%20%20%20%20%23%201.%20Prepare%20Options%20from%20RAW%20Data%0A%20%20%20%20all_racers%20%3D%20sorted(df_racer_results.get_column(%22racer_name%22).unique().to_list())%0A%20%20%20%20all_boards%20%3D%20sorted(df_races.get_column(%22board%22).unique().to_list())%0A%20%20%20%20all_counts%20%3D%20sorted(df_races.get_column(%22racer_count%22).unique().to_list())%0A%0A%20%20%20%20%23%202.%20Handle%20Auto-Select%20Logic%0A%20%20%20%20%23%20We%20can%20safely%20read%20.value%20because%20the%20button%20was%20defined%20in%20a%20previous%20cell%0A%20%20%20%20if%20select_auto_racers_btn.value%3A%0A%20%20%20%20%20%20%20%20_current_selection%20%3D%20%5Br%20for%20r%20in%20automatic_racers_list%20if%20r%20in%20all_racers%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20_current_selection%20%3D%20all_racers%0A%0A%20%20%20%20%23%203.%20Define%20Filter%20Widgets%0A%20%20%20%20ui_racers%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_racers%2C%0A%20%20%20%20%20%20%20%20value%3D_current_selection%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racers%20(roster%20pool)%22%2C%0A%20%20%20%20)%0A%20%20%20%20ui_counts%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_counts%2C%0A%20%20%20%20%20%20%20%20value%3Dall_counts%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20count(s)%22%2C%0A%20%20%20%20)%0A%20%20%20%20ui_boards%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_boards%2C%0A%20%20%20%20%20%20%20%20value%3Dall_boards%2C%0A%20%20%20%20%20%20%20%20label%3D%22Board(s)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20matchup_metric_toggle%20%3D%20mo.ui.switch(value%3DTrue%2C%20label%3D%22Show%20Percentage%20Shift%22)%0A%20%20%20%20dynamic_zoom_toggle%20%3D%20mo.ui.switch(label%3D%22%F0%9F%94%8D%20Rank-based%20view%22%2C%20value%3DFalse)%0A%0A%20%20%20%20%23%204.%20Define%20%22Run%20Analysis%22%20Button%20with%20Callback%0A%20%20%20%20def%20_submit_filters(_)%3A%0A%20%20%20%20%20%20%20%20set_last_run_config(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racers%22%3A%20ui_racers.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22boards%22%3A%20ui_boards.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22counts%22%3A%20ui_counts.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20run_computation_btn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%F0%9F%9A%80%20Run%20Analysis%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%2C%0A%20%20%20%20%20%20%20%20on_click%3D_submit_filters%2C%0A%20%20%20%20%20%20%20%20tooltip%3D%22Click%20to%20process%20data%20with%20current%20filters.%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20%20%20%20%20run_computation_btn%2C%0A%20%20%20%20%20%20%20%20ui_boards%2C%0A%20%20%20%20%20%20%20%20ui_counts%2C%0A%20%20%20%20%20%20%20%20ui_racers%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20last_run_config%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20run_computation_btn%2C%0A%20%20%20%20select_auto_racers_btn%2C%0A%20%20%20%20ui_boards%2C%0A%20%20%20%20ui_counts%2C%0A%20%20%20%20ui_racers%2C%0A)%3A%0A%20%20%20%20%23%20A.%20Check%20for%20%22Stale%22%20state%20(Widgets%20!%3D%20Last%20Run)%0A%20%20%20%20stale_warning%20%3D%20None%20%20%23%20Initialize%20to%20None%2C%20not%20empty%20markdown%0A%0A%20%20%20%20if%20last_run_config()%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20is_stale%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20ui_racers.value%20!%3D%20last_run_config()%5B%22racers%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20or%20ui_boards.value%20!%3D%20last_run_config()%5B%22boards%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20or%20ui_counts.value%20!%3D%20last_run_config()%5B%22counts%22%5D%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20if%20is_stale%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20FIX%3A%20Removed%20the%20trailing%20comma%20that%20made%20this%20a%20Tuple%0A%20%20%20%20%20%20%20%20%20%20%20%20stale_warning%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3A%20%23DC143C%3B%20margin-bottom%3A%200.75rem%3B%22%3E%E2%9A%A0%EF%B8%8F%20%3Cb%3EFilters%20Changed%3A%3C%2Fb%3E%20The%20dashboard%20below%20is%20showing%20old%20data.%20Click%20%3Cb%3E%F0%9F%9A%80%20Run%20Analysis%3C%2Fb%3E%20to%20update.%3C%2Fdiv%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%20B.%20Layout%0A%20%20%20%20header%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%3Chr%20style%3D%22margin%3A%201.25rem%200%3B%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%3Ch2%20style%3D%22margin%3A%200%200%200.5rem%200%3B%22%3EAggregated%20Dashboard%3C%2Fh2%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22color%3A%20%23aaa%3B%20margin-bottom%3A%200.75rem%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20Filter%20races%20by%20roster%2C%20board%2C%20and%20player%20count%20(applies%20to%20all%20aggregated%20charts%2Ftables%20below).%20%E2%9A%A0%EF%B8%8F%20Does%20not%20include%20races%20with%20error_code%20or%20Copycat%2BScoocher%20on%20Standard%20Board%20(due%20to%20loops).%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%0A%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ui_racers%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20select_auto_racers_btn%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ui_counts%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ui_boards%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20run_computation_btn%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stale_warning%20if%20stale_warning%20else%20mo.md(%22%22)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_positions%2C%20df_racer_results%2C%20df_races%2C%20last_run_config%2C%20mo%2C%20pl)%3A%0A%20%20%20%20%23%201.%20Gate%3A%20If%20never%20run%2C%20stop%20here.%0A%20%20%20%20if%20last_run_config()%20is%20None%3A%0A%20%20%20%20%20%20%20%20mo.stop(%0A%20%20%20%20%20%20%20%20%20%20%20%20True%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3A%20%23DC143C%3B%20margin-bottom%3A%200.75rem%3B%22%3E%E2%84%B9%EF%B8%8F%20%3Cb%3EWaiting%20for%20Input%3A%3C%2Fb%3E%20Adjust%20filters%20above%20and%20click%20%3Cb%3E%F0%9F%9A%80%20Run%20Analysis%3C%2Fb%3E%20to%20generate%20stats.%3Cdiv%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%202.%20Unwrap%20the%20specific%20config%20used%20for%20THIS%20run%0A%20%20%20%20selected_racers%20%3D%20list(last_run_config()%5B%22racers%22%5D)%0A%20%20%20%20selected_counts%20%3D%20list(last_run_config()%5B%22counts%22%5D)%0A%20%20%20%20selected_boards%20%3D%20list(last_run_config()%5B%22boards%22%5D)%0A%0A%20%20%20%20%23%203.%20Validation%20Logic%0A%20%20%20%20error_msg%20%3D%20None%0A%20%20%20%20if%20len(selected_boards)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20error_msg%20%3D%20%22Select%20at%20least%20one%20board.%22%0A%20%20%20%20elif%20len(selected_counts)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20error_msg%20%3D%20%22Select%20at%20least%20one%20racer%20count.%22%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20min_required%20%3D%20max(selected_counts)%0A%20%20%20%20%20%20%20%20if%20len(selected_racers)%20%3C%20min_required%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20error_msg%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Need%20at%20least%20%7Bmin_required%7D%20racers%20selected%20(because%20max%20racer_count%20%3D%20%7Bmin_required%7D)%2C%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22but%20only%20%7Blen(selected_racers)%7D%20selected.%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%204.%20Apply%20Filters%0A%20%20%20%20if%20error_msg%20is%20None%3A%0A%20%20%20%20%20%20%20%20%23%20Filter%20Races%20by%20metadata%0A%20%20%20%20%20%20%20%20races_bc%20%3D%20df_races.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22board%22).is_in(selected_boards)%0A%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22racer_count%22).is_in(selected_counts)%0A%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22error_code%22).is_null()%0A%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22total_turns%22).gt(1)%20%20%23%20remove%20Copycat%20%2B%20Scoocher%20stuff%0A%20%20%20%20%20%20%20%20).select(%5B%22config_hash%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%0A%20%20%20%20%20%20%20%20%23%20Roster%20Check%0A%20%20%20%20%20%20%20%20roster_ok%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results.join(races_bc%2C%20on%3D%22config_hash%22%2C%20how%3D%22inner%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%5B%22config_hash%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).n_unique().alias(%22n_present%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.is_in(selected_racers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.all()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22all_in_pool%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22all_in_pool%22)%20%26%20(pl.col(%22n_present%22)%20%3D%3D%20pl.col(%22racer_count%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(%5B%22config_hash%22%5D)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20eligible_hashes%20%3D%20roster_ok.get_column(%22config_hash%22).unique()%0A%0A%20%20%20%20%20%20%20%20df_races_f%20%3D%20df_races.filter(pl.col(%22config_hash%22).is_in(eligible_hashes))%0A%20%20%20%20%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22config_hash%22).is_in(eligible_hashes)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20df_positions_f%20%3D%20df_positions.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22config_hash%22).is_in(eligible_hashes)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20df_races_f.height%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20error_msg%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22No%20data.%20Either%20no%20races%20match%20board%2Fcount%2C%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22or%20the%20selected%20racer%20pool%20excludes%20members%20of%20those%20races.%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races_f%20%3D%20df_races.head(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.head(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_positions_f%20%3D%20df_positions.head(0)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20df_races_f%20%3D%20df_races.head(0)%0A%20%20%20%20%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.head(0)%0A%20%20%20%20%20%20%20%20df_positions_f%20%3D%20df_positions.head(0)%0A%0A%20%20%20%20%23%205.%20Validation%20Note%0A%20%20%20%20if%20error_msg%3A%0A%20%20%20%20%20%20%20%20mo.output.replace(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%3Cdiv%20style%3D'color%3A%23ff6b6b%3B%20font-weight%3A600%3B%20margin-top%3A0.5rem%3B'%3E%E2%9A%A0%20%7Berror_msg%7D%3C%2Fdiv%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20df_positions_f%2C%0A%20%20%20%20%20%20%20%20df_racer_results_f%2C%0A%20%20%20%20%20%20%20%20df_races_f%2C%0A%20%20%20%20%20%20%20%20selected_boards%2C%0A%20%20%20%20%20%20%20%20selected_counts%2C%0A%20%20%20%20%20%20%20%20selected_racers%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20df_positions_f%2C%0A%20%20%20%20df_racer_results_f%2C%0A%20%20%20%20df_races_f%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20selected_boards%2C%0A%20%20%20%20selected_counts%2C%0A%20%20%20%20selected_racers%2C%0A)%3A%0A%20%20%20%20%23%20A.%20Check%20Data%20Load%0A%20%20%20%20if%20df_positions_f.height%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20mo.stop(True%2C%20mo.md(%22%E2%9A%A0%EF%B8%8F%20**No%20data%20matches%20filters.**%22))%0A%0A%20%20%20%20%23%20Apply%20Racer%20Filter%20to%20Results%20(Optimization)%0A%20%20%20%20df_racer_results_filtered%20%3D%20df_racer_results_f.filter(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).is_in(selected_racers)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20HELPER%20FUNCTIONS%20---%0A%20%20%20%20def%20unpivot_positions(df_flat%3A%20pl.DataFrame)%20-%3E%20pl.DataFrame%3A%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_flat.unpivot(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20index%3D%5B%22config_hash%22%2C%20%22turn_index%22%2C%20%22current_racer_id%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%5B%22pos_r0%22%2C%20%22pos_r1%22%2C%20%22pos_r2%22%2C%20%22pos_r3%22%2C%20%22pos_r4%22%2C%20%22pos_r5%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20variable_name%3D%22racer_slot%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value_name%3D%22position%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_slot%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.str.extract(r%22pos_r(%5Cd%2B)%22%2C%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.cast(pl.Int64)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22racer_id%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22racer_id%22)%20%3D%3D%20pl.col(%22current_racer_id%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22is_current_turn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.drop(%22racer_slot%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(pl.col(%22position%22).is_not_null())%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20def%20_calculate_all_data()%3A%0A%20%20%20%20%20%20%20%20%23%20---%20A.%20PREPARE%20METRICS%20---%0A%20%20%20%20%20%20%20%20df_long%20%3D%20unpivot_positions(df_positions_f)%0A%0A%20%20%20%20%20%20%20%20%23%201.%20TRUTH%20SOURCE%3A%20Global%20Win%20Rates%0A%20%20%20%20%20%20%20%20global_win_rates%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_filtered.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22rank%22)%20%3D%3D%201).sum().alias(%22total_wins%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.len().alias(%22total_races%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22total_wins%22)%20%2F%20pl.col(%22total_races%22)).alias(%22global_win_rate%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Tightness%20%26%20Volatility%20(race-level)%0A%20%20%20%20%20%20%20%20turn_stats%20%3D%20df_long.group_by(%5B%22config_hash%22%2C%20%22turn_index%22%5D).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22position%22).mean().alias(%22mean_pos%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20tightness_calc%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_long.join(turn_stats%2C%20on%3D%5B%22config_hash%22%2C%20%22turn_index%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns((pl.col(%22position%22)%20-%20pl.col(%22mean_pos%22)).abs().alias(%22dev%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22dev%22).mean().alias(%22race_tightness_score%22))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20volatility_calc%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_long.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22position%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.rank(method%3D%22dense%22%2C%20descending%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%5B%22config_hash%22%2C%20%22turn_index%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22rank_now%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.sort(%5B%22config_hash%22%2C%20%22racer_id%22%2C%20%22turn_index%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22rank_now%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.shift(1)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%5B%22config_hash%22%2C%20%22racer_id%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22rank_prev%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(pl.col(%22rank_prev%22).is_not_null())%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22rank_now%22)%20!%3D%20pl.col(%22rank_prev%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.cast(pl.Int8)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22rank_changed%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22rank_changed%22).mean().alias(%22race_volatility_score%22))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20NEW%3A%20GROSS%20SPEED%20(accurate)%20---%0A%20%20%20%20%20%20%20%20df_pos_sorted%20%3D%20df_long.sort(%5B%22config_hash%22%2C%20%22racer_id%22%2C%20%22turn_index%22%5D)%0A%0A%20%20%20%20%20%20%20%20df_gross_dist%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_pos_sorted.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22position%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.shift(1)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%5B%22config_hash%22%2C%20%22racer_id%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22prev_pos%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22position%22)%20-%20pl.col(%22prev_pos%22).fill_null(0)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22move_delta%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(pl.col(%22move_delta%22)%20%3E%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%5B%22config_hash%22%2C%20%22racer_id%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22move_delta%22).sum().alias(%22gross_distance%22))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20NEW%3A%20Late-game%20snapshot%20(66%25)%20%2B%20position-vs-median%20---%0A%20%20%20%20%20%20%20%20winner_turns%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_filtered.filter(pl.col(%22rank%22)%20%3D%3D%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22turns_taken%22).min().alias(%22winner_turns%22))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20snapshot_target%20%3D%20winner_turns.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22winner_turns%22)%20*%200.66)%0A%20%20%20%20%20%20%20%20%20%20%20%20.floor()%0A%20%20%20%20%20%20%20%20%20%20%20%20.clip(lower_bound%3D1)%0A%20%20%20%20%20%20%20%20%20%20%20%20.cast(pl.Int32)%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22snapshot_turn%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20df_snap_pos%20%3D%20df_long.join(snapshot_target%2C%20on%3D%22config_hash%22).filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22turn_index%22)%20%3D%3D%20pl.col(%22snapshot_turn%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20df_race_medians%20%3D%20df_snap_pos.group_by(%22config_hash%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22position%22).median().alias(%22median_pos_at_snap%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20df_late_game%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_snap_pos.join(df_race_medians%2C%20on%3D%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22position%22)%20-%20pl.col(%22median_pos_at_snap%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pos_diff_from_median%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.select(%5B%22config_hash%22%2C%20%22racer_id%22%2C%20%22pos_diff_from_median%22%5D)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Race%20environment%20stats%0A%20%20%20%20%20%20%20%20race_environment_stats%20%3D%20df_racer_results_filtered.group_by(%22config_hash%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_trigger_count%22).sum()%20%2F%20pl.col(%22racer_id%22).count()).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_triggers%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22recovery_turns%22).sum()%20%2F%20pl.col(%22turns_taken%22).sum()).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_trip_rate%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20stats_races%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races_f.join(tightness_calc%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(volatility_calc%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(race_environment_stats%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_null(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Results%20enriched%20with%20movement%20features%0A%20%20%20%20%20%20%20%20stats_results%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_filtered.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_gross_dist%2C%20on%3D%5B%22config_hash%22%2C%20%22racer_id%22%5D%2C%20how%3D%22left%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(df_late_game%2C%20on%3D%5B%22config_hash%22%2C%20%22racer_id%22%5D%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Fill%20basic%20nulls%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22gross_distance%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_diff_from_median%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20THE%20FIX%3A%20Convert%200%20-%3E%20Null%20(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20This%20tells%20Polars%20%22Do%20not%20count%20this%20row%20in%20averages%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22turns_taken%22)%20%3C%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22turns_taken%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22total_turns_clean%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22rolling_turns%22)%20%3C%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22rolling_turns%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22rolling_turns_clean%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Apply%20Specific%20Denominators%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20A.%20MOVEMENT%20(Uses%20Total%20Turns)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20total_turns%20is%20Null%2C%20speed%20becomes%20Null%20(ignored%20in%20avg)%2C%20which%20is%20correct.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22gross_distance%22)%20%2F%20pl.col(%22total_turns_clean%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22speed_gross%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20B.%20ABILITIES%20(Uses%20Total%20Turns)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_trigger_count%22)%20%2F%20pl.col(%22total_turns_clean%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22triggers_per_turn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22ability_self_target_count%22)%20%2F%20pl.col(%22total_turns_clean%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22self_per_turn%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_target_count%22)%20%2F%20pl.col(%22total_turns_clean%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22target_per_turn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20C.%20DICE%20(Uses%20Rolling%20Turns)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Only%20calculated%20if%20they%20actually%20rolled.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22sum_dice_rolled%22)%20%2F%20pl.col(%22rolling_turns_clean%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22dice_per_rolling_turn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22sum_dice_rolled_final%22)%20%2F%20pl.col(%22rolling_turns_clean%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22final_roll_per_rolling_turn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22gross_distance%22)%20-%20pl.col(%22sum_dice_rolled%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22total_turns_clean%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22non_dice_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20UPDATED%3A%20Consistency%20%3D%20within%201%20std%20dev%20of%20mean%20(per%20racer)%20---%0A%20%20%20%20%20%20%20%20racer_mu_sigma%20%3D%20stats_results.group_by(%22racer_name%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22mean_vp_mu%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).std().fill_null(0).alias(%22std_vp_sigma%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20consistency_calc%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.join(racer_mu_sigma%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22std_vp_sigma%22)%20%3D%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(True)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22final_vp%22)%20-%20pl.col(%22mean_vp_mu%22)).abs()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%3D%20pl.col(%22std_vp_sigma%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22is_consistent%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22is_consistent%22).mean().alias(%22consistency_score%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22std_vp_sigma%22).first().alias(%22std_dev_val%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%205.%20Base%20stats%20aggregation%0A%20%20%20%20%20%20%20%20base_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stats_races.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_tightness_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_volatility_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_triggers%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_trip_rate%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22total_turns%22).alias(%22race_global_turns%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22mean_vp%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22rank%22)%20%3D%3D%201).sum().alias(%22cnt_1st%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22rank%22)%20%3D%3D%202).sum().alias(%22cnt_2nd%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.len().alias(%22races_run%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Dynamics%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_tightness_score%22).mean().alias(%22avg_race_tightness%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_volatility_score%22).mean().alias(%22avg_race_volatility%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_avg_triggers%22).mean().alias(%22avg_env_triggers%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_avg_trip_rate%22).mean().alias(%22avg_env_trip_rate%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).mean().alias(%22avg_game_duration%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Movement%20%2F%20Dice%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22non_dice_movement%22).mean().alias(%22avg_ability_move%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22speed_gross%22).mean().alias(%22avg_speed_gross%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22dice_per_rolling_turn%22).mean().alias(%22avg_dice_base%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_roll_per_rolling_turn%22).mean().alias(%22avg_final_roll%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Ability%20usage%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22triggers_per_turn%22).mean()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22self_per_turn%22).mean()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22target_per_turn%22).mean()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%206.%20Per-racer%20correlations%0A%20%20%20%20%20%20%20%20corr_df%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22dice_per_rolling_turn%22%2C%20%22final_vp%22).alias(%22dice_dependency%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22non_dice_movement%22%2C%20%22final_vp%22).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22ability_move_dependency%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.corr(%22racer_id%22%2C%20%22final_vp%22)%20*%20-1).alias(%22start_pos_bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22pos_diff_from_median%22%2C%20%22final_vp%22).alias(%22midgame_bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22ability_trigger_count%22%2C%20%22final_vp%22).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22trigger_dependency%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20final_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20base_stats.join(corr_df%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(consistency_calc%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20global_win_rates.select(%5B%22racer_name%22%2C%20%22global_win_rate%22%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22racer_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cnt_1st%22)%20%2F%20pl.col(%22races_run%22)).alias(%22pct_1st%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cnt_2nd%22)%20%2F%20pl.col(%22races_run%22)).alias(%22pct_2nd%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22consistency_score%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22global_win_rate%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22avg_final_roll%22)%20-%20pl.col(%22avg_dice_base%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22plus_minus_modified%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22std_dev_val%22).fill_null(0).alias(%22std_vp_sigma%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20B.%20MATRICES%20---%0A%20%20%20%20%20%20%20%20global_means%20%3D%20final_stats.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%22racer_name%22%2C%20pl.col(%22mean_vp%22).alias(%22my_global_avg%22)%5D%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20subjects%20%3D%20stats_results.select(%5B%22config_hash%22%2C%20%22racer_name%22%2C%20%22final_vp%22%5D)%0A%20%20%20%20%20%20%20%20opponents%20%3D%20stats_results.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bpl.col(%22config_hash%22)%2C%20pl.col(%22racer_name%22).alias(%22opponent_name%22)%5D%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20matchup_df%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20subjects.join(opponents%2C%20on%3D%22config_hash%22%2C%20how%3D%22inner%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(pl.col(%22racer_name%22)%20!%3D%20pl.col(%22opponent_name%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%5B%22racer_name%22%2C%20%22opponent_name%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22final_vp%22).mean().alias(%22avg_vp_with_opponent%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(global_means%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22avg_vp_with_opponent%22)%20-%20pl.col(%22my_global_avg%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22residual_matchup%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22avg_vp_with_opponent%22)%20-%20pl.col(%22my_global_avg%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22my_global_avg%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22percentage_shift%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22stats%22%3A%20final_stats%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22matchup_df%22%3A%20matchup_df%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22results_raw%22%3A%20stats_results%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22races_raw%22%3A%20stats_races%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20with%20mo.status.spinner(%0A%20%20%20%20%20%20%20%20title%3Df%22Aggregating%20data%20for%20%7Bdf_races_f.height%7D%20races...%22%0A%20%20%20%20)%20as%20_spinner%3A%0A%20%20%20%20%20%20%20%20dashboard_data%20%3D%20_calculate_all_data()%0A%0A%20%20%20%20%23%20Success%20message%0A%20%20%20%20mo.output.replace(%0A%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%E2%9C%85%20**%7Bdf_races_f.height%7D**%20races%20analyzed%20with%20**%7Blen(selected_racers)%7D**%20racers%20in%20races%20with%20**%7B'%2C%20'.join(%5Bstr(c)%20for%20c%20in%20selected_counts%5D)%7D**%20racers%20on%20**%7B'%20and%20'.join(selected_boards)%7D**.%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20return%20(dashboard_data%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BG_COLOR%2C%0A%20%20%20%20alt%2C%0A%20%20%20%20dashboard_data%2C%0A%20%20%20%20df_races_f%2C%0A%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20get_racer_color%2C%0A%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20pl%2C%0A)%3A%0A%20%20%20%20%23%20If%20no%20data%20is%20available%20(button%20not%20clicked%20yet)%2C%20stop%20execution%20here.%0A%20%20%20%20if%20dashboard_data%20is%20None%3A%0A%20%20%20%20%20%20%20%20mo.stop(True)%0A%0A%20%20%20%20stats%20%3D%20dashboard_data%5B%22stats%22%5D%0A%20%20%20%20matchup_df%20%3D%20dashboard_data%5B%22matchup_df%22%5D%0A%20%20%20%20proc_results%20%3D%20dashboard_data%5B%22results_raw%22%5D%0A%20%20%20%20proc_races%20%3D%20dashboard_data%5B%22races_raw%22%5D%0A%0A%20%20%20%20%23%20---%201.%20DYNAMIC%20MATCHUP%20CHART%20---%0A%20%20%20%20use_pct%20%3D%20matchup_metric_toggle.value%0A%20%20%20%20metric_col%20%3D%20%22percentage_shift%22%20if%20use_pct%20else%20%22residual_matchup%22%0A%20%20%20%20metric_title%20%3D%20%22Pct%20Shift%20vs%20Own%20Avg%22%20if%20use_pct%20else%20%22Residual%20vs%20Own%20Avg%22%0A%20%20%20%20legend_format%20%3D%20%22%2B.1%25%22%20if%20use_pct%20else%20%22%2B.2f%22%0A%0A%20%20%20%20c_matrix%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(matchup_df)%0A%20%20%20%20%20%20%20%20.mark_rect()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22opponent_name%3AN%22%2C%20title%3D%22Opponent%20Present%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22racer_name%3AN%22%2C%20title%3D%22Subject%20Racer%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7Bmetric_col%7D%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3Dmetric_title%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%5BDeep%20Pink%2C%20Soft%20Pink%2C%20GREY%2C%20Soft%20Blue%2C%20Deep%20Blue%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20range%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%23AD1457%22%2C%20%20%23%20Deep%20Pink%20(New%2C%20for%20negative%20outliers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%23F06292%22%2C%20%20%23%20Your%20original%20Pink%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%233E3B45%22%2C%20%20%23%20Grey%20(Anchor%20at%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%2342A5F5%22%2C%20%20%23%20Your%20original%20Blue%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%230D47A1%22%2C%20%20%23%20Deep%20Blue%20(New%2C%20for%20positive%20outliers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domainMid%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20interpolate%3D%22rgb%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(format%3Dlegend_format)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22opponent_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22avg_vp_with_opponent%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%22Avg%20VP%20vs%20Opp%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22my_global_avg%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%22My%20Global%20Avg%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22residual_matchup%3AQ%22%2C%20format%3D%22%2B.2f%22%2C%20title%3D%22Residual%20(Pts)%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22percentage_shift%3AQ%22%2C%20format%3D%22%2B.1%25%22%2C%20title%3D%22Shift%20(%25)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3Df%22Matchup%20Matrix%20(%7Bmetric_title%7D)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D%22container%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D800%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3DBG_COLOR%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%202.%20QUADRANT%20CHART%20BUILDER%20(UPDATED)%20---%0A%20%20%20%20r_list%20%3D%20stats%5B%22racer_name%22%5D.unique().to_list()%0A%20%20%20%20c_list%20%3D%20%5Bget_racer_color(r)%20for%20r%20in%20r_list%5D%0A%0A%20%20%20%20%23%20%5BHELPER%5D%20Calculate%20contrast%20color%20(Black%20or%20White)%20based%20on%20luminance%0A%20%20%20%20def%20_get_contrasting_stroke(hex_color)%3A%0A%20%20%20%20%20%20%20%20if%20not%20hex_color%20or%20not%20hex_color.startswith(%22%23%22)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22white%22%0A%20%20%20%20%20%20%20%20hex_color%20%3D%20hex_color.lstrip(%22%23%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20r%2C%20g%2C%20b%20%3D%20tuple(int(hex_color%5Bi%20%3A%20i%20%2B%202%5D%2C%2016)%20for%20i%20in%20(0%2C%202%2C%204))%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22black%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20((0.299%20*%20r%20%2B%200.587%20*%20g%20%2B%200.114%20*%20b)%20%2F%20255)%20%3E%200.6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20%22white%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22white%22%0A%0A%20%20%20%20def%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats_df%2C%0A%20%20%20%20%20%20%20%20racers%2C%0A%20%20%20%20%20%20%20%20colors%2C%0A%20%20%20%20%20%20%20%20x_col%2C%0A%20%20%20%20%20%20%20%20y_col%2C%0A%20%20%20%20%20%20%20%20title%2C%0A%20%20%20%20%20%20%20%20x_title%2C%0A%20%20%20%20%20%20%20%20y_title%2C%0A%20%20%20%20%20%20%20%20*%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3A%20bool%2C%0A%20%20%20%20%20%20%20%20reverse_x%3DFalse%2C%0A%20%20%20%20%20%20%20%20quad_labels%3DNone%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3DNone%2C%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20PLOT_BG%20%3D%20%22%23232826%22%0A%0A%20%20%20%20%20%20%20%20%23%20---%20PREPARE%20COLOR%20MAPPING%20---%0A%20%20%20%20%20%20%20%20racer_to_hex%20%3D%20dict(zip(racers%2C%20colors))%0A%20%20%20%20%20%20%20%20racer_to_stroke%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20r%3A%20_get_contrasting_stroke(c)%20for%20r%2C%20c%20in%20racer_to_hex.items()%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%23%20---%20BRANCH%20A%3A%20DYNAMIC%20ZOOM%20(Rank%20Scale)%20---%0A%20%20%20%20%20%20%20%20if%20use_rank_scale%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_apply_rank_transform(df%2C%20col)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20series%20%3D%20df%5Bcol%5D.drop_nulls()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20series.len()%20%3C%203%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%2C%20col%2C%20%5B%5D%2C%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vals%20%3D%20series.to_numpy()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sorted_vals%20%3D%20np.sort(vals)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sorted_ranks%20%3D%20np.linspace(0%2C%201%2C%20len(vals))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20new_col%20%3D%20f%22%7Bcol%7D_rank%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20def%20get_rank_pos(x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20float(np.interp(x%2C%20sorted_vals%2C%20sorted_ranks))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20transformed_df%20%3D%20df.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.map_elements(get_rank_pos%2C%20return_dtype%3Dpl.Float64)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(new_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ticks%20%3D%20np.unique(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20np.percentile(vals%2C%20%5B0%2C%2020%2C%2040%2C%2060%2C%2080%2C%20100%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).tolist()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_ticks%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20float(np.interp(t%2C%20sorted_vals%2C%20sorted_ranks))%20for%20t%20in%20ticks%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20transformed_df%2C%20new_col%2C%20ticks%2C%20vis_ticks%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_x%2C%20plot_x%2C%20ticks_x%2C%20vis_ticks_x%20%3D%20_apply_rank_transform(stats_df%2C%20x_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20chart_df%2C%20plot_y%2C%20ticks_y%2C%20vis_ticks_y%20%3D%20_apply_rank_transform(df_x%2C%20y_col)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20scale_x%20%3D%20alt.Scale(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domain%3D%5B-0.05%2C%201.05%5D%2C%20nice%3DFalse%2C%20zero%3DFalse%2C%20reverse%3Dreverse_x%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20scale_y%20%3D%20alt.Scale(domain%3D%5B-0.05%2C%201.05%5D%2C%20nice%3DFalse%2C%20zero%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20NOTE%3A%20Removed%20'values%3D'%20constraint%20to%20allow%20dynamic%20zooming%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_x%20%3D%20alt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20grid%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelExpr%3Df%22datum.value%20%3D%3D%20%7Bvis_ticks_x%5B0%5D%7D%20%3F%20'%7Bticks_x%5B0%5D%3A.2f%7D'%20%3A%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22abs(datum.value%20-%20%7Bvt%7D)%20%3C%200.001%20%3F%20'%7Brt%3A.2f%7D'%20%3A%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20vt%2C%20rt%20in%20zip(vis_ticks_x%5B1%3A%5D%2C%20ticks_x%5B1%3A%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20format(datum.value%2C%20'.2f')%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_y%20%3D%20alt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20grid%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelExpr%3Df%22datum.value%20%3D%3D%20%7Bvis_ticks_y%5B0%5D%7D%20%3F%20'%7Bticks_y%5B0%5D%3A.2f%7D'%20%3A%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22abs(datum.value%20-%20%7Bvt%7D)%20%3C%200.001%20%3F%20'%7Brt%3A.2f%7D'%20%3A%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20vt%2C%20rt%20in%20zip(vis_ticks_y%5B1%3A%5D%2C%20ticks_y%5B1%3A%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20format(datum.value%2C%20'.2f')%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20mid_x%2C%20mid_y%20%3D%200.5%2C%200.5%0A%0A%20%20%20%20%20%20%20%20%23%20---%20BRANCH%20B%3A%20LINEAR%20SCALE%20(Original)%20---%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20plot_x%2C%20plot_y%20%3D%20x_col%2C%20y_col%0A%20%20%20%20%20%20%20%20%20%20%20%20chart_df%20%3D%20stats_df%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20vals_x%20%3D%20stats_df%5Bx_col%5D.drop_nulls().to_list()%0A%20%20%20%20%20%20%20%20%20%20%20%20vals_y%20%3D%20stats_df%5By_col%5D.drop_nulls().to_list()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20vals_x%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20alt.Chart(stats_df).mark_text(text%3D%22No%20Data%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20min_x%2C%20max_x%20%3D%20min(vals_x)%2C%20max(vals_x)%0A%20%20%20%20%20%20%20%20%20%20%20%20min_y%2C%20max_y%20%3D%20min(vals_y)%2C%20max(vals_y)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20min_x%20%3D%3D%20max_x%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20max_x%20%2B%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_x%20-%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20min_y%20%3D%3D%20max_y%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20max_y%20%2B%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_y%20-%3D%200.01%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20pad_x%2C%20pad_y%20%3D%20(max_x%20-%20min_x)%20*%200.15%2C%20(max_y%20-%20min_y)%20*%200.15%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_x%20%3D%20%5Bmin_x%20-%20pad_x%2C%20max_x%20%2B%20pad_x%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_y%20%3D%20%5Bmin_y%20-%20pad_y%2C%20max_y%20%2B%20pad_y%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20scale_x%20%3D%20alt.Scale(domain%3Ddom_x%2C%20reverse%3Dreverse_x%2C%20zero%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20scale_y%20%3D%20alt.Scale(domain%3Ddom_y%2C%20zero%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_x%2C%20axis_y%20%3D%20alt.Axis(grid%3DFalse)%2C%20alt.Axis(grid%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20mid_x%2C%20mid_y%20%3D%20(min_x%20%2B%20max_x)%20%2F%202%2C%20(min_y%20%2B%20max_y)%20%2F%202%0A%0A%20%20%20%20%20%20%20%20%23%20---%20COMMON%20PLOTTING%20---%0A%20%20%20%20%20%20%20%20chart_df%20%3D%20chart_df.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.map_elements(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lambda%20n%3A%20racer_to_stroke.get(n%2C%20%22white%22)%2C%20return_dtype%3Dpl.String%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22txt_stroke%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%201.%20Guidelines%20(Independent%20DataFrames%20sharing%20Scales)%0A%20%20%20%20%20%20%20%20h_line%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22y%22%3A%20%5Bmid_y%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_rule(strokeDash%3D%5B4%2C%204%5D%2C%20color%3D%22%23888%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(y%3Dalt.Y(%22y%3AQ%22%2C%20scale%3Dscale_y))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20v_line%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22x%22%3A%20%5Bmid_x%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_rule(strokeDash%3D%5B4%2C%204%5D%2C%20color%3D%22%23888%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(x%3Dalt.X(%22x%3AQ%22%2C%20scale%3Dscale_x))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Points%0A%20%20%20%20%20%20%20%20points%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(chart_df)%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_circle(size%3D250%2C%20opacity%3D0.9)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(f%22%7Bplot_x%7D%3AQ%22%2C%20title%3Dx_title%2C%20scale%3Dscale_x%2C%20axis%3Daxis_x)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(f%22%7Bplot_y%7D%3AQ%22%2C%20title%3Dy_title%2C%20scale%3Dscale_y%2C%20axis%3Daxis_y)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3Dracers%2C%20range%3Dcolors)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(f%22%7Bx_col%7D%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3Dx_title)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(f%22%7By_col%7D%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3Dy_title)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20(extra_tooltips%20or%20%5B%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Text%20Layers%0A%20%20%20%20%20%20%20%20text_outline%20%3D%20points.mark_text(%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline%3D%22middle%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dy%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dx%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontSize%3D15%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontWeight%3D800%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke%3DPLOT_BG%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20strokeWidth%3D3%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20opacity%3D1%2C%0A%20%20%20%20%20%20%20%20).encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.value(PLOT_BG)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20text_fill%20%3D%20points.mark_text(%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline%3D%22middle%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dy%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dx%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontSize%3D15%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontWeight%3D800%2C%0A%20%20%20%20%20%20%20%20).encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%20scale%3Dalt.Scale(domain%3Dracers%2C%20range%3Dcolors)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Labels%0A%20%20%20%20%20%20%20%20label_layers%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20if%20quad_labels%20and%20len(quad_labels)%20%3D%3D%204%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20use_rank_scale%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lx%2C%20rx%20%3D%20(0.98%2C%200.02)%20if%20reverse_x%20else%20(0.02%2C%200.98)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ty%2C%20by%20%3D%200.98%2C%200.02%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dom_x%2C%20dom_y%20%3D%20scale_x.domain%2C%20scale_y.domain%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20px%2C%20py%20%3D%20(dom_x%5B1%5D%20-%20dom_x%5B0%5D)%20*%200.05%2C%20(dom_y%5B1%5D%20-%20dom_y%5B0%5D)%20*%200.05%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lx%2C%20rx%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(dom_x%5B1%5D%20-%20px%2C%20dom_x%5B0%5D%20%2B%20px)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20reverse_x%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20(dom_x%5B0%5D%20%2B%20px%2C%20dom_x%5B1%5D%20-%20px)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ty%2C%20by%20%3D%20dom_y%5B1%5D%20-%20py%2C%20dom_y%5B0%5D%20%2B%20py%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20text_props%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22fontWeight%22%3A%20%22bold%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22opacity%22%3A%200.6%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22fontSize%22%3A%2014%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22color%22%3A%20%22%23e0e0e0%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_lbl(x%2C%20y%2C%20t%2C%20align%2C%20baseline)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22x%22%3A%20%5Bx%5D%2C%20%22y%22%3A%20%5By%5D%2C%20%22t%22%3A%20%5Bt%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.mark_text(align%3Dalign%2C%20baseline%3Dbaseline%2C%20**text_props)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22x%3AQ%22%2C%20scale%3Dscale_x)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22y%3AQ%22%2C%20scale%3Dscale_y)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22t%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20label_layers%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_lbl(lx%2C%20ty%2C%20quad_labels%5B0%5D%2C%20%22left%22%2C%20%22top%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_lbl(rx%2C%20ty%2C%20quad_labels%5B1%5D%2C%20%22right%22%2C%20%22top%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_lbl(lx%2C%20by%2C%20quad_labels%5B2%5D%2C%20%22left%22%2C%20%22bottom%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_lbl(rx%2C%20by%2C%20quad_labels%5B3%5D%2C%20%22right%22%2C%20%22bottom%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%23%205.%20Composition%20(Fixed%20Width%2C%20Shared%20Scales%2C%20NO%20Internal%20Zoom)%0A%20%20%20%20%20%20%20%20layers%20%3D%20%5Bpoints%2C%20text_outline%2C%20text_fill%5D%20%2B%20label_layers%20%2B%20%5Bh_line%2C%20v_line%5D%0A%0A%20%20%20%20%20%20%20%20xzoom%20%3D%20alt.selection_interval(%0A%20%20%20%20%20%20%20%20%20%20%20%20encodings%3D%5B%22x%22%5D%2C%20bind%3D%22scales%22%2C%20zoom%3D%22wheel!%5Bevent.shiftKey%5D%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20yzoom%20%3D%20alt.selection_interval(%0A%20%20%20%20%20%20%20%20%20%20%20%20encodings%3D%5B%22y%22%5D%2C%20bind%3D%22scales%22%2C%20zoom%3D%22wheel!%5Bevent.altKey%5D%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20xzoom%20%3D%20alt.selection_interval(bind%3D%22scales%22%2C%20encodings%3D%5B%22x%22%5D%2C%20zoom%3D%22wheel!%22)%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.layer(*layers)%0A%20%20%20%20%20%20%20%20%20%20%20%20.resolve_scale(x%3D%22shared%22%2C%20y%3D%22shared%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.add_params(xzoom)%0A%20%20%20%20%20%20%20%20%20%20%20%20.properties(width%3D%22container%22%2C%20height%3D800%2C%20background%3DBG_COLOR)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%20---%203.%20GENERATE%20CHARTS%20(Unchanged%20Logic%2C%20uses%20new%20builder)%20---%0A%20%20%20%20c_consist%20%3D%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22consistency_score%22%2C%0A%20%20%20%20%20%20%20%20%22mean_vp%22%2C%0A%20%20%20%20%20%20%20%20%22Consistency%20(Stability)%22%2C%0A%20%20%20%20%20%20%20%20%22Stability%20(%25%20within%201%CF%83%20of%20mean%20VP)%22%2C%0A%20%20%20%20%20%20%20%20%22Avg%20VP%22%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Wildcard%22%2C%20%22Reliable%20Winner%22%2C%20%22Erratic%22%2C%20%22Reliable%20Loser%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22std_vp_sigma%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%221%CF%83%20(Std%20Dev)%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20c_excitement%20%3D%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22avg_race_tightness%22%2C%0A%20%20%20%20%20%20%20%20%22avg_race_volatility%22%2C%0A%20%20%20%20%20%20%20%20%22Excitement%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Tightness%20(Avg%20distance%20from%20mean%20position)%22%2C%0A%20%20%20%20%20%20%20%20%22Volatility%20(%25%20of%20turns%20with%20rank%20changes)%22%2C%0A%20%20%20%20%20%20%20%20reverse_x%3DTrue%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Rubber%20Band%22%2C%20%22Thriller%22%2C%20%22Procession%22%2C%20%22Stalemate%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20)%0A%0A%20%20%20%20c_sources%20%3D%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22ability_move_dependency%22%2C%0A%20%20%20%20%20%20%20%20%22dice_dependency%22%2C%0A%20%20%20%20%20%20%20%20%22Sources%20of%20Victory%22%2C%0A%20%20%20%20%20%20%20%20%22Ability%20Move%20Dep%20(Corr%20to%20VP)%22%2C%0A%20%20%20%20%20%20%20%20%22Dice%20Dep%20(Corr%20to%20VP)%22%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Dice-Driven%22%2C%20%22Hybrid%20Winner%22%2C%20%22Low%20Signal%22%2C%20%22Ability-Driven%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22avg_ability_move%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%22Ability%20Mvmt%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22avg_dice_base%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%22Dice%2FRolling%20Turn%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20c_momentum%20%3D%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22start_pos_bias%22%2C%0A%20%20%20%20%20%20%20%20%22midgame_bias%22%2C%0A%20%20%20%20%20%20%20%20%22Momentum%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Start%20Pos%20Bias%20(%2B%20%3D%20comeback)%22%2C%0A%20%20%20%20%20%20%20%20%22Mid-Game%20Bias%20(%2B%20%3D%20leader%20wins)%22%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Late%20Bloomer%22%2C%20%22Snowballer%22%2C%20%22Comeback%20King%22%2C%20%22Frontrunner%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22pct_1st%3AQ%22%2C%20format%3D%22.1%25%22%2C%20title%3D%22Win%25%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22mean_vp%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3D%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20c_engine%20%3D%20_build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22triggers_per_turn%22%2C%0A%20%20%20%20%20%20%20%20%22trigger_dependency%22%2C%0A%20%20%20%20%20%20%20%20%22Engine%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Activity%20(Avg%20Triggers%20%2F%20Turn)%22%2C%0A%20%20%20%20%20%20%20%20%22Efficacy%20(Corr%20Triggers%20to%20VP)%22%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Potent%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Ability%20Abuser%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Low%20Reliance%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Spammer%22%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20...%20(Rest%20of%20global%20charts%20and%20UI%20layout%20logic%20remains%20exactly%20the%20same)%20...%0A%20%20%20%20%23%20To%20save%20space%2C%20I%20am%20keeping%20the%20logic%20below%20identical%20to%20your%20previous%20cell.%0A%0A%20%20%20%20%23%20---%204.%20GLOBAL%20DYNAMICS%20---%0A%20%20%20%20race_meta%20%3D%20df_races_f.select(%5B%22config_hash%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20races_with_meta%20%3D%20proc_races.join(race_meta%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20results_with_meta%20%3D%20proc_results.join(race_meta%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%0A%20%20%20%20race_level_agg%20%3D%20races_with_meta.group_by(%5B%22board%22%2C%20%22racer_count%22%5D).agg(%0A%20%20%20%20%20%20%20%20pl.col(%22total_turns%22).mean().alias(%22Avg%20Turns%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_tightness_score%22).mean().alias(%22Tightness%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_volatility_score%22).mean().alias(%22Volatility%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_avg_trip_rate%22).mean().alias(%22Trip%20Rate%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_avg_triggers%22).mean().alias(%22Abilities%20Triggered%22)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20result_level_agg%20%3D%20(%0A%20%20%20%20%20%20%20%20results_with_meta.group_by(%5B%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22sum_dice_rolled%22%2C%20%22final_vp%22).alias(%22Dice%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22non_dice_movement%22%2C%20%22final_vp%22).alias(%22Ability%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.corr(%22racer_id%22%2C%20%22final_vp%22)%20*%20-1).alias(%22Start%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22pos_diff_from_median%22%2C%20%22final_vp%22).alias(%22MidGame%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20)%0A%0A%20%20%20%20global_wide%20%3D%20race_level_agg.join(%0A%20%20%20%20%20%20%20%20result_level_agg%2C%20on%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%20how%3D%22inner%22%0A%20%20%20%20).fill_nan(0)%0A%0A%20%20%20%20global_grp1%20%3D%20global_wide.select(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Avg%20VP%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Avg%20Turns%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Tightness%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Volatility%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Trip%20Rate%22%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20).unpivot(index%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%20variable_name%3D%22metric%22%2C%20value_name%3D%22val%22)%0A%0A%20%20%20%20global_grp2%20%3D%20global_wide.select(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Dice%20Dep%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Ability%20Dep%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Start%20Bias%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22MidGame%20Bias%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Abilities%20Triggered%22%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20).unpivot(index%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%20variable_name%3D%22metric%22%2C%20value_name%3D%22val%22)%0A%0A%20%20%20%20c_global_1%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(global_grp1)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22board%3AN%22%2C%20title%3D%22Board%22%2C%20axis%3Dalt.Axis(labelAngle%3D0))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xOffset%3Dalt.XOffset(%22racer_count%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22val%3AQ%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22racer_count%3AN%22%2C%20title%3D%22Players%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20column%3Dalt.Column(%22metric%3AN%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22val%3AQ%22%2C%20format%3D%22.3f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.resolve_scale(y%3D%22independent%22)%0A%20%20%20%20%20%20%20%20.properties(width%3D120%2C%20height%3D200%2C%20title%3D%22Race%20Metrics%20by%20Board%20%26%20Player%20Count%22)%0A%20%20%20%20)%0A%0A%20%20%20%20c_global_2%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(global_grp2)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22board%3AN%22%2C%20title%3D%22Board%22%2C%20axis%3Dalt.Axis(labelAngle%3D0))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xOffset%3Dalt.XOffset(%22racer_count%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22val%3AQ%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22racer_count%3AN%22%2C%20title%3D%22Players%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20column%3Dalt.Column(%22metric%3AN%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22val%3AQ%22%2C%20format%3D%22.3f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.resolve_scale(y%3D%22independent%22)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D120%2C%20height%3D200%2C%20title%3D%22Victory%20Correlations%20%26%20Ability%20Usage%20by%20Board%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20global_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5Bmo.ui.altair_chart(c_global_1)%2C%20mo.ui.altair_chart(c_global_2)%5D%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%205.%20ENVIRONMENT%20MATRIX%20---%0A%20%20%20%20env_metric_col%20%3D%20%22relative_shift%22%20if%20use_pct%20else%20%22absolute_shift%22%0A%20%20%20%20env_metric_title%20%3D%20%22Shift%20vs%20Own%20Avg%20(%25)%22%20if%20use_pct%20else%20%22Shift%20vs%20Own%20Avg%20(VP)%22%0A%20%20%20%20env_legend_fmt%20%3D%20%22.0%25%22%20if%20use_pct%20else%20%22%2B.2f%22%0A%0A%20%20%20%20joined%20%3D%20proc_results.join(race_meta%2C%20on%3D%22config_hash%22%2C%20how%3D%22inner%22)%0A%20%20%20%20racer_baselines%20%3D%20joined.group_by(%22racer_name%22).agg(%0A%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22racer_global_avg_vp%22)%0A%20%20%20%20)%0A%0A%20%20%20%20env_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20joined.group_by(%5B%22racer_name%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22cond_avg_vp%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).count().alias(%22sample_size%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.join(racer_baselines%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cond_avg_vp%22)%20-%20pl.col(%22racer_global_avg_vp%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22racer_global_avg_vp%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22relative_shift%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cond_avg_vp%22)%20-%20pl.col(%22racer_global_avg_vp%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22absolute_shift%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_count%22).cast(pl.String)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22p%5Cn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20pl.col(%22board%22).cast(pl.String)%0A%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22env_label%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20sort_order%20%3D%20(%0A%20%20%20%20%20%20%20%20env_stats.select(%5B%22env_label%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.unique()%0A%20%20%20%20%20%20%20%20.sort(%5B%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.get_column(%22env_label%22)%0A%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20)%0A%0A%20%20%20%20c_env%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(env_stats)%0A%20%20%20%20%20%20%20%20.mark_rect()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22env_label%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Environment%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sort%3Dsort_order%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(labelAngle%3D0%2C%20labelLimit%3D180)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22racer_name%3AN%22%2C%20title%3D%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7Benv_metric_col%7D%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3Denv_metric_title%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%5BDeep%20Pink%2C%20Soft%20Pink%2C%20GREY%2C%20Soft%20Blue%2C%20Deep%20Blue%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20range%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%23AD1457%22%2C%20%20%23%20Deep%20Pink%20(New%2C%20for%20negative%20outliers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%23F06292%22%2C%20%20%23%20Your%20original%20Pink%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%233E3B45%22%2C%20%20%23%20Grey%20(Anchor%20at%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%2342A5F5%22%2C%20%20%23%20Your%20original%20Blue%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%230D47A1%22%2C%20%20%23%20Deep%20Blue%20(New%2C%20for%20positive%20outliers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domainMid%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20interpolate%3D%22rgb%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(format%3Denv_legend_fmt)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22cond_avg_vp%3AQ%22%2C%20format%3D%22.2f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22racer_global_avg_vp%3AQ%22%2C%20format%3D%22.2f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22absolute_shift%3AQ%22%2C%20format%3D%22%2B.2f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22relative_shift%3AQ%22%2C%20format%3D%22%2B.1%25%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22sample_size%3AQ%22%2C%20format%3D%22.0f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3Df%22Env%20Adaptability%20(%7Benv_metric_title%7D)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D%22container%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D680%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3DBG_COLOR%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%206.%20TABLES%20---%0A%20%20%20%20master_df%20%3D%20stats.sort(%22mean_vp%22%2C%20descending%3DTrue)%0A%20%20%20%20df_overview%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22mean_vp%22).round(2).alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22consistency_score%22)%20*%20100).round(1).alias(%22Consist%25%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22pct_1st%22)%20*%20100).round(1).alias(%221st%25%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22pct_2nd%22)%20*%20100).round(1).alias(%222nd%25%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22races_run%22).alias(%22%23%20Races%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_movement%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_speed_gross%22).round(2).alias(%22Speed%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_dice_base%22).round(2).alias(%22Base%20Roll%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22dice_dependency%22).round(2).alias(%22Dice%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22plus_minus_modified%22).round(2).alias(%22%2B-Modified%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_ability_move%22).round(2).alias(%22Ability%20Mvmt%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22ability_move_dependency%22).round(2).alias(%22Ability%20Move%20Dep%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_abilities%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_ability_move%22).round(2).alias(%22Ability%20Mvmt%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22triggers_per_turn%22).round(2).alias(%22Trig%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22self_per_turn%22).round(2).alias(%22Self%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22target_per_turn%22).round(2).alias(%22Tgt%2FTurn%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_dynamics%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_race_volatility%22).round(2).alias(%22Volatility%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_race_tightness%22).round(2).alias(%22Tightness%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_game_duration%22).round(1).alias(%22Avg%20Game%20Len%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_env_triggers%22).round(1).alias(%22Race%20Trigs%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22avg_env_trip_rate%22)%20*%20100).round(1).alias(%22Race%20Trip%25%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_vp%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22mean_vp%22).round(2).alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22dice_dependency%22).round(2).alias(%22Dice%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22ability_move_dependency%22).round(2).alias(%22Ability%20Move%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22start_pos_bias%22).round(2).alias(%22Start%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22midgame_bias%22).round(2).alias(%22MidGame%20Bias%22)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%207.%20UI%20COMPOSITION%20---%0A%20%20%20%20left_charts_ui%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8E%AF%20Consistency%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_consist.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**Stability**%3A%20Percentage%20of%20races%20where%20Final%20VP%20is%20within%20%C2%B11%20standard%20deviation%20(1%CF%83)%20of%20the%20racer's%20mean%20VP.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8E%B2%20Dice%20vs%20Ability%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_sources.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**X%3A%20Ability%20Move%20Dependency**%20%E2%80%93%20Correlation%20of%20non-dice%20movement%20(ability-driven%20positioning)%20to%20VP.%20%20%5Cn**Y%3A%20Dice%20Dependency**%20%E2%80%93%20Correlation%20of%20total%20dice%20rolled%20to%20VP.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8A%20Momentum%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_momentum.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**X%3A%20Start%20Pos%20Bias**%20%E2%80%93%20Correlation%20of%20starting%20position%20(racer%20ID)%20to%20VP.%20%20%5Cn**Y%3A%20Mid-Game%20Bias**%20%E2%80%93%20Correlation%20of%20position%20at%2066%25%20mark%20to%20VP.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%94%A5%20Excitement%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_excitement.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**Tightness**%20(X-axis%2C%20reversed)%3A%20Average%20distance%20from%20mean%20position%20across%20all%20turns.%20%20%5Cn**Volatility**%20(Y-axis)%3A%20Percentage%20of%20turns%20where%20at%20least%20one%20racer%20changes%20rank.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%A1%20Abilities%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_engine.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**X%3A%20Activity**%20%E2%80%93%20Average%20number%20of%20ability%20triggers%20per%20turn.%20%20%5Cn**Y%3A%20Efficacy**%20%E2%80%93%20Correlation%20between%20trigger%20count%20and%20Victory%20Points.%20%20%5Cn*Do%20more%20ability%20triggers%20mean%20more%20points%3F*%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8D%20Global%22%3A%20global_ui%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20)%0A%0A%20%20%20%20right_ui%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8F%86%20Overview%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_overview%2C%20selection%3DNone%2C%20page_size%3D50)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**Avg%20VP**%3A%20Mean%20victory%20points%20across%20all%20races.%5Cn**Consist%25**%3A%20Reliability.%5Cn**1st%25**%20%2F%20**2nd%25**%3A%20Win%20rate%20and%20runner-up%20rate.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%94%EF%B8%8F%20Interactions%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bmatchup_metric_toggle%2C%20mo.ui.altair_chart(c_matrix)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8D%20Environments%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bmatchup_metric_toggle%2C%20mo.ui.altair_chart(c_env)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8F%83%20Movement%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_movement%2C%20selection%3DNone%2C%20page_size%3D50)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22**Speed**%3A%20Average%20gross%20distance%20moved%20per%20turn.%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%92%8E%20VP%20Analysis%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_vp%2C%20selection%3DNone%2C%20page_size%3D50)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22**Start%20Bias**%3A%20Positive%20%3D%20comeback.%20Negative%20%3D%20frontrunner.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%A1%20Abilities%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_abilities%2C%20selection%3DNone%2C%20page_size%3D50)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22**Trig%2FTurn**%3A%20Average%20ability%20triggers%20per%20turn.%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%94%A5%20Dynamics%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_dynamics%2C%20selection%3DNone%2C%20page_size%3D50)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%22%22**Volatility**%3A%20Rank%20changes%20per%20turn.%22%22%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20)%0A%0A%20%20%20%20final_output%20%3D%20mo.md(f%22%22%22%0A%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-wrap%3A%20wrap%3B%20gap%3A%202rem%3B%20width%3A%20100%25%3B%20min-height%3A%20550px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22flex%3A%201%201%20450px%3B%20min-width%3A%200%3B%20display%3A%20flex%3B%20justify-content%3A%20center%3B%20align-items%3A%20start%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22width%3A%20100%25%3B%20display%3Aflex%3B%20flex-direction%3Acolumn%3B%20gap%3A%201rem%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Bleft_charts_ui%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22flex%3A%201%201%20400px%3B%20min-width%3A%200%3B%20overflow-x%3A%20auto%3B%22%3E%7Bright_ui%7D%3C%2Fdiv%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%22%22%22)%0A%20%20%20%20final_output%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "read",
            "version": "0.19.4",
            "serverToken": "unused",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": false, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"app_title": "Magical Athlete Simulator", "css_file": "docs/magical_athlete_analysis.css", "sql_output": "auto", "width": "full"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
