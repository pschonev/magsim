<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        const scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          const element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          const hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          const newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((_entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>Magical Athlete Simulator</title>
    <script type="module" crossorigin src="./assets/index-xckvhXGM.js"></script>
    <link rel="modulepreload" crossorigin href="./assets/preload-helper-reX6CfMN.js">
    <link rel="modulepreload" crossorigin href="./assets/clsx-nlQpVU_5.js">
    <link rel="modulepreload" crossorigin href="./assets/cn-BfqzeB_k.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-LvLJmgfZ.js">
    <link rel="modulepreload" crossorigin href="./assets/react-Bj1aDYRI.js">
    <link rel="modulepreload" crossorigin href="./assets/compiler-runtime-B3qBwwSJ.js">
    <link rel="modulepreload" crossorigin href="./assets/jsx-runtime-BttUhiRM.js">
    <link rel="modulepreload" crossorigin href="./assets/badge-Duqg7hNv.js">
    <link rel="modulepreload" crossorigin href="./assets/useEventListener-B3HCnU20.js">
    <link rel="modulepreload" crossorigin href="./assets/button-DOOm_ggu.js">
    <link rel="modulepreload" crossorigin href="./assets/react-dom-CSu739Rf.js">
    <link rel="modulepreload" crossorigin href="./assets/Combination-CdkqT4eF.js">
    <link rel="modulepreload" crossorigin href="./assets/menu-items-BrytomlJ.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-HoBrI5Oq.js">
    <link rel="modulepreload" crossorigin href="./assets/createLucideIcon-C5NDK5NL.js">
    <link rel="modulepreload" crossorigin href="./assets/check-CAiA4SIb.js">
    <link rel="modulepreload" crossorigin href="./assets/x-CvUjX6Qu.js">
    <link rel="modulepreload" crossorigin href="./assets/select-BvXsf3Xf.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-D13BIptq.js">
    <link rel="modulepreload" crossorigin href="./assets/use-toast-CAzHts2e.js">
    <link rel="modulepreload" crossorigin href="./assets/_Uint8Array-BGESiCQL.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseIsEqual-B9N9Mw_N.js">
    <link rel="modulepreload" crossorigin href="./assets/useEvent-BhXAndur.js">
    <link rel="modulepreload" crossorigin href="./assets/invariant-CAG_dYON.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFor-Duhs3RiJ.js">
    <link rel="modulepreload" crossorigin href="./assets/merge-BBX6ug-N.js">
    <link rel="modulepreload" crossorigin href="./assets/zod-H_cgTO0M.js">
    <link rel="modulepreload" crossorigin href="./assets/utils-Cul5vKXJ.js">
    <link rel="modulepreload" crossorigin href="./assets/Deferred-C3YDyEAR.js">
    <link rel="modulepreload" crossorigin href="./assets/uuid-BW_8PQB5.js">
    <link rel="modulepreload" crossorigin href="./assets/DeferredRequestRegistry-ODyALcIJ.js">
    <link rel="modulepreload" crossorigin href="./assets/constants-B6Cb__3x.js">
    <link rel="modulepreload" crossorigin href="./assets/session-BH_ggR75.js">
    <link rel="modulepreload" crossorigin href="./assets/config-BHy9GZrJ.js">
    <link rel="modulepreload" crossorigin href="./assets/requests-DqPjMMrg.js">
    <link rel="modulepreload" crossorigin href="./assets/isSymbol-BGkTcW3U.js">
    <link rel="modulepreload" crossorigin href="./assets/toString-DlRqgfqz.js">
    <link rel="modulepreload" crossorigin href="./assets/_hasUnicode-CWqKLxBC.js">
    <link rel="modulepreload" crossorigin href="./assets/assertNever-eF2N5g4Y.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayReduce-TT0iOGKY.js">
    <link rel="modulepreload" crossorigin href="./assets/useLifecycle-CKk7uG4E.js">
    <link rel="modulepreload" crossorigin href="./assets/useNonce-CGCAoh-I.js">
    <link rel="modulepreload" crossorigin href="./assets/useTheme-BHn95Ieq.js">
    <link rel="modulepreload" crossorigin href="./assets/once-BF7GI0Uf.js">
    <link rel="modulepreload" crossorigin href="./assets/capabilities-DTeDSdGM.js">
    <link rel="modulepreload" crossorigin href="./assets/createReducer-DhUZtGnB.js">
    <link rel="modulepreload" crossorigin href="./assets/paths-gUC_uwid.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-m6mzfYjs.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-DvlYinQM.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-D9xGHqiw.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Dw5p3QBM.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-ChjglRRU.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-DAxpo7DH.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Sapk1n6W.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Dq6dViu8.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Bsp55hDJ.js">
    <link rel="modulepreload" crossorigin href="./assets/stex-iJ-Q_35P.js">
    <link rel="modulepreload" crossorigin href="./assets/toDate-D_5B1mPf.js">
    <link rel="modulepreload" crossorigin href="./assets/cjs-BFk44HyO.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseProperty-NKyJO2oh.js">
    <link rel="modulepreload" crossorigin href="./assets/now-6sUe0ZdD.js">
    <link rel="modulepreload" crossorigin href="./assets/debounce-B3mjKxHe.js">
    <link rel="modulepreload" crossorigin href="./assets/toInteger-CDcO32Gx.js">
    <link rel="modulepreload" crossorigin href="./assets/database-zap-DjyjptVG.js">
    <link rel="modulepreload" crossorigin href="./assets/main-Drs5hZkn.js">
    <link rel="modulepreload" crossorigin href="./assets/cells-BvQJ_wGv.js">
    <link rel="modulepreload" crossorigin href="./assets/spinner-BBkRPIE-.js">
    <link rel="modulepreload" crossorigin href="./assets/chevron-right-Cez-Jqdk.js">
    <link rel="modulepreload" crossorigin href="./assets/dropdown-menu-BjqFXaqX.js">
    <link rel="modulepreload" crossorigin href="./assets/kbd-CxD_4JZI.js">
    <link rel="modulepreload" crossorigin href="./assets/renderShortcut-DpJiiIXp.js">
    <link rel="modulepreload" crossorigin href="./assets/multi-map-CfaU7is9.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-Djvdl92y.js">
    <link rel="modulepreload" crossorigin href="./assets/card-Cl7Rwjou.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-dialog-Btfo5nE7.js">
    <link rel="modulepreload" crossorigin href="./assets/dialog-BY1JTkTv.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Cka1pjxF.js">
    <link rel="modulepreload" crossorigin href="./assets/label-DjfzNSto.js">
    <link rel="modulepreload" crossorigin href="./assets/useDebounce-WGQaRdB8.js">
    <link rel="modulepreload" crossorigin href="./assets/textarea-DIGVRG-E.js">
    <link rel="modulepreload" crossorigin href="./assets/numbers-C8M1-yNT.js">
    <link rel="modulepreload" crossorigin href="./assets/SSRProvider-CkFAAHXw.js">
    <link rel="modulepreload" crossorigin href="./assets/context-DoXuYYBM.js">
    <link rel="modulepreload" crossorigin href="./assets/useNumberFormatter-DBQ_eVX1.js">
    <link rel="modulepreload" crossorigin href="./assets/usePress-a6K9HmSS.js">
    <link rel="modulepreload" crossorigin href="./assets/input-lGnR5jA2.js">
    <link rel="modulepreload" crossorigin href="./assets/links-BJkZcoxM.js">
    <link rel="modulepreload" crossorigin href="./assets/popover-Ds94yD5w.js">
    <link rel="modulepreload" crossorigin href="./assets/switch-C3e8vdXY.js">
    <link rel="modulepreload" crossorigin href="./assets/table-CP7epTk0.js">
    <link rel="modulepreload" crossorigin href="./assets/mode-COhtYT4e.js">
    <link rel="modulepreload" crossorigin href="./assets/useAsyncData-BwpzRwt1.js">
    <link rel="modulepreload" crossorigin href="./assets/errors-CZb6hI2x.js">
    <link rel="modulepreload" crossorigin href="./assets/error-banner-ClreFLcv.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-fZotD7fi.js">
    <link rel="modulepreload" crossorigin href="./assets/memoize-BCOZVFBt.js">
    <link rel="modulepreload" crossorigin href="./assets/get-6uJrSKbw.js">
    <link rel="modulepreload" crossorigin href="./assets/capitalize-O1rWkjI6.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-CmJTXGCp.js">
    <link rel="modulepreload" crossorigin href="./assets/plus-lLt9OnHP.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-cw-g2lXkmkk.js">
    <link rel="modulepreload" crossorigin href="./assets/trash-2-xM9f8S8N.js">
    <link rel="modulepreload" crossorigin href="./assets/triangle-alert-CEPiiwZT.js">
    <link rel="modulepreload" crossorigin href="./assets/ai-model-dropdown-BC0cdhi9.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-YxeC1tYk.js">
    <link rel="modulepreload" crossorigin href="./assets/precisionRound-CC3g-1mL.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-BgG6rTtO.js">
    <link rel="modulepreload" crossorigin href="./assets/vega-loader.browser-BR6dmQ_3.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-DuBjDOOi.js">
    <link rel="modulepreload" crossorigin href="./assets/ErrorBoundary-CL8ByR73.js">
    <link rel="modulepreload" crossorigin href="./assets/useInstallPackage-BPxx1pVW.js">
    <link rel="modulepreload" crossorigin href="./assets/ImperativeModal-BcWA2M3r.js">
    <link rel="modulepreload" crossorigin href="./assets/cell-link-HggHOhac.js">
    <link rel="modulepreload" crossorigin href="./assets/datasource-ow4Y3Yl7.js">
    <link rel="modulepreload" crossorigin href="./assets/state-D0hcaf71.js">
    <link rel="modulepreload" crossorigin href="./assets/MarimoErrorOutput-DDh0mN6J.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-icon-DQ4_WQe7.js">
    <link rel="modulepreload" crossorigin href="./assets/html-to-image-DvPYLUI8.js">
    <link rel="modulepreload" crossorigin href="./assets/focus-CPRFg4kn.js">
    <link rel="modulepreload" crossorigin href="./assets/LazyAnyLanguageCodeMirror-Bd0XX4es.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-5FQGJX7Z-BuHQ2zZJ.js">
    <link rel="modulepreload" crossorigin href="./assets/katex-bTFStUqL.js">
    <link rel="modulepreload" crossorigin href="./assets/markdown-renderer-Dyy86-0S.js">
    <link rel="modulepreload" crossorigin href="./assets/command-D2UvWA5R.js">
    <link rel="modulepreload" crossorigin href="./assets/download-FoG6dAm7.js">
    <link rel="modulepreload" crossorigin href="./assets/useRunCells-DCLlGGDx.js">
    <link rel="modulepreload" crossorigin href="./assets/purify.es-CPiHmTAE.js">
    <link rel="modulepreload" crossorigin href="./assets/RenderHTML-BtyszmRY.js">
    <link rel="modulepreload" crossorigin href="./assets/useIframeCapabilities-C-JfwMug.js">
    <link rel="modulepreload" crossorigin href="./assets/formats-DekCK0sB.js">
    <link rel="modulepreload" crossorigin href="./assets/en-US-DyCX-qVi.js">
    <link rel="modulepreload" crossorigin href="./assets/isValid-B3O42hgP.js">
    <link rel="modulepreload" crossorigin href="./assets/dates-CeHtKOEz.js">
    <link rel="modulepreload" crossorigin href="./assets/maps-BNf8B88H.js">
    <link rel="modulepreload" crossorigin href="./assets/extends-C9xCLRj9.js">
    <link rel="modulepreload" crossorigin href="./assets/emotion-is-prop-valid.esm-C4tLsq6-.js">
    <link rel="modulepreload" crossorigin href="./assets/useDateFormatter-D2wb2n1M.js">
    <link rel="modulepreload" crossorigin href="./assets/range-D2UKkEg-.js">
    <link rel="modulepreload" crossorigin href="./assets/table-CqXVb6os.js">
    <link rel="modulepreload" crossorigin href="./assets/JsonOutput-Cf8A51yY.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeleteCell-87_Oh8sv.js">
    <link rel="modulepreload" crossorigin href="./assets/icons-iU3GgPzu.js">
    <link rel="modulepreload" crossorigin href="./assets/process-output-WvCcApgB.js">
    <link rel="modulepreload" crossorigin href="./assets/blob-CTort_or.js">
    <link rel="modulepreload" crossorigin href="./assets/objectWithoutPropertiesLoose-B0M-wzEz.js">
    <link rel="modulepreload" crossorigin href="./assets/esm-CP9RsJ4O.js">
    <link rel="modulepreload" crossorigin href="./assets/file-BH6mbfdw.js">
    <link rel="modulepreload" crossorigin href="./assets/play-BqVslMWT.js">
    <link rel="modulepreload" crossorigin href="./assets/add-cell-with-ai-BCTdiv0p.js">
    <link rel="modulepreload" crossorigin href="./assets/isEmpty-CgX_-6Mt.js">
    <link rel="modulepreload" crossorigin href="./assets/bot-message-square-BNUYewXt.js">
    <link rel="modulepreload" crossorigin href="./assets/chat-display-Bvu3qbng.js">
    <link rel="modulepreload" crossorigin href="./assets/chart-no-axes-column-BXq2PuKd.js">
    <link rel="modulepreload" crossorigin href="./assets/square-function-anVqGjs0.js">
    <link rel="modulepreload" crossorigin href="./assets/spec-D4b3DLJL.js">
    <link rel="modulepreload" crossorigin href="./assets/column-preview-CJ3a0IPi.js">
    <link rel="modulepreload" crossorigin href="./assets/toggle-CUhRontP.js">
    <link rel="modulepreload" crossorigin href="./assets/globals-g_NWGBtF.js">
    <link rel="modulepreload" crossorigin href="./assets/share-ZGgmy4Y2.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSet-5Rdwpmr3.js">
    <link rel="modulepreload" crossorigin href="./assets/react-resizable-panels.browser.esm-DzNEmH2W.js">
    <link rel="modulepreload" crossorigin href="./assets/utilities.esm-C57m8aJQ.js">
    <link rel="modulepreload" crossorigin href="./assets/floating-outline-D3kzMiv3.js">
    <link rel="modulepreload" crossorigin href="./assets/useAddCell-DWpYLvcR.js">
    <link rel="modulepreload" crossorigin href="./assets/eye-off-D6Gma1GF.js">
    <link rel="modulepreload" crossorigin href="./assets/readonly-python-code-ZwGAfelJ.js">
    <link rel="modulepreload" crossorigin href="./assets/file-video-camera-o8CZtjRQ.js">
    <link rel="modulepreload" crossorigin href="./assets/types-B0GfsfZC.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-ccw-ClD7bKJN.js">
    <link rel="modulepreload" crossorigin href="./assets/form-DISpbGyw.js">
    <link rel="modulepreload" crossorigin href="./assets/field-0rGb7K7u.js">
    <link rel="modulepreload" crossorigin href="./assets/useBoolean-YzhJ5RKx.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeepCompareMemoize-BharaTWq.js">
    <link rel="modulepreload" crossorigin href="./assets/types-B02j-0zo.js">
    <link rel="modulepreload" crossorigin href="./assets/prop-types-dQH5VuL1.js">
    <link rel="modulepreload" crossorigin href="./assets/es-BAwLP160.js">
    <link rel="modulepreload" crossorigin href="./assets/hasIn-CycJImp8.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFlatten-CUZNxU8H.js">
    <link rel="modulepreload" crossorigin href="./assets/flatten-D-7VEN0q.js">
    <link rel="modulepreload" crossorigin href="./assets/pick-B_6Qi5aM.js">
    <link rel="modulepreload" crossorigin href="./assets/code-xml-CAMyACkU.js">
    <link rel="modulepreload" crossorigin href="./assets/download-Jiq5cuc9.js">
    <link rel="modulepreload" crossorigin href="./assets/square-H4PcQmi-.js">
    <link rel="modulepreload" crossorigin href="./assets/settings-CfA0GMiv.js">
    <link rel="modulepreload" crossorigin href="./assets/bundle.esm-CvMga-X6.js">
    <link rel="stylesheet" crossorigin href="./assets/cells-jmgGt1lS.css">
    <link rel="stylesheet" crossorigin href="./assets/markdown-renderer-DdDKmWlR.css">
    <link rel="stylesheet" crossorigin href="./assets/JsonOutput-B7vuddcd.css">
    <link rel="stylesheet" crossorigin href="./assets/index-DHVzmQ5n.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <style title='marimo-custom'>/* DARK BUTTONS */

/* Button Styling */
button,
.marimo-btn,
[role="button"] {
    /* Very dark grey, almost black */
    background-color: #222222 !important;
    
    /* Text Color */
    color: #e0e0e0 !important;
    
    /* Remove borders/outlines */
    border: white !important;
}

/* Hover State - Subtle Lift */
button:hover,
.marimo-btn:hover,
[role="button"]:hover {
    /* Slightly lighter on hover to show interactivity */
    background-color: #2d2d2d !important; 
    color: #ffffff !important;
}


/* 4. Active/Pressed State */
button:active,
.marimo-btn:active,
[role="button"]:active {
    background-color: #3d3d3d !important; /* Pure black on click */
}

/* 5. Disabled State */
button:disabled,
button[disabled] {
    background-color: #111111 !important;
    color: #444444 !important;
    cursor: not-allowed !important;
}
</style><marimo-code hidden="">%23%20%2F%2F%2F%20script%0A%23%20requires-python%20%3D%20%22%3E%3D3.14%22%0A%23%20dependencies%20%3D%20%5B%0A%23%20%20%20%20%20%22altair%3D%3D6.0.0%22%2C%0A%23%20%20%20%20%20%22marimo%3E%3D0.19.0%22%2C%0A%23%20%20%20%20%20%22polars%3D%3D1.36.1%22%2C%0A%23%20%20%20%20%20%22numpy%3E%3D2.4.1%22%0A%23%20%5D%0A%23%20%5Btool.marimo.display%5D%0A%23%20theme%20%3D%20%22dark%22%0A%23%20%2F%2F%2F%0A%0Aimport%20marimo%0A%0A__generated_with%20%3D%20%220.20.2%22%0Aapp%20%3D%20marimo.App(%0A%20%20%20%20width%3D%22full%22%2C%0A%20%20%20%20app_title%3D%22Magical%20Athlete%20Simulator%22%2C%0A%20%20%20%20css_file%3D%22docs%2Fmagical_athlete_analysis.css%22%2C%0A)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20sys%0A%0A%20%20%20%20print(sys.version)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Aasync%20def%20cell_import()%3A%0A%20%20%20%20from%20__future__%20import%20annotations%0A%0A%20%20%20%20import%20dataclasses%0A%20%20%20%20import%20logging%0A%20%20%20%20import%20math%0A%20%20%20%20import%20re%0A%20%20%20%20from%20typing%20import%20Any%2C%20Literal%2C%20get_args%0A%0A%20%20%20%20import%20altair%20as%20alt%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20micropip%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20from%20rich.console%20import%20Console%0A%20%20%20%20from%20rich.logging%20import%20RichHandler%0A%0A%20%20%20%20MAGSIM_VERSION%20%3D%20%221.0.0%22%0A%20%20%20%20await%20micropip.install(%0A%20%20%20%20%20%20%20%20f%22magsim%3D%3D%7BMAGSIM_VERSION%7D%22%2C%0A%20%20%20%20%20%20%20%20keep_going%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20from%20magsim.core.events%20import%20(%0A%20%20%20%20%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magsim.core.palettes%20import%20(%0A%20%20%20%20%20%20%20%20get_racer_color%2C%0A%20%20%20%20%20%20%20%20get_racer_palette%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magsim.core.types%20import%20RacerName%0A%20%20%20%20from%20magsim.engine.board%20import%20(%0A%20%20%20%20%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20%20%20%20%20TripTile%2C%0A%20%20%20%20%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magsim.engine.logging%20import%20(%0A%20%20%20%20%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Imports%0A%20%20%20%20from%20magsim.engine.scenario%20import%20GameScenario%2C%20RacerConfig%0A%20%20%20%20from%20magsim.simulation.telemetry%20import%20StepSnapshot%0A%20%20%20%20from%20magsim.simulation.config%20import%20GameConfig%0A%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Any%2C%0A%20%20%20%20%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20%20%20%20%20Console%2C%0A%20%20%20%20%20%20%20%20GameConfig%2C%0A%20%20%20%20%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20%20%20%20%20GameScenario%2C%0A%20%20%20%20%20%20%20%20Literal%2C%0A%20%20%20%20%20%20%20%20MAGSIM_VERSION%2C%0A%20%20%20%20%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20%20%20%20%20RacerConfig%2C%0A%20%20%20%20%20%20%20%20RacerName%2C%0A%20%20%20%20%20%20%20%20RichHandler%2C%0A%20%20%20%20%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20%20%20%20%20StepSnapshot%2C%0A%20%20%20%20%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20%20%20%20%20TripTile%2C%0A%20%20%20%20%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20%20%20%20%20alt%2C%0A%20%20%20%20%20%20%20%20dataclasses%2C%0A%20%20%20%20%20%20%20%20get_args%2C%0A%20%20%20%20%20%20%20%20get_racer_color%2C%0A%20%20%20%20%20%20%20%20get_racer_palette%2C%0A%20%20%20%20%20%20%20%20logging%2C%0A%20%20%20%20%20%20%20%20math%2C%0A%20%20%20%20%20%20%20%20mo%2C%0A%20%20%20%20%20%20%20%20np%2C%0A%20%20%20%20%20%20%20%20re%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_file_browser(mo)%3A%0A%20%20%20%20from%20pathlib%20import%20Path%0A%0A%20%20%20%20import%20polars%20as%20pl%0A%0A%20%20%20%20reload_data_btn%20%3D%20mo.ui.button(label%3D%22%E2%9F%B3%20Reload%20Data%22)%0A%0A%20%20%20%20%23%201.%20Get%20location%20and%20check%20type%0A%20%20%20%20notebook_loc%20%3D%20mo.notebook_location()%0A%20%20%20%20is_url%20%3D%20isinstance(notebook_loc%2C%20mo._runtime.runtime.URLPath)%0A%0A%20%20%20%20default_results_path%20%3D%20(%0A%20%20%20%20%20%20%20%20notebook_loc%20%2F%20%22results%22%20if%20is_url%20else%20notebook_loc%20%2F%20%22..%22%20%2F%20%22results%22%0A%20%20%20%20)%0A%0A%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20%23%20If%20running%20via%20URL%20(e.g.%20WASM)%2C%20we%20can't%20use%20a%20local%20file%20browser%0A%20%20%20%20%20%20%20%20results_folder_browser%20%3D%20None%0A%20%20%20%20%20%20%20%20print(f%22Running%20in%20URL%20mode.%20Base%3A%20%7Bdefault_results_path%7D%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%23%20If%20local%2C%20create%20the%20browser%0A%20%20%20%20%20%20%20%20%23%20Ensure%20we%20convert%20Path%20to%20string%20for%20the%20widget%0A%20%20%20%20%20%20%20%20results_folder_browser%20%3D%20mo.ui.file_browser(%0A%20%20%20%20%20%20%20%20%20%20%20%20selection_mode%3D%22directory%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22Select%20Results%20Folder%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20initial_path%3Dstr(default_results_path)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20print(f%22Running%20locally.%20Default%20results%20path%3A%20%7Bdefault_results_path%7D%22)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20Path%2C%0A%20%20%20%20%20%20%20%20default_results_path%2C%0A%20%20%20%20%20%20%20%20is_url%2C%0A%20%20%20%20%20%20%20%20pl%2C%0A%20%20%20%20%20%20%20%20reload_data_btn%2C%0A%20%20%20%20%20%20%20%20results_folder_browser%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_load_data(%0A%20%20%20%20Path%2C%0A%20%20%20%20default_results_path%2C%0A%20%20%20%20is_url%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20reload_data_btn%2C%0A%20%20%20%20results_folder_browser%2C%0A)%3A%0A%20%20%20%20reload_data_btn.value%0A%0A%20%20%20%20%23%201.%20Determine%20the%20Base%20Folder%0A%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20base_folder%20%3D%20default_results_path%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20if%20results_folder_browser.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20base_folder%20%3D%20Path(results_folder_browser.value%5B0%5D.path)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20base_folder%20%3D%20Path(%22results%22)%0A%0A%20%20%20%20%23%202.%20Construct%20Paths%20(Only%20need%20Races%20and%20Results%20now)%0A%20%20%20%20path_races%20%3D%20base_folder%20%2F%20%22races.parquet%22%0A%20%20%20%20path_res%20%3D%20base_folder%20%2F%20%22racer_results.parquet%22%0A%0A%20%20%20%20%23%203.%20Load%20Data%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20if%20not%20is_url%3A%20%20%23%20noqa%3A%20SIM102%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20Path(path_races).exists()%20or%20not%20Path(path_res).exists()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20FileNotFoundError(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Folder%20'%7Bbase_folder%7D'%20must%20contain%20'races.parquet'%20and%20'racer_results.parquet'%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20is_url%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20io%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20urllib.request%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_wasm_read_parquet(path%3A%20Path)%20-%3E%20pl.DataFrame%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20with%20urllib.request.urlopen(path)%20as%20response%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parquet_bytes%20%3D%20response.read()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20pl.read_parquet(io.BytesIO(parquet_bytes)%2C%20use_pyarrow%3DTrue)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results%20%3D%20_wasm_read_parquet(path_res)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races%20%3D%20_wasm_read_parquet(path_races)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results%20%3D%20pl.read_parquet(path_res)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races%20%3D%20pl.read_parquet(path_races)%0A%0A%20%20%20%20%20%20%20%20load_status%20%3D%20f%22%E2%9C%85%20Loaded%20from%3A%20%60%7Bbase_folder%7D%60%22%0A%0A%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20df_racer_results%20%3D%20pl.DataFrame()%0A%20%20%20%20%20%20%20%20df_races%20%3D%20pl.DataFrame()%0A%20%20%20%20%20%20%20%20load_status%20%3D%20f%22%E2%9D%8C%20Error%3A%20%7Be!s%7D%22%0A%20%20%20%20%20%20%20%20print(load_status)%0A%0A%20%20%20%20print(f%22df_races%3A%20%7Bdf_races.height%7D%20rows%2C%20columns%3A%20%7Bdf_races.columns%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22df_racer_results%3A%20%7Bdf_racer_results.height%7D%20rows%2C%20columns%3A%20%7Bdf_racer_results.columns%7D%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20df_racer_results%2C%20df_races%2C%20load_status%0A%0A%0A%40app.cell%0Adef%20cell_display_data(df_racer_results%2C%20df_races%2C%20mo%2C%20pl)%3A%0A%20%20%20%20import%20json%20%20%23%20Required%20for%20the%20WASM%20fix%0A%0A%20%20%20%20HASH_COL%20%3D%20%22config_hash%22%0A%0A%20%20%20%20%23%201.%20Get%20unique%20racers%20for%20column%20headers%0A%20%20%20%20unique_racers%20%3D%20sorted(df_racer_results.get_column(%22racer_name%22).unique().to_list())%0A%0A%20%20%20%20%23%202.%20FIX%20DATA%20TYPE%3A%20Decode%20JSON%20-%3E%20List%20(WASM%20Compatible)%0A%20%20%20%20df_races_clean%20%3D%20df_races.with_columns(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_names%22).cast(pl.List(pl.Utf8)).alias(%22racer_names%22)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%203.%20EXPAND%3A%20Create%20Display%20%26%20Boolean%20Columns%0A%20%20%20%20exprs%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%23%20Readable%20string%20for%20searching%0A%20%20%20%20%20%20%20%20pl.col(%22racer_names%22).list.join(%22%2C%20%22).alias(%22roster_display%22)%2C%0A%20%20%20%20%5D%0A%20%20%20%20for%20r%20in%20unique_racers%3A%0A%20%20%20%20%20%20%20%20exprs.append(pl.col(%22racer_names%22).list.contains(r).alias(f%22Has%20%7Br%7D%22))%0A%0A%20%20%20%20df_races_expanded%20%3D%20df_races_clean.with_columns(exprs)%0A%0A%20%20%20%20%23%204.%20DEFINE%20COLUMN%20GROUPS%0A%0A%20%20%20%20%23%20A.%20Priority%20Columns%20(Frozen%20on%20left)%0A%20%20%20%20priority_cols%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%22roster_display%22%2C%0A%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%22seed%22%2C%0A%20%20%20%20%20%20%20%20%22error_code%22%2C%0A%20%20%20%20%20%20%20%20%22total_turns%22%2C%0A%20%20%20%20%5D%0A%0A%20%20%20%20%23%20B.%20Matrix%20Columns%20(The%20boolean%20flags)%0A%20%20%20%20matrix_cols%20%3D%20%5Bf%22Has%20%7Br%7D%22%20for%20r%20in%20unique_racers%5D%0A%0A%20%20%20%20%23%20C.%20Columns%20to%20Hide%2FDrop%20explicitly%0A%20%20%20%20drop_cols%20%3D%20%5B%22timestamp%22%5D%20%20%23%20Redundant%20with%20created_at%0A%0A%20%20%20%20%23%20D.%20%22The%20Rest%22%20-%20Calculate%20dynamically%0A%20%20%20%20other_cols%20%3D%20%5B%0A%20%20%20%20%20%20%20%20c%0A%20%20%20%20%20%20%20%20for%20c%20in%20df_races_expanded.columns%0A%20%20%20%20%20%20%20%20if%20c%20not%20in%20priority_cols%20and%20c%20not%20in%20matrix_cols%20and%20c%20not%20in%20drop_cols%0A%20%20%20%20%5D%0A%0A%20%20%20%20racer_results_table%20%3D%20mo.ui.table(%0A%20%20%20%20%20%20%20%20df_racer_results.sort(%5B%22config_hash%22%2C%20%22racer_id%22%5D).select(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.all().exclude(HASH_COL)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(HASH_COL)%2C%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20selection%3D%22single%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20Results%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20races_table%20%3D%20mo.ui.table(%0A%20%20%20%20%20%20%20%20df_races_expanded.select(priority_cols%20%2B%20matrix_cols%20%2B%20other_cols)%2C%0A%20%20%20%20%20%20%20%20selection%3D%22single%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Races%20(Matrix%20View)%22%2C%0A%20%20%20%20%20%20%20%20freeze_columns_left%3Dpriority_cols%2C%0A%20%20%20%20)%0A%20%20%20%20return%20df_races_clean%2C%20racer_results_table%2C%20races_table%0A%0A%0A%40app.cell%0Adef%20cell_visual_setup(math)%3A%0A%20%20%20%20BG_COLOR%20%3D%20%22%23181c1a%22%0A%0A%20%20%20%20%23%20---%20CONSTANTS%3A%20BOARD%20THEME%20---%0A%20%20%20%20BOARD_THEME%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22background%22%3A%20BG_COLOR%2C%0A%20%20%20%20%20%20%20%20%22tile_1%22%3A%20%22%232d3432%22%2C%0A%20%20%20%20%20%20%20%20%22tile_2%22%3A%20%22%23363e3b%22%2C%0A%20%20%20%20%20%20%20%20%22stroke_default%22%3A%20%22%23555%22%2C%0A%20%20%20%20%20%20%20%20%22text_default%22%3A%20%22%23aaa%22%2C%0A%20%20%20%20%20%20%20%20%23%20Special%20Tiles%0A%20%20%20%20%20%20%20%20%22start_fill%22%3A%20%22%234CAF50%22%2C%0A%20%20%20%20%20%20%20%20%22start_text%22%3A%20%22%234CAF50%22%2C%0A%20%20%20%20%20%20%20%20%22start_stroke%22%3A%20%22%23D3D3D3%22%2C%20%20%23%20%5BNEW%5D%20Light%20Grey%0A%20%20%20%20%20%20%20%20%22goal_fill%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22goal_text%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22goal_stroke%22%3A%20%22%23C5A059%22%2C%20%20%23%20%5BNEW%5D%20Muted%20Golden%0A%20%20%20%20%20%20%20%20%22trip_fill%22%3A%20%22%23111111%22%2C%0A%20%20%20%20%20%20%20%20%22trip_text%22%3A%20%22%23F44336%22%2C%0A%20%20%20%20%20%20%20%20%22vp_fill%22%3A%20%22%2381D4FA%22%2C%0A%20%20%20%20%20%20%20%20%22vp_text%22%3A%20%22%23000000%22%2C%0A%20%20%20%20%20%20%20%20%22move_pos_fill%22%3A%20%22%23A5D6A7%22%2C%0A%20%20%20%20%20%20%20%20%22move_pos_text%22%3A%20%22%231B5E20%22%2C%0A%20%20%20%20%20%20%20%20%22move_neg_fill%22%3A%20%22%23EF9A9A%22%2C%0A%20%20%20%20%20%20%20%20%22move_neg_text%22%3A%20%22%23B71C1C%22%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20def%20generate_racetrack_positions(%0A%20%20%20%20%20%20%20%20num_spaces%2C%0A%20%20%20%20%20%20%20%20start_x%2C%0A%20%20%20%20%20%20%20%20start_y%2C%0A%20%20%20%20%20%20%20%20straight_len%2C%0A%20%20%20%20%20%20%20%20radius%2C%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Generates%20a%20Clockwise%20stadium%20track%20starting%20from%20the%20Top-Left%20straight.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20positions%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20perimeter%20%3D%20(2%20*%20straight_len)%20%2B%20(2%20*%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20step_distance%20%3D%20perimeter%20%2F%20num_spaces%0A%0A%20%20%20%20%20%20%20%20right_circle_cx%20%3D%20start_x%20%2B%20straight_len%0A%20%20%20%20%20%20%20%20right_circle_cy%20%3D%20start_y%20%2B%20radius%0A%20%20%20%20%20%20%20%20left_circle_cx%20%3D%20start_x%0A%20%20%20%20%20%20%20%20left_circle_cy%20%3D%20start_y%20%2B%20radius%0A%0A%20%20%20%20%20%20%20%20for%20i%20in%20range(num_spaces)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20dist%20%3D%20i%20*%20step_distance%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Top%20Straight%20(Moving%20Right)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20dist%20%3C%20straight_len%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20start_x%20%2B%20dist%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20start_y%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Right%20Curve%20(Moving%20Clockwise%2FDown)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20dist%20%3C%20(straight_len%20%2B%20math.pi%20*%20radius)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arc_dist%20%3D%20dist%20-%20straight_len%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fraction%20%3D%20arc_dist%20%2F%20(math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20theta%20%3D%20(-math.pi%20%2F%202)%20%2B%20(fraction%20*%20math.pi)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20right_circle_cx%20%2B%20radius%20*%20math.cos(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20right_circle_cy%20%2B%20radius%20*%20math.sin(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20math.degrees(theta)%20%2B%2090%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20Bottom%20Straight%20(Moving%20Left)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20dist%20%3C%20(2%20*%20straight_len%20%2B%20math.pi%20*%20radius)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20top_dist%20%3D%20dist%20-%20(straight_len%20%2B%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20(start_x%20%2B%20straight_len)%20-%20top_dist%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20start_y%20%2B%20(2%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20180%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Left%20Curve%20(Moving%20Clockwise%2FUp)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arc_dist%20%3D%20dist%20-%20(2%20*%20straight_len%20%2B%20math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fraction%20%3D%20arc_dist%20%2F%20(math.pi%20*%20radius)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20theta%20%3D%20(math.pi%20%2F%202)%20%2B%20(fraction%20*%20math.pi)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%20%3D%20left_circle_cx%20%2B%20radius%20*%20math.cos(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%20%3D%20left_circle_cy%20%2B%20radius%20*%20math.sin(theta)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20angle%20%3D%20math.degrees(theta)%20%2B%2090%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20positions.append((x%2C%20y%2C%20angle))%0A%0A%20%20%20%20%20%20%20%20return%20positions%0A%0A%20%20%20%20%23%20Constants%0A%20%20%20%20NUM_TILES%20%3D%2031%0A%20%20%20%20board_positions%20%3D%20generate_racetrack_positions(NUM_TILES%2C%20120%2C%20150%2C%20350%2C%20100)%0A%20%20%20%20return%20BG_COLOR%2C%20BOARD_THEME%2C%20board_positions%0A%0A%0A%40app.cell%0Adef%20cell_manage_state(mo)%3A%0A%20%20%20%20%23%20---%20PERSISTENCE%20STATE%20---%0A%20%20%20%20%23%20We%20only%20use%20this%20to%20remember%20values%20when%20the%20UI%20refreshes%20(Add%2FRemove).%0A%20%20%20%20get_selected_racers%2C%20set_selected_racers%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20%5B%22Magician%22%2C%20%22PartyAnimal%22%2C%20%22Egg%22%2C%20%22ThirdWheel%22%2C%20%22Leaptoad%22%2C%20%22Hypnotist%22%5D%2C%0A%20%20%20%20%20%20%20%20allow_self_loops%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20get_racer_to_add%2C%20set_racer_to_add%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20get_saved_positions%2C%20set_saved_positions%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Magician%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22PartyAnimal%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Egg%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22ThirdWheel%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Leaptoad%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Hypnotist%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20allow_self_loops%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20get_use_scripted_dice%2C%20set_use_scripted_dice%20%3D%20mo.state(%0A%20%20%20%20%20%20%20%20False%2C%0A%20%20%20%20%20%20%20%20allow_self_loops%3DFalse%2C%0A%20%20%20%20)%0A%20%20%20%20get_dice_rolls_text%2C%20set_dice_rolls_text%20%3D%20mo.state(%22%22%2C%20allow_self_loops%3DFalse)%0A%0A%20%20%20%20get_debug_mode%2C%20set_debug_mode%20%3D%20mo.state(False%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20%23%20---%20NEW%20STATES%20FOR%20CONFIG%20LOADING%20---%0A%20%20%20%20get_seed%2C%20set_seed%20%3D%20mo.state(42%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20get_board%2C%20set_board%20%3D%20mo.state(%22Standard%22%2C%20allow_self_loops%3DTrue)%0A%0A%20%20%20%20%23%20Track%20the%20last%20seen%20selection%20for%20EACH%20table%20to%20prevent%20fighting%2Floops%0A%20%20%20%20get_last_race_hash%2C%20set_last_race_hash%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20get_last_result_hash%2C%20set_last_result_hash%20%3D%20mo.state(None%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20get_board%2C%0A%20%20%20%20%20%20%20%20get_debug_mode%2C%0A%20%20%20%20%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20%20%20%20%20get_last_race_hash%2C%0A%20%20%20%20%20%20%20%20get_last_result_hash%2C%0A%20%20%20%20%20%20%20%20get_racer_to_add%2C%0A%20%20%20%20%20%20%20%20get_saved_positions%2C%0A%20%20%20%20%20%20%20%20get_seed%2C%0A%20%20%20%20%20%20%20%20get_selected_racers%2C%0A%20%20%20%20%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20%20%20%20%20set_board%2C%0A%20%20%20%20%20%20%20%20set_debug_mode%2C%0A%20%20%20%20%20%20%20%20set_dice_rolls_text%2C%0A%20%20%20%20%20%20%20%20set_last_race_hash%2C%0A%20%20%20%20%20%20%20%20set_last_result_hash%2C%0A%20%20%20%20%20%20%20%20set_racer_to_add%2C%0A%20%20%20%20%20%20%20%20set_saved_positions%2C%0A%20%20%20%20%20%20%20%20set_seed%2C%0A%20%20%20%20%20%20%20%20set_selected_racers%2C%0A%20%20%20%20%20%20%20%20set_use_scripted_dice%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_config_ui(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20GameConfig%2C%0A%20%20%20%20RacerName%2C%0A%20%20%20%20get_args%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20get_debug_mode%2C%0A%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20get_racer_to_add%2C%0A%20%20%20%20get_saved_positions%2C%0A%20%20%20%20get_seed%2C%0A%20%20%20%20get_selected_racers%2C%0A%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20set_board%2C%0A%20%20%20%20set_debug_mode%2C%0A%20%20%20%20set_dice_rolls_text%2C%0A%20%20%20%20set_racer_to_add%2C%0A%20%20%20%20set_saved_positions%2C%0A%20%20%20%20set_seed%2C%0A%20%20%20%20set_selected_racers%2C%0A%20%20%20%20set_step_idx%2C%0A%20%20%20%20set_use_scripted_dice%2C%0A)%3A%0A%20%20%20%20%23%20---%20UI%20DEFINITION%20---%0A%20%20%20%20AVAILABLE_RACERS%20%3D%20sorted(list(get_args(RacerName)))%0A%20%20%20%20current_roster%20%3D%20get_selected_racers()%0A%20%20%20%20saved_positions%20%3D%20get_saved_positions()%0A%0A%20%20%20%20%23%201.%20Main%20Controls%0A%20%20%20%20reset_button%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%9F%B3Reset%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(0)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20manual_change(setter%2C%20value)%3A%0A%20%20%20%20%20%20%20%20setter(value)%0A%20%20%20%20%20%20%20%20set_step_idx(0)%0A%20%20%20%20%20%20%20%20return%20value%0A%0A%20%20%20%20scenario_seed%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D10000%2C%0A%20%20%20%20%20%20%20%20value%3Dget_seed()%2C%0A%20%20%20%20%20%20%20%20label%3D%22Random%20Seed%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20manual_change(set_seed%2C%20v)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20board_selector%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Dsorted(list(BOARD_DEFINITIONS.keys()))%2C%0A%20%20%20%20%20%20%20%20value%3Dget_board()%2C%0A%20%20%20%20%20%20%20%20label%3D%22Board%20Map%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20manual_change(set_board%2C%20v)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20use_scripted_dice_ui%20%3D%20mo.ui.switch(%0A%20%20%20%20%20%20%20%20value%3Dget_use_scripted_dice()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20(set_use_scripted_dice(v)%2C%20set_step_idx(0))%5B1%5D%2C%0A%20%20%20%20%20%20%20%20label%3D%22Use%20scripted%20dice%22%2C%0A%20%20%20%20)%0A%20%20%20%20dice_rolls_text_ui%20%3D%20mo.ui.text(%0A%20%20%20%20%20%20%20%20value%3Dget_dice_rolls_text()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dlambda%20v%3A%20(set_dice_rolls_text(v)%2C%20set_step_idx(0))%5B1%5D%2C%0A%20%20%20%20%20%20%20%20label%3D%22Dice%20rolls%22%2C%0A%20%20%20%20%20%20%20%20placeholder%3D%22e.g.%204%2C5%2C6%22%2C%0A%20%20%20%20)%0A%20%20%20%20debug_mode_ui%20%3D%20mo.ui.switch(%0A%20%20%20%20%20%20%20%20value%3Dget_debug_mode()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dset_debug_mode%2C%0A%20%20%20%20%20%20%20%20label%3D%22Debug%20logging%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20NEW%3A%20Share%20%26%20Load%20Logic%20---%0A%20%20%20%20encoded_config_input%20%3D%20mo.ui.text(%0A%20%20%20%20%20%20%20%20label%3D%22Paste%20Encoded%20Config%22%2C%0A%20%20%20%20%20%20%20%20placeholder%3D%22eyJ...%22%2C%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20_on_load_click(_)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Parse%20encoded%20string%20using%20the%20existing%20class%20and%20update%20UI%20state.%22%22%22%0A%20%20%20%20%20%20%20%20val%20%3D%20encoded_config_input.value%0A%20%20%20%20%20%20%20%20if%20not%20val%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Decode%20using%20your%20existing%20Single%20Source%20of%20Truth%0A%20%20%20%20%20%20%20%20%20%20%20%20config%20%3D%20GameConfig.from_encoded(val)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Update%20the%20Shared%20State%20directly%0A%20%20%20%20%20%20%20%20%20%20%20%20set_seed(config.seed)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_board(config.board)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(list(config.racers))%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(dict.fromkeys(config.racers%2C%200))%0A%20%20%20%20%20%20%20%20%20%20%20%20set_use_scripted_dice(False)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%20%20%23%20Reset%20simulation%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20load_encoded_btn%20%3D%20mo.ui.button(label%3D%22Load%20Configuration%22%2C%20on_click%3D_on_load_click)%0A%0A%20%20%20%20%23%202.%20Position%20Inputs%20%26%20Logic%0A%20%20%20%20def%20_make_pos_on_change(racer_name)%3A%0A%20%20%20%20%20%20%20%20def%20_on_change(new_val)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%3D%20int(new_val)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(lambda%20cur%3A%20%7B**cur%2C%20racer_name%3A%20v%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%20%20%20%20return%20_on_change%0A%0A%20%20%20%20pos_widget_map%20%3D%20%7B%0A%20%20%20%20%20%20%20%20ui_racer%3A%20mo.ui.number(%0A%20%20%20%20%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stop%3D29%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20value%3Dint(saved_positions.get(ui_racer%2C%200))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_change%3D_make_pos_on_change(ui_racer)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20for%20ui_racer%20in%20current_roster%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%203.%20Snapshot%20Logic%0A%20%20%20%20def%20_snapshot_values(exclude%3DNone)%3A%0A%20%20%20%20%20%20%20%20return%20%7Br%3A%20w.value%20for%20r%2C%20w%20in%20pos_widget_map.items()%20if%20r%20!%3D%20exclude%7D%0A%0A%20%20%20%20%23%20---%20REORDERING%20LOGIC%20---%0A%20%20%20%20def%20move_racer(index%2C%20direction)%3A%0A%20%20%20%20%20%20%20%20def%20_move(_)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20roster%20%3D%20list(get_selected_racers())%0A%20%20%20%20%20%20%20%20%20%20%20%20new_index%20%3D%20index%20%2B%20direction%0A%20%20%20%20%20%20%20%20%20%20%20%20if%200%20%3C%3D%20new_index%20%3C%20len(roster)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20roster%5Bindex%5D%2C%20roster%5Bnew_index%5D%20%3D%20roster%5Bnew_index%5D%2C%20roster%5Bindex%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(roster)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%20%20%20%20return%20_move%0A%0A%20%20%20%20%23%204.%20Action%20Buttons%0A%20%20%20%20action_buttons%20%3D%20%7B%7D%0A%20%20%20%20for%20i%2C%20ui_racer%20in%20enumerate(current_roster)%3A%0A%20%20%20%20%20%20%20%20btn_remove%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%E2%9C%96%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%2C%20r%3Dui_racer%3A%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(_snapshot_values(exclude%3Dr))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(lambda%20cur%3A%20%5Bx%20for%20x%20in%20cur%20if%20x%20!%3D%20r%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20disabled%3D(len(current_roster)%20%3C%3D%201)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20btn_up%20%3D%20mo.ui.button(label%3D%22%E2%86%91%22%2C%20on_click%3Dmove_racer(i%2C%20-1)%2C%20disabled%3D(i%20%3D%3D%200))%0A%20%20%20%20%20%20%20%20btn_down%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3D%22%E2%86%93%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_click%3Dmove_racer(i%2C%201)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20disabled%3D(i%20%3D%3D%20len(current_roster)%20-%201)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20action_buttons%5Bui_racer%5D%20%3D%20(btn_remove%2C%20btn_up%2C%20btn_down)%0A%0A%20%20%20%20%23%205.%20Add%20Racer%20Logic%0A%20%20%20%20available_options%20%3D%20%5Br%20for%20r%20in%20AVAILABLE_RACERS%20if%20r%20not%20in%20current_roster%5D%0A%20%20%20%20add_racer_dropdown%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Davailable_options%2C%0A%20%20%20%20%20%20%20%20value%3Dget_racer_to_add()%2C%0A%20%20%20%20%20%20%20%20on_change%3Dset_racer_to_add%2C%0A%20%20%20%20%20%20%20%20label%3D%22Add%20racer%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20_add_racer(v)%3A%0A%20%20%20%20%20%20%20%20r%20%3D%20get_racer_to_add()%0A%20%20%20%20%20%20%20%20if%20r%20and%20r%20not%20in%20get_selected_racers()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_pos%20%3D%20_snapshot_values()%0A%20%20%20%20%20%20%20%20%20%20%20%20new_pos%5Br%5D%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20set_saved_positions(new_pos)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_selected_racers(lambda%20cur%3A%20cur%20%2B%20%5Br%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_racer_to_add(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(0)%0A%20%20%20%20%20%20%20%20return%20v%0A%0A%20%20%20%20add_button%20%3D%20mo.ui.button(label%3D%22Add%22%2C%20on_click%3D_add_racer)%0A%0A%20%20%20%20%23%206.%20Layout%20Table%0A%20%20%20%20table_rows%20%3D%20%5B%5D%0A%20%20%20%20for%20i%2C%20ui_racer%20in%20enumerate(current_roster)%3A%0A%20%20%20%20%20%20%20%20w_pos%20%3D%20pos_widget_map%5Bui_racer%5D%0A%20%20%20%20%20%20%20%20b_rem%2C%20b_up%2C%20b_down%20%3D%20action_buttons%5Bui_racer%5D%0A%20%20%20%20%20%20%20%20move_grp%20%3D%20mo.hstack(%5Bb_up%2C%20b_down%5D%2C%20justify%3D%22center%22%2C%20gap%3D0)%0A%20%20%20%20%20%20%20%20table_rows.append(f%22%7C%20%7Bi%20%2B%201%7D.%20%7Bui_racer%7D%20%7C%20%7Bw_pos%7D%20%7C%20%7Bmove_grp%7D%20%7C%20%7Bb_rem%7D%20%7C%22)%0A%0A%20%20%20%20racer_table%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%7C%20Racer%20%7C%20Start%20Pos%20%7C%20Order%20%7C%20Remove%20%7C%5Cn%22%0A%20%20%20%20%20%20%20%20%22%7C%20%3A---%20%7C%20%3A---%20%7C%20%3A---%3A%20%7C%20%3A---%3A%20%7C%5Cn%22%20%2B%20%22%5Cn%22.join(table_rows)%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20add_button%2C%0A%20%20%20%20%20%20%20%20add_racer_dropdown%2C%0A%20%20%20%20%20%20%20%20board_selector%2C%0A%20%20%20%20%20%20%20%20current_roster%2C%0A%20%20%20%20%20%20%20%20debug_mode_ui%2C%0A%20%20%20%20%20%20%20%20dice_rolls_text_ui%2C%0A%20%20%20%20%20%20%20%20encoded_config_input%2C%0A%20%20%20%20%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20%20%20%20%20racer_table%2C%0A%20%20%20%20%20%20%20%20reset_button%2C%0A%20%20%20%20%20%20%20%20scenario_seed%2C%0A%20%20%20%20%20%20%20%20use_scripted_dice_ui%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_share_widget(%0A%20%20%20%20GameConfig%2C%0A%20%20%20%20board_selector%2C%0A%20%20%20%20current_roster%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20scenario_seed%2C%0A)%3A%0A%20%20%20%20%23%20Generate%20string%20from%20current%20state%0A%20%20%20%20current_config_obj%20%3D%20GameConfig(%0A%20%20%20%20%20%20%20%20racers%3Dtuple(current_roster)%2C%0A%20%20%20%20%20%20%20%20board%3Dboard_selector.value%2C%0A%20%20%20%20%20%20%20%20seed%3Dscenario_seed.value%2C%0A%20%20%20%20)%0A%0A%20%20%20%20share_widget%20%3D%20mo.ui.text_area(%0A%20%20%20%20%20%20%20%20value%3Dcurrent_config_obj.encoded%2C%0A%20%20%20%20%20%20%20%20disabled%3DTrue%2C%20%20%23%20Read-only%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20%20%20%20%20rows%3D5%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(share_widget%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20add_button%2C%0A%20%20%20%20add_racer_dropdown%2C%0A%20%20%20%20board_selector%2C%0A%20%20%20%20debug_mode_ui%2C%0A%20%20%20%20dice_input%2C%0A%20%20%20%20encoded_config_input%2C%0A%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20racer_table%2C%0A%20%20%20%20reset_button%2C%0A%20%20%20%20results_tabs%2C%0A%20%20%20%20scenario_seed%2C%0A%20%20%20%20share_widget%2C%0A%20%20%20%20use_scripted_dice_ui%2C%0A)%3A%0A%20%20%20%20%23%20---%201.%20Left%20Column%20(Fixed%2FNarrower)%20---%0A%20%20%20%20%23%20We%20apply%20the%20style%20directly%20to%20this%20vstack%0A%20%20%20%20left_col%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%20Configure%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bscenario_seed%2C%20board_selector%2C%20reset_button%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.vstack(%5Buse_scripted_dice_ui%2C%20dice_input%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bdebug_mode_ui%5D%2C%20justify%3D%22start%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Racers%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20racer_table%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Badd_racer_dropdown%2C%20add_button%5D%2C%20justify%3D%22start%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20).style(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22flex%22%3A%20%221%201%20400px%22%2C%20%20%23%20Base%20width%20400px%0A%20%20%20%20%20%20%20%20%20%20%20%20%22max-width%22%3A%20%22400px%22%2C%20%20%23%20Cap%20width%20so%20it%20doesn't%20stretch%20on%20wide%20screens%0A%20%20%20%20%20%20%20%20%20%20%20%20%22min-width%22%3A%20%22300px%22%2C%20%20%23%20Minimum%20before%20it%20feels%20too%20squashed%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%202.%20Right%20Column%20(Greedy)%20---%0A%20%20%20%20%23%20We%20apply%20the%20greedy%20flex%20style%20here%0A%20%20%20%20right_col%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20results_tabs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22Enter%20encoded%20config%3A%20%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20encoded_config_input%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20load_encoded_btn%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22Copy%20encoded%20config%3A%20%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20share_widget%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20).style(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22flex%22%3A%20%22999%201%20500px%22%2C%20%20%23%20Massive%20grow%20factor%20(999)%20eats%20all%20remaining%20space%0A%20%20%20%20%20%20%20%20%20%20%20%20%22min-width%22%3A%20%220%22%2C%20%20%23%20Critical%20for%20scrolling%20tables%0A%20%20%20%20%20%20%20%20%20%20%20%20%22overflow-x%22%3A%20%22auto%22%2C%20%20%23%20Allow%20internal%20scrolling%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%203.%20Native%20Composition%20---%0A%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5Bleft_col%2C%20right_col%5D%2C%0A%20%20%20%20%20%20%20%20wrap%3DTrue%2C%20%20%23%20Native%20wrapping%20support%0A%20%20%20%20%20%20%20%20align%3D%22start%22%2C%20%20%23%20Aligns%20tops%20of%20columns%0A%20%20%20%20%20%20%20%20gap%3D2%2C%20%20%23%202rem%20gap%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_load_config(%0A%20%20%20%20df_races_clean%2C%0A%20%20%20%20get_last_race_hash%2C%0A%20%20%20%20get_last_result_hash%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20racer_results_table%2C%0A%20%20%20%20races_table%2C%0A%20%20%20%20set_board%2C%0A%20%20%20%20set_last_race_hash%2C%0A%20%20%20%20set_last_result_hash%2C%0A%20%20%20%20set_saved_positions%2C%0A%20%20%20%20set_seed%2C%0A%20%20%20%20set_selected_racers%2C%0A%20%20%20%20set_step_idx%2C%0A%20%20%20%20set_use_scripted_dice%2C%0A)%3A%0A%20%20%20%20%23%20---%20CONFIGURATION%20LOADER%20(Stable%20Version)%20---%0A%0A%20%20%20%20%23%201.%20Capture%20Current%20Table%20Selections%0A%20%20%20%20curr_race_hash%20%3D%20None%0A%20%20%20%20curr_race_row%20%3D%20None%0A%20%20%20%20if%20races_table.value%20is%20not%20None%20and%20races_table.value.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20curr_race_hash%20%3D%20races_table.value.item(0%2C%20%22config_hash%22)%0A%20%20%20%20%20%20%20%20curr_race_row%20%3D%20races_table.value.row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20curr_res_hash%20%3D%20None%0A%20%20%20%20if%20racer_results_table.value%20is%20not%20None%20and%20racer_results_table.value.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20curr_res_hash%20%3D%20racer_results_table.value.item(0%2C%20%22config_hash%22)%0A%0A%20%20%20%20%23%202.%20Get%20Last%20Known%20States%0A%20%20%20%20last_race%20%3D%20get_last_race_hash()%0A%20%20%20%20last_res%20%3D%20get_last_result_hash()%0A%0A%20%20%20%20%23%203.%20Detect%20Changes%20(Delta%20Check)%0A%20%20%20%20%23%20We%20only%20react%20if%20the%20current%20selection%20differs%20from%20the%20last%20recorded%20selection%20for%20that%20specific%20table.%0A%20%20%20%20race_changed%20%3D%20curr_race_hash%20is%20not%20None%20and%20curr_race_hash%20!%3D%20last_race%0A%20%20%20%20res_changed%20%3D%20curr_res_hash%20is%20not%20None%20and%20curr_res_hash%20!%3D%20last_res%0A%0A%20%20%20%20target_config%20%3D%20None%0A%0A%20%20%20%20%23%20Priority%3A%20Races%20Table%20%3E%20Results%20Table%0A%20%20%20%20%23%20But%20only%20if%20it%20actually%20changed!%0A%20%20%20%20if%20race_changed%3A%0A%20%20%20%20%20%20%20%20target_config%20%3D%20curr_race_row%0A%20%20%20%20elif%20res_changed%3A%0A%20%20%20%20%20%20%20%20%23%20Use%20the%20CLEANED%20races%20frame%20so%20racer_names%20is%20already%20a%20list%0A%20%20%20%20%20%20%20%20filtered%20%3D%20df_races_clean.filter(pl.col(%22config_hash%22)%20%3D%3D%20curr_res_hash)%0A%20%20%20%20%20%20%20%20if%20filtered.height%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20target_config%20%3D%20filtered.row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20%23%204.%20Apply%20Configuration%20(if%20any%20change%20detected)%0A%20%20%20%20if%20target_config%3A%0A%20%20%20%20%20%20%20%20raw_names%20%3D%20target_config.get(%22racer_names%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Now%20always%20expect%20a%20list%20from%20both%20paths%0A%20%20%20%20%20%20%20%20if%20isinstance(raw_names%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_roster%20%3D%20%5Bstr(n)%20for%20n%20in%20raw_names%5D%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20new_roster%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20new_seed%20%3D%20int(target_config.get(%22seed%22%2C%2042))%0A%20%20%20%20%20%20%20%20new_board%20%3D%20target_config.get(%22board%22%2C%20%22Standard%22)%0A%0A%20%20%20%20%20%20%20%20set_seed(new_seed)%0A%20%20%20%20%20%20%20%20set_board(new_board)%0A%20%20%20%20%20%20%20%20set_selected_racers(new_roster)%0A%20%20%20%20%20%20%20%20set_saved_positions(dict.fromkeys(new_roster%2C%200))%0A%20%20%20%20%20%20%20%20set_use_scripted_dice(False)%0A%20%20%20%20%20%20%20%20set_step_idx(0)%0A%0A%20%20%20%20%23%205.%20SYNC%20STATE%20(CRITICAL)%0A%20%20%20%20%23%20Always%20update%20the%20%22last%20seen%22%20hashes%20to%20match%20the%20current%20table%20values.%0A%20%20%20%20%23%20This%20prevents%20the%20%22other%22%20table%20from%20triggering%20a%20change%20in%20the%20next%20cycle%0A%20%20%20%20%23%20just%20because%20we%20ignored%20it%20this%20time.%0A%20%20%20%20if%20curr_race_hash%20!%3D%20last_race%3A%0A%20%20%20%20%20%20%20%20set_last_race_hash(curr_race_hash)%0A%0A%20%20%20%20if%20curr_res_hash%20!%3D%20last_res%3A%0A%20%20%20%20%20%20%20%20set_last_result_hash(curr_res_hash)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_dice_input(dice_rolls_text_ui%2C%20mo%2C%20use_scripted_dice_ui)%3A%0A%20%20%20%20dice_input%20%3D%20dice_rolls_text_ui%20if%20use_scripted_dice_ui.value%20else%20mo.Html(%22%22)%0A%20%20%20%20return%20(dice_input%2C)%0A%0A%0A%40app.cell%0Adef%20cell_display_config_ui(%0A%20%20%20%20MAGSIM_VERSION%2C%0A%20%20%20%20load_status%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20racer_results_table%2C%0A%20%20%20%20races_table%2C%0A%20%20%20%20reload_data_btn%2C%0A%20%20%20%20results_folder_browser%2C%0A)%3A%0A%20%20%20%20def%20_header()%3A%0A%20%20%20%20%20%20%20%20return%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bmo.md(f%22**v%7BMAGSIM_VERSION%7D**%22)%2C%20reload_data_btn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22end%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20results_tabs%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Racer%20Results%22%3A%20mo.vstack(%5B_header()%2C%20racer_results_table%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Races%22%3A%20mo.vstack(%5B_header()%2C%20races_table%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Source%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Data%20Directory%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Select%20the%20folder%20containing%20%60races.parquet%60%20and%20%60racer_results.parquet%60.%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bresults_folder_browser%2C%20reload_data_btn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.callout(mo.md(f%22Current%20Status%3A%20%7Bload_status%7D%22)%2C%20kind%3D%22neutral%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20).style(%7B%22width%22%3A%20%22100%25%22%2C%20%22min-height%22%3A%20%22400px%22%7D)%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(results_tabs%2C)%0A%0A%0A%40app.cell%0Adef%20cell_setup_log(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20Console%2C%0A%20%20%20%20GameLogHighlighter%2C%0A%20%20%20%20GameScenario%2C%0A%20%20%20%20MoveCmdEvent%2C%0A%20%20%20%20RacerConfig%2C%0A%20%20%20%20RichHandler%2C%0A%20%20%20%20RichMarkupFormatter%2C%0A%20%20%20%20StepSnapshot%2C%0A%20%20%20%20TripCmdEvent%2C%0A%20%20%20%20WarpCmdEvent%2C%0A%20%20%20%20current_roster%2C%0A%20%20%20%20dataclasses%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20get_debug_mode%2C%0A%20%20%20%20get_dice_rolls_text%2C%0A%20%20%20%20get_saved_positions%2C%0A%20%20%20%20get_seed%2C%0A%20%20%20%20get_use_scripted_dice%2C%0A%20%20%20%20logging%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20re%2C%0A%20%20%20%20reset_button%2C%0A)%3A%0A%20%20%20%20from%20magsim.simulation.telemetry%20import%20(%0A%20%20%20%20%20%20%20%20MetricsAggregator%2C%0A%20%20%20%20%20%20%20%20SnapshotPolicy%2C%0A%20%20%20%20%20%20%20%20SnapshotRecorder%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Reactivity%20triggers%0A%20%20%20%20reset_button.value%0A%20%20%20%20%23%20Use%20state%20getters%0A%20%20%20%20current_seed_val%20%3D%20get_seed()%0A%20%20%20%20current_board_val%20%3D%20get_board()%0A%0A%20%20%20%20get_saved_positions()%0A%20%20%20%20get_use_scripted_dice()%0A%20%20%20%20get_dice_rolls_text()%0A%0A%20%20%20%20log_console%20%3D%20Console(%0A%20%20%20%20%20%20%20%20record%3DTrue%2C%0A%20%20%20%20%20%20%20%20width%3D120%2C%0A%20%20%20%20%20%20%20%20force_terminal%3DTrue%2C%0A%20%20%20%20%20%20%20%20color_system%3D%22truecolor%22%2C%0A%20%20%20%20%20%20%20%20legacy_windows%3DFalse%2C%20%20%23%20Better%20rendering%0A%20%20%20%20)%0A%0A%20%20%20%20root_logger%20%3D%20logging.getLogger()%0A%20%20%20%20for%20h%20in%20root_logger.handlers%5B%3A%5D%3A%0A%20%20%20%20%20%20%20%20root_logger.removeHandler(h)%0A%0A%20%20%20%20log_handler%20%3D%20RichHandler(%0A%20%20%20%20%20%20%20%20console%3Dlog_console%2C%0A%20%20%20%20%20%20%20%20markup%3DTrue%2C%0A%20%20%20%20%20%20%20%20show_path%3DFalse%2C%0A%20%20%20%20%20%20%20%20show_time%3DFalse%2C%0A%20%20%20%20%20%20%20%20highlighter%3DGameLogHighlighter()%2C%0A%20%20%20%20)%0A%20%20%20%20log_handler.setFormatter(RichMarkupFormatter())%0A%20%20%20%20root_logger.addHandler(log_handler)%0A%20%20%20%20log_level%20%3D%20logging.DEBUG%20if%20get_debug_mode()%20else%20logging.INFO%0A%20%20%20%20root_logger.setLevel(log_level)%0A%0A%20%20%20%20dice_rolls%20%3D%20None%0A%20%20%20%20if%20get_use_scripted_dice()%3A%0A%20%20%20%20%20%20%20%20raw%20%3D%20get_dice_rolls_text().strip()%0A%20%20%20%20%20%20%20%20if%20raw%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dice_rolls%20%3D%20%5Bint(t)%20for%20t%20in%20re.split(r%22%5B%2C%5Cs%5D%2B%22%2C%20raw)%20if%20t%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20%23%20Updated%3A%20Use%20dynamic%20board%20and%20seed%0A%20%20%20%20scenario%20%3D%20GameScenario(%0A%20%20%20%20%20%20%20%20racers_config%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20RacerConfig(i%2C%20n%2C%20start_pos%3Dint(get_saved_positions().get(n%2C%200)))%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20n%20in%20enumerate(current_roster)%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20dice_rolls%3Ddice_rolls%2C%0A%20%20%20%20%20%20%20%20seed%3DNone%20if%20dice_rolls%20else%20current_seed_val%2C%0A%20%20%20%20%20%20%20%20board%3DBOARD_DEFINITIONS.get(current_board_val%2C%20BOARD_DEFINITIONS%5B%22Standard%22%5D)()%2C%0A%20%20%20%20)%0A%0A%20%20%20%20step_history%20%3D%20%5B%5D%0A%20%20%20%20turn_map%20%3D%20%7B%7D%0A%20%20%20%20SNAPSHOT_EVENTS%20%3D%20(MoveCmdEvent%2C%20WarpCmdEvent%2C%20TripCmdEvent)%0A%0A%20%20%20%20class%20RichLogSource%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20console)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self._console%20%3D%20console%0A%0A%20%20%20%20%20%20%20%20def%20export_text(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self._console.export_text(clear%3DFalse)%0A%0A%20%20%20%20%20%20%20%20def%20export_html(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self._console.export_html(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20clear%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20inline_styles%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20code_format%3D%22%7Bcode%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20policy%20%3D%20SnapshotPolicy(%0A%20%20%20%20%20%20%20%20snapshot_event_types%3DSNAPSHOT_EVENTS%2C%0A%20%20%20%20%20%20%20%20ensure_snapshot_each_turn%3DTrue%2C%0A%20%20%20%20%20%20%20%20fallback_event_name%3D%22TurnSkipped%2FRecovery%22%2C%0A%20%20%20%20%20%20%20%20snapshot_on_turn_end%3DFalse%2C%0A%20%20%20%20)%0A%0A%20%20%20%20snapshot_recorder%20%3D%20SnapshotRecorder(%0A%20%20%20%20%20%20%20%20policy%3Dpolicy%2C%0A%20%20%20%20%20%20%20%20log_source%3DRichLogSource(log_console)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20CHANGED%20BLOCK%20START%20---%0A%20%20%20%20metrics_aggregator%20%3D%20MetricsAggregator(config_hash%3D%22interactive-session%22)%0A%20%20%20%20metrics_aggregator.initialize_racers(scenario.engine)%0A%0A%20%20%20%20%23%20FIX%201%3A%20Start%20the%20counter%20at%201.%0A%20%20%20%20%23%20Turn%200%20is%20reserved%20for%20%22Board%20Setup%22.%20Turn%201%20is%20the%20first%20actual%20move.%0A%20%20%20%20sim_turn_counter%20%3D%20%7B%22current%22%3A%201%7D%0A%0A%20%20%20%20def%20on_event(engine%2C%20event)%3A%0A%20%20%20%20%20%20%20%20t_idx%20%3D%20sim_turn_counter%5B%22current%22%5D%0A%20%20%20%20%20%20%20%20snapshot_recorder.on_event(engine%2C%20event%2C%20turn_index%3Dt_idx)%0A%20%20%20%20%20%20%20%20metrics_aggregator.on_event(event%2C%20engine)%0A%0A%20%20%20%20if%20hasattr(scenario.engine%2C%20%22on_event_processed%22)%3A%0A%20%20%20%20%20%20%20%20scenario.engine.on_event_processed%20%3D%20on_event%0A%20%20%20%20%23%20---%20CHANGED%20BLOCK%20END%20---%0A%0A%20%20%20%20engine%20%3D%20scenario.engine%0A%0A%20%20%20%20%23%20FIX%202%3A%20Capture%20Initial%20State%20as%20Turn%200%0A%20%20%20%20snapshot_recorder.capture(engine%2C%20%22InitialState%22%2C%20turn_index%3D0)%0A%0A%20%20%20%20with%20mo.status.spinner(title%3D%22Simulating...%22)%3A%0A%20%20%20%20%20%20%20%20while%20engine.state.race_active%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20log_console.export_html(clear%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20t_idx%20%3D%20sim_turn_counter%5B%22current%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20actual_racer_idx%20%3D%20engine.state.current_racer_idx%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%20PREVIOUS%20BUG%20WAS%20HERE%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Removed%3A%20pre_turn_serial%20%3D%20engine.state.roll_state.serial_id%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20scenario.run_turn()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20post_turn_serial%20%3D%20engine.state.roll_state.serial_id%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20metrics_aggregator.on_turn_end(engine%2C%20turn_index%3Dt_idx)%0A%20%20%20%20%20%20%20%20%20%20%20%20snapshot_recorder.on_turn_end(engine%2C%20turn_index%3Dt_idx)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20last_snap%20%3D%20snapshot_recorder.step_history%5B-1%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fix%201%3A%20Ensure%20snapshot%20points%20to%20the%20actor%0A%20%20%20%20%20%20%20%20%20%20%20%20updates%20%3D%20%7B%22current_racer%22%3A%20actual_racer_idx%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Fix%202%3A%20%22Red%20X%22%20logic%20(CORRECTED)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20RollState%20resets%20to%20serial%200%20at%20the%20start%20of%20every%20turn.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20serial%20remains%200%20at%20the%20end%2C%20it%20means%20no%20roll%20logic%20was%20executed%20(Recovery%2FSkip).%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20t_idx%20%3E%200%20and%20post_turn_serial%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20updates%5B%22last_roll%22%5D%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fixed_snap%20%3D%20dataclasses.replace(last_snap%2C%20**updates)%0A%20%20%20%20%20%20%20%20%20%20%20%20snapshot_recorder.step_history%5B-1%5D%20%3D%20fixed_snap%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20sim_turn_counter%5B%22current%22%5D%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(snapshot_recorder.step_history)%20%3E%201000%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%0A%20%20%20%20step_history%3A%20list%5BStepSnapshot%5D%20%3D%20snapshot_recorder.step_history%0A%20%20%20%20turn_map%20%3D%20snapshot_recorder.turn_map%0A%0A%20%20%20%20info_md%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20f%22%E2%9C%85%20**Simulation%20complete!**%20%7Blen(current_roster)%7D%20racers%2C%20%7Bsim_turn_counter%5B'current'%5D%20-%201%7D%20turns%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20info_md%2C%20step_history%2C%20turn_map%0A%0A%0A%40app.cell%0Adef%20cell_show_simulation_info(info_md)%3A%0A%20%20%20%20info_md%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_update_step_state(mo)%3A%0A%20%20%20%20get_step_idx%2C%20set_step_idx%20%3D%20mo.state(0%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20return%20get_step_idx%2C%20set_step_idx%0A%0A%0A%40app.cell%0Adef%20cell_simulation_navigation(%0A%20%20%20%20get_step_idx%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20set_step_idx%2C%0A%20%20%20%20step_history%2C%0A%20%20%20%20turn_map%2C%0A)%3A%0A%20%20%20%20%23%20---%20NAVIGATION%20LOGIC%20---%0A%20%20%20%20current_step_idx%20%3D%20get_step_idx()%0A%0A%20%20%20%20if%20not%20step_history%3A%0A%20%20%20%20%20%20%20%20current_data%2C%20current_turn_idx%2C%20max_s%20%3D%20None%2C%200%2C%200%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20current_step_idx%20%3D%20min(max(0%2C%20current_step_idx)%2C%20len(step_history)%20-%201)%0A%20%20%20%20%20%20%20%20current_data%20%3D%20step_history%5Bcurrent_step_idx%5D%0A%20%20%20%20%20%20%20%20current_turn_idx%20%3D%20current_data.turn_index%0A%20%20%20%20%20%20%20%20max_s%20%3D%20len(step_history)%20-%201%0A%0A%20%20%20%20next_step_val%20%3D%20min(max_s%2C%20current_step_idx%20%2B%201)%0A%20%20%20%20prev_step_val%20%3D%20max(0%2C%20current_step_idx%20-%201)%0A%0A%20%20%20%20next_turn_target%20%3D%20current_turn_idx%20%2B%201%0A%20%20%20%20prev_turn_target%20%3D%20current_turn_idx%20-%201%0A%0A%20%20%20%20if%20next_turn_target%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20next_turn_step_val%20%3D%20turn_map%5Bnext_turn_target%5D%5B-1%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20next_turn_step_val%20%3D%20current_step_idx%0A%0A%20%20%20%20if%20prev_turn_target%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20prev_turn_step_val%20%3D%20turn_map%5Bprev_turn_target%5D%5B0%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20prev_turn_step_val%20%3D%200%0A%0A%20%20%20%20btn_prev_turn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%97%80%E2%97%80Turn%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(prev_turn_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_turn_idx%20%3C%3D%200)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_next_turn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22Turn%E2%96%B6%E2%96%B6%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(next_turn_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(next_turn_target%20not%20in%20turn_map)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_prev_step%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%E2%97%80%20Step%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(prev_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_step_idx%20%3C%3D%200)%2C%0A%20%20%20%20)%0A%20%20%20%20btn_next_step%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22Step%20%E2%96%B6%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20set_step_idx(next_step_val)%2C%0A%20%20%20%20%20%20%20%20disabled%3D(current_step_idx%20%3E%3D%20max_s)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20on_slider_change(v)%3A%0A%20%20%20%20%20%20%20%20if%20v%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20set_step_idx(turn_map%5Bv%5D%5B0%5D)%0A%0A%20%20%20%20nav_max_turn%20%3D%20max(turn_map.keys())%20if%20turn_map%20else%200%0A%20%20%20%20turn_slider%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D-1%2C%0A%20%20%20%20%20%20%20%20stop%3Dnav_max_turn%2C%0A%20%20%20%20%20%20%20%20value%3Dcurrent_turn_idx%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Turn%20Timeline%22%2C%0A%20%20%20%20%20%20%20%20on_change%3Don_slider_change%2C%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20btn_next_step%2C%0A%20%20%20%20%20%20%20%20btn_next_turn%2C%0A%20%20%20%20%20%20%20%20btn_prev_step%2C%0A%20%20%20%20%20%20%20%20btn_prev_turn%2C%0A%20%20%20%20%20%20%20%20current_data%2C%0A%20%20%20%20%20%20%20%20current_turn_idx%2C%0A%20%20%20%20%20%20%20%20turn_slider%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_display_simulation_nav(%0A%20%20%20%20Any%2C%0A%20%20%20%20Literal%2C%0A%20%20%20%20btn_next_step%2C%0A%20%20%20%20btn_next_turn%2C%0A%20%20%20%20btn_prev_step%2C%0A%20%20%20%20btn_prev_turn%2C%0A%20%20%20%20current_data%2C%0A%20%20%20%20current_turn_idx%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20step_history%2C%0A%20%20%20%20turn_slider%2C%0A)%3A%0A%20%20%20%20%23%20---%20NAV%20LAYOUT%20---%0A%20%20%20%20curr_step%3A%20Any%20%7C%20Literal%5B0%5D%20%3D%20current_data.global_step_index%20if%20current_data%20else%200%0A%20%20%20%20tot_steps%20%3D%20len(step_history)%20if%20step_history%20else%200%0A%0A%20%20%20%20status_text%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20f%22**Turn%20%7Bcurrent_turn_idx%7D**%20(Step%20%7Bcurr_step%20%2B%201%7D%2F%7Btot_steps%7D)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20nav_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bbtn_prev_turn%2C%20turn_slider%2C%20btn_next_turn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bbtn_prev_step%2C%20status_text%2C%20btn_next_step%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(nav_ui%2C)%0A%0A%0A%40app.cell%0Adef%20cell_log_viewer(%0A%20%20%20%20BG_COLOR%2C%0A%20%20%20%20current_data%2C%0A%20%20%20%20current_turn_idx%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20step_history%2C%0A%20%20%20%20turn_map%2C%0A)%3A%0A%20%20%20%20%23%20---%20LOG%20VIEWER%20---%0A%20%20%20%20if%20not%20current_data%3A%0A%20%20%20%20%20%20%20%20log_ui%20%3D%20mo.md(%22No%20logs%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20container_id%20%3D%20%22log-container-main%22%0A%20%20%20%20%20%20%20%20segments%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20log_max_turn%20%3D%20max(turn_map.keys())%0A%0A%20%20%20%20%20%20%20%20for%20t%20in%20range(log_max_turn%20%2B%201)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20t%20not%20in%20turn_map%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%20%20%20%20%20%20%20%20%20%20%20%20is_active%20%3D%20t%20%3D%3D%20current_turn_idx%0A%20%20%20%20%20%20%20%20%20%20%20%20end_of_turn_idx%20%3D%20turn_map%5Bt%5D%5B-1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20full_turn_log%20%3D%20step_history%5Bend_of_turn_idx%5D.log_html%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20is_active%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bg%2C%20border%2C%20opacity%20%3D%20%22%23181818%22%2C%20%22%2300FF00%22%2C%20%221.0%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lines%20%3D%20full_turn_log.split(%22%5Cn%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_line%20%3D%20current_data.log_line_index%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20safe_idx%20%3D%20min(len(lines)%2C%20target_line%20%2B%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lines.insert(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20safe_idx%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3Ared%3B%20font-size%3A10px%3B%20border-top%3A1px%20dashed%20red%3B%20margin-top%3A2px%3B%20margin-bottom%3A2px%3B%22%3E%E2%96%B2%20CURRENT%20STEP%3C%2Fdiv%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content_html%20%3D%20%22%3Cbr%3E%22.join(lines)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bg%2C%20border%2C%20opacity%20%3D%20BG_COLOR%2C%20%22%23333%22%2C%20%220.5%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content_html%20%3D%20full_turn_log.replace(%22%5Cn%22%2C%20%22%3Cbr%3E%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20segments.append(f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20id%3D%22turn-log-%7Bt%7D%22%20style%3D%22padding%3A4px%3B%20border-left%3A4px%20solid%20%7Bborder%7D%3B%20background%3A%7Bbg%7D%3B%20opacity%3A%7Bopacity%7D%3B%20border-bottom%3A1px%20solid%20%23333%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22font-size%3A9px%3B%20color%3A%23666%3B%20font-weight%3Abold%3B%22%3ETURN%20%7Bt%7D%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22rich-wrapper%22%3E%7Bcontent_html%7D%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22)%0A%0A%20%20%20%20%20%20%20%20full_html%20%3D%20%22%22.join(segments)%0A%20%20%20%20%20%20%20%20scroll_script%20%3D%20f%22%22%22%3Cscript%3Etry%20%7B%7Bconst%20p%20%3D%20window.parent.document%3B%20const%20c%20%3D%20p.getElementById(%22%7Bcontainer_id%7D%22)%3B%20const%20t%20%3D%20p.getElementById(%22turn-log-%7Bcurrent_turn_idx%7D%22)%3B%20if(c%20%26%26%20t)%20c.scrollTo(%7B%7Btop%3A%20t.offsetTop%20-%20c.offsetTop%20-%2020%2C%20behavior%3A%20'smooth'%7D%7D)%3B%7D%7D%20catch(e)%20%7B%7B%7D%7D%3C%2Fscript%3E%22%22%22%0A%0A%20%20%20%20%20%20%20%20log_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.Html(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%22%22%0A%20%20%20%20%20%20%3Cdiv%20id%3D%22%7Bcontainer_id%7D%22%20style%3D%22%0A%20%20%20%20height%3A%20750px%3B%0A%20%20%20%20overflow-y%3A%20auto%3B%0A%20%20%20%20background%3A%20%7BBG_COLOR%7D%3B%0A%20%20%20%20font-family%3A%20Menlo%2C%20Monaco%2C%20'Courier%20New'%2C%20monospace%3B%0A%20%20%20%20font-size%3A%2015px%3B%0A%20%20%20%20line-height%3A%201.3%3B%0A%20%20%20%20padding%3A%208px%3B%0A%20%20%20%20%20%20%22%3E%0A%20%20%20%20%7Bfull_html%7D%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%22%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.iframe(scroll_script%2C%20width%3D%220%22%2C%20height%3D%220%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(log_ui%2C)%0A%0A%0A%40app.cell%0Adef%20cell_show_simulation_section(%0A%20%20%20%20BOARD_DEFINITIONS%2C%0A%20%20%20%20board_positions%2C%0A%20%20%20%20current_data%2C%0A%20%20%20%20get_board%2C%0A%20%20%20%20log_ui%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20nav_ui%2C%0A%20%20%20%20render_game_track%2C%0A)%3A%0A%20%20%20%20%23%20---%20COMPOSITION%20---%0A%20%20%20%20if%20not%20current_data%3A%0A%20%20%20%20%20%20%20%20layout%20%3D%20mo.md(%22Waiting%20for%20simulation...%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20factory%20%3D%20BOARD_DEFINITIONS.get(get_board())%0A%20%20%20%20%20%20%20%20if%20not%20factory%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20factory%20%3D%20BOARD_DEFINITIONS%5B%22Standard%22%5D%0A%20%20%20%20%20%20%20%20board_instance%20%3D%20factory()%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Render%0A%20%20%20%20%20%20%20%20track_svg%20%3D%20mo.Html(%0A%20%20%20%20%20%20%20%20%20%20%20%20render_game_track(current_data%2C%20board_positions%2C%20board%3Dboard_instance)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20_left_col%20%3D%20mo.vstack(%5Btrack_svg%2C%20nav_ui%5D%2C%20align%3D%22center%22).style(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22flex%22%3A%20%221%201%20800px%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22min-width%22%3A%20%220%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20_right_col%20%3D%20log_ui.style(%7B%22flex%22%3A%20%221%201%20650px%22%2C%20%22min-width%22%3A%20%22650%22%7D)%0A%0A%20%20%20%20%20%20%20%20layout%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B_left_col%2C%20_right_col%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20wrap%3DTrue%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20layout%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_vsialize_track(%0A%20%20%20%20BOARD_THEME%2C%0A%20%20%20%20MoveDeltaTile%2C%0A%20%20%20%20StepSnapshot%2C%0A%20%20%20%20TripTile%2C%0A%20%20%20%20VictoryPointTile%2C%0A%20%20%20%20get_racer_palette%2C%0A%20%20%20%20math%2C%0A)%3A%0A%20%20%20%20def%20render_game_track(turn_data%3A%20StepSnapshot%2C%20positions_map%2C%20board%3DNone)%3A%0A%20%20%20%20%20%20%20%20import%20html%20as%20_html%0A%0A%20%20%20%20%20%20%20%20%23%20---%20VISUALIZATION%20CONSTANTS%20---%0A%20%20%20%20%20%20%20%20MAIN_RADIUS%20%3D%209.0%0A%20%20%20%20%20%20%20%20SECONDARY_RADIUS%20%3D%208.0%0A%20%20%20%20%20%20%20%20OUTLINE_WIDTH%20%3D%201.7%0A%20%20%20%20%20%20%20%20SECONDARY_WIDTH%20%3D%202%0A%20%20%20%20%20%20%20%20TEXT_STROKE_WIDTH%20%3D%20%224px%22%0A%0A%20%20%20%20%20%20%20%20if%20not%20turn_data%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22%3Cp%3ENo%20Data%3C%2Fp%3E%22%0A%0A%20%20%20%20%20%20%20%20svg_elements%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%23%20---%201.%20CANVAS%20CONFIGURATION%20(PATCHED)%20---%0A%20%20%20%20%20%20%20%20%23%20We%20define%20the%20%22logical%22%20size%20of%20the%20drawing%20area.%0A%20%20%20%20%20%20%20%20%23%20The%20viewBox%20will%20map%20these%20internal%20units%20to%20whatever%20size%20the%20screen%20allows.%0A%20%20%20%20%20%20%20%20LOGICAL_W%2C%20LOGICAL_H%20%3D%20950%2C%20400%0A%0A%20%20%20%20%20%20%20%20%23%20Transformation%20adjustments%20to%20center%20the%20track%20in%20the%20new%20tighter%20box%0A%20%20%20%20%20%20%20%20scale_factor%20%3D%201.45%0A%20%20%20%20%20%20%20%20trans_x%20%3D%2040%0A%20%20%20%20%20%20%20%20trans_y%20%3D%20-160%0A%20%20%20%20%20%20%20%20rw%2C%20rh%20%3D%2050%2C%2030%0A%0A%20%20%20%20%20%20%20%20%23%201.%20Track%20Groups%0A%20%20%20%20%20%20%20%20track_group_start%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20f'%3Cg%20transform%3D%22translate(%7Btrans_x%7D%2C%20%7Btrans_y%7D)%20scale(%7Bscale_factor%7D)%22%3E'%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Track%20Spaces%0A%20%20%20%20%20%20%20%20for%20i%2C%20(cx%2C%20cy%2C%20rot)%20in%20enumerate(positions_map)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20transform%20%3D%20f%22rotate(%7Brot%7D%2C%20%7Bcx%7D%2C%20%7Bcy%7D)%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%201.%20DEFAULT%20STYLES%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20is_start%20%3D%20i%20%3D%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20is_end%20%3D%20i%20%3D%3D%20len(positions_map)%20-%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(i%20%2F%2F%202)%20%25%202%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22tile_1%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22tile_2%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22stroke_default%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%222%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20str(i)%0A%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22text_default%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20font_weight%20%3D%20%22bold%22%0A%20%20%20%20%20%20%20%20%20%20%20%20font_size%20%3D%20%2210%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%202.%20SPECIAL%20TILE%20LOGIC%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20board%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mods%20%3D%20board.static_features.get(i%2C%20%5B%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20mod%20in%20mods%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(mod%2C%20VictoryPointTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22vp_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22VP%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22vp_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(mod%2C%20TripTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22trip_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22T%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22trip_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20font_size%20%3D%20%2216%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(mod%2C%20MoveDeltaTile)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20d%20%3D%20mod.delta%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20d%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22move_pos_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20f%22%2B%7Bd%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22move_pos_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20d%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill_color%20%3D%20BOARD_THEME%5B%22move_neg_fill%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20f%22%7Bd%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22move_neg_text%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%203.%20START%20%2F%20END%20OVERRIDES%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20is_start%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22start_stroke%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20text_content%20%3D%3D%20str(i)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22S%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22start_text%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20is_end%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_color%20%3D%20BOARD_THEME%5B%22goal_stroke%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke_width%20%3D%20%224%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20text_content%20%3D%3D%20str(i)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_content%20%3D%20%22G%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_fill%20%3D%20BOARD_THEME%5B%22goal_text%22%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Crect%20x%3D%22%7Bcx%20-%20rw%20%2F%202%3A.1f%7D%22%20y%3D%22%7Bcy%20-%20rh%20%2F%202%3A.1f%7D%22%20width%3D%22%7Brw%7D%22%20height%3D%22%7Brh%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'fill%3D%22%7Bfill_color%7D%22%20stroke%3D%22%7Bstroke_color%7D%22%20stroke-width%3D%22%7Bstroke_width%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'transform%3D%22%7Btransform%7D%22%20rx%3D%224%22%20%2F%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcx%3A.1f%7D%22%20y%3D%22%7Bcy%3A.1f%7D%22%20dy%3D%224%22%20font-family%3D%22sans-serif%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'font-size%3D%22%7Bfont_size%7D%22%20font-weight%3D%22%7Bfont_weight%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'text-anchor%3D%22middle%22%20fill%3D%22%7Btext_fill%7D%22%20transform%3D%22%7Btransform%7D%22%3E%7Btext_content%7D%3C%2Ftext%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Racers%0A%20%20%20%20%20%20%20%20occupancy%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20for%20idx%2C%20pos%20in%20enumerate(turn_data.positions)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20pos%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%20%20%20%20%20%20%20%20%20%20%20%20draw_pos%20%3D%20min(pos%2C%20len(positions_map)%20-%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20name%20%3D%20turn_data.names%5Bidx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20palette%20%3D%20get_racer_palette(name)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mods%20%3D%20turn_data.modifiers%0A%20%20%20%20%20%20%20%20%20%20%20%20abils%20%3D%20turn_data.abilities%0A%20%20%20%20%20%20%20%20%20%20%20%20mod_str%20%3D%20str(mods%5Bidx%5D)%20if%20idx%20%3C%20len(mods)%20else%20%22%5B%5D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20abil_str%20%3D%20str(abils%5Bidx%5D)%20if%20idx%20%3C%20len(abils)%20else%20%22%5B%5D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip_text%20%3D%20f%22%7Bname%7D%20(ID%3A%20%7Bidx%7D)%5CnVP%3A%20%7Bturn_data.vp%5Bidx%5D%7D%5CnTripped%3A%20%7Bturn_data.tripped%5Bidx%5D%7D%5CnAbils%3A%20%7Babil_str%7D%5CnMods%3A%20%7Bmod_str%7D%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20occupancy.setdefault(draw_pos%2C%20%5B%5D).append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22palette%22%3A%20palette%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22is_current%22%3A%20(idx%20%3D%3D%20turn_data.current_racer)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tripped%22%3A%20turn_data.tripped%5Bidx%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tooltip%22%3A%20tooltip_text%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Render%20Racers%0A%20%20%20%20%20%20%20%20for%20space_idx%2C%20racers_here%20in%20occupancy.items()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20bx%2C%20by%2C%20brot%20%3D%20positions_map%5Bspace_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20count%20%3D%20len(racers_here)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20count%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(0%2C%200)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20count%20%3D%3D%202%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%200)%2C%20(15%2C%200)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20count%20%3D%3D%203%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%20-8)%2C%20(15%2C%20-8)%2C%20(0%2C%208)%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20offsets%20%3D%20%5B(-15%2C%20-8)%2C%20(15%2C%20-8)%2C%20(-15%2C%208)%2C%20(15%2C%208)%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20racer%20in%20enumerate(racers_here)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20i%20%3E%3D%20len(offsets)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ox%2C%20oy%20%3D%20offsets%5Bi%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rad%20%3D%20math.radians(brot)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cx%20%3D%20bx%20%2B%20(ox%20*%20math.cos(rad)%20-%20oy%20*%20math.sin(rad))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cy%20%3D%20by%20%2B%20(ox%20*%20math.sin(rad)%20%2B%20oy%20*%20math.cos(rad))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_dx%20%3D%20cx%20-%20bx%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_dy%20%3D%20cy%20-%20by%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22middle%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%2024%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ty%20%3D%20cy%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20count%20%3E%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20abs(vis_dy)%20%3E%20abs(vis_dx)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20vis_dy%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%20-14%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%2024%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dy_text%20%3D%205%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20vis_dx%20%3C%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22end%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%20-%2014%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text_anchor%20%3D%20%22start%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tx%20%3D%20cx%20%2B%2014%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pal%20%3D%20racer%5B%22palette%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stroke%20%3D%20pal.outline%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%22%3Cg%3E%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(f%22%3Ctitle%3E%7B_html.escape(racer%5B'tooltip'%5D)%7D%3C%2Ftitle%3E%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ccircle%20cx%3D%22%7Bcx%7D%22%20cy%3D%22%7Bcy%7D%22%20r%3D%22%7BMAIN_RADIUS%7D%22%20fill%3D%22%7Bpal.primary%7D%22%20stroke%3D%22%7Bstroke%7D%22%20stroke-width%3D%22%7BOUTLINE_WIDTH%7D%22%20%2F%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20pal.secondary%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ccircle%20cx%3D%22%7Bcx%7D%22%20cy%3D%22%7Bcy%7D%22%20r%3D%22%7BSECONDARY_RADIUS%7D%22%20fill%3D%22none%22%20stroke%3D%22%7Bpal.secondary%7D%22%20stroke-width%3D%22%7BSECONDARY_WIDTH%7D%22%20%2F%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Btx%7D%22%20y%3D%22%7Bty%7D%22%20dy%3D%22%7Bdy_text%7D%22%20font-family%3D%22sans-serif%22%20font-size%3D%2213%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'font-weight%3D%22900%22%20text-anchor%3D%22%7Btext_anchor%7D%22%20fill%3D%22%7Bpal.primary%7D%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'style%3D%22paint-order%3A%20stroke%3B%20stroke%3A%20%23000%3B%20stroke-width%3A%20%7BTEXT_STROKE_WIDTH%7D%3B%22%3E'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7B_html.escape(racer%5B'name'%5D)%7D%3C%2Ftext%3E%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20racer%5B%22tripped%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcx%7D%22%20y%3D%22%7Bcy%7D%22%20dy%3D%225%22%20fill%3D%22%23ff0000%22%20font-weight%3D%22bold%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%3EX%3C%2Ftext%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%22%3C%2Fg%3E%22)%0A%0A%20%20%20%20%20%20%20%20svg_elements.append(%22%3C%2Fg%3E%22)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Center%20Display%0A%20%20%20%20%20%20%20%20%23%20Adjust%20center%20calculation%20for%20new%20LOGICAL%20dimensions%20if%20necessary%2C%0A%20%20%20%20%20%20%20%20%23%20but%20since%20trans_x%2Fscale_factor%20handle%20the%20track%2C%20we%20keep%20this%20relative%20to%20the%20track%20group%0A%20%20%20%20%20%20%20%20center_x%20%3D%20(100%20%2B%20500)%20%2F%202%20*%20scale_factor%20%2B%20trans_x%0A%20%20%20%20%20%20%20%20center_y%20%3D%20(350%20-%20100)%20*%20scale_factor%20%2B%20trans_y%0A%0A%20%20%20%20%20%20%20%20active_idx%20%3D%20turn_data.current_racer%0A%20%20%20%20%20%20%20%20active_name%20%3D%20turn_data.names%5Bactive_idx%5D%0A%20%20%20%20%20%20%20%20active_pal%20%3D%20get_racer_palette(active_name)%0A%20%20%20%20%20%20%20%20roll%3A%20int%20%7C%20None%20%3D%20turn_data.last_roll%0A%0A%20%20%20%20%20%20%20%20%23%20Active%20Racer%20Name%0A%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20-%2015%7D%22%20font-size%3D%2228%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%7Bactive_pal.primary%7D%22%20style%3D%22paint-order%3A%20stroke%3B%20stroke%3A%20%7Bactive_pal.outline%7D%3B%20stroke-width%3A%202px%3B%20filter%3A%20drop-shadow(0px%200px%202px%20black)%3B%22%3E%7B_html.escape(active_name)%7D%3C%2Ftext%3E'%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20roll%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20%2B%2035%7D%22%20font-size%3D%2240%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%23eee%22%20%3E%F0%9F%8E%B2%20%7Broll%7D%3C%2Ftext%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20elif%20turn_data.skipped_roll%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20svg_elements.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f'%3Ctext%20x%3D%22%7Bcenter_x%7D%22%20y%3D%22%7Bcenter_y%20%2B%2035%7D%22%20font-size%3D%2260%22%20font-weight%3D%22bold%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ff0000%22%20%3EX%3C%2Ftext%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20RETURN%20SVG%20(PATCHED)%20---%0A%20%20%20%20%20%20%20%20%23%20Using%20viewBox%20allows%20the%20SVG%20to%20scale.%0A%20%20%20%20%20%20%20%20%23%20width%3D%22100%25%22%20means%20it%20fills%20the%20container.%20height%3D%22auto%22%20maintains%20aspect%20ratio.%0A%20%20%20%20%20%20%20%20return%20f%22%22%22%3Csvg%20viewBox%3D%220%200%20%7BLOGICAL_W%7D%20%7BLOGICAL_H%7D%22%20width%3D%22100%25%22%20height%3D%22auto%22%20preserveAspectRatio%3D%22xMidYMid%20meet%22%20style%3D%22background%3A%7BBOARD_THEME%5B%22background%22%5D%7D%3B%20max-width%3A%20100%25%3B%22%3E%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Btrack_group_start%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%22%22.join(svg_elements)%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fsvg%3E%22%22%22%0A%0A%20%20%20%20return%20(render_game_track%2C)%0A%0A%0A%40app.cell%0Adef%20cell_filter_autoracers()%3A%0A%20%20%20%20from%20magsim.core.agent%20import%20(%0A%20%20%20%20%20%20%20%20BooleanInteractive%2C%0A%20%20%20%20%20%20%20%20SelectionInteractive%2C%0A%20%20%20%20)%0A%20%20%20%20from%20magsim.core.registry%20import%20RACER_ABILITIES%0A%20%20%20%20from%20magsim.racers%20import%20get_ability_classes%0A%0A%20%20%20%20ability_classes%20%3D%20get_ability_classes()%0A%0A%20%20%20%20%23%20Filter%3A%20Keep%20racer%20if%20NONE%20of%20their%20abilities%20are%20interactive%0A%20%20%20%20%23%20This%20checks%20if%20the%20racer%20class%20implements%20the%20interactive%20protocols%0A%20%20%20%20automatic_racers_list%20%3D%20%5B%0A%20%20%20%20%20%20%20%20racer%0A%20%20%20%20%20%20%20%20for%20racer%2C%20abilities%20in%20RACER_ABILITIES.items()%0A%20%20%20%20%20%20%20%20if%20not%20any(%0A%20%20%20%20%20%20%20%20%20%20%20%20issubclass(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ability_classes.get(a)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(BooleanInteractive%2C%20SelectionInteractive)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20a%20in%20abilities%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20ability_classes.get(a)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%5D%0A%20%20%20%20return%20(automatic_racers_list%2C)%0A%0A%0A%40app.cell%0Adef%20cell_manage_config_state(mo)%3A%0A%20%20%20%20%23%20last_run_config%20starts%20as%20None.%0A%20%20%20%20%23%20It%20only%20updates%20when%20%22Run%20Analysis%22%20is%20clicked.%0A%20%20%20%20last_run_config%2C%20set_last_run_config%20%3D%20mo.state(None)%0A%20%20%20%20return%20last_run_config%2C%20set_last_run_config%0A%0A%0A%40app.cell%0Adef%20cell_combo_filter_state(mo)%3A%0A%20%20%20%20%23%20Stores%20list%20of%20dicts%3A%20%7B%22racers%22%3A%20%5B%22Racer%20A%22%2C%20%22Racer%20B%22%5D%2C%20%22type%22%3A%20%22Include%22%2C%20%22id%22%3A%20...%7D%0A%20%20%20%20get_combo_filters%2C%20set_combo_filters%20%3D%20mo.state(%5B%5D%2C%20allow_self_loops%3DTrue)%0A%20%20%20%20return%20get_combo_filters%2C%20set_combo_filters%0A%0A%0A%40app.cell%0Adef%20cell_combo_filter_ui(%0A%20%20%20%20df_races_clean%2C%0A%20%20%20%20get_combo_filters%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20set_combo_filters%2C%0A)%3A%0A%20%20%20%20%23%20Get%20unique%20racers%20from%20the%20clean%20dataframe%20for%20the%20dropdown%20options%0A%20%20%20%20%23%20We%20assume%20'racer_names'%20is%20a%20list%20column%20in%20df_races_clean%0A%20%20%20%20_unique_racers%20%3D%20sorted(%0A%20%20%20%20%20%20%20%20%7Br%20for%20sublist%20in%20df_races_clean%5B%22racer_names%22%5D.to_list()%20for%20r%20in%20sublist%7D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20combo_racer_select%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3D_unique_racers%2C%0A%20%20%20%20%20%20%20%20label%3D%22Select%20Racers%20for%20Combo%22%2C%0A%20%20%20%20%20%20%20%20full_width%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20combo_type_select%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3D%5B%22Must%20Include%20All%22%2C%20%22Must%20Exclude%20Combination%22%5D%2C%0A%20%20%20%20%20%20%20%20value%3D%22Must%20Include%20All%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Filter%20Type%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20add_combo_filter()%3A%0A%20%20%20%20%20%20%20%20if%20not%20combo_racer_select.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%0A%20%20%20%20%20%20%20%20current%20%3D%20get_combo_filters()%0A%20%20%20%20%20%20%20%20new_filter%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22racers%22%3A%20sorted(list(combo_racer_select.value))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22type%22%3A%20combo_type_select.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22id%22%3A%20str(len(current))%20%2B%20%22_%22%20%2B%20str(hash(str(combo_racer_select.value)))%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%23%20Prevent%20duplicates%0A%20%20%20%20%20%20%20%20for%20_f%20in%20current%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_f%5B%22racers%22%5D%20%3D%3D%20new_filter%5B%22racers%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20and%20_f%5B%22type%22%5D%20%3D%3D%20new_filter%5B%22type%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%0A%0A%20%20%20%20%20%20%20%20set_combo_filters(current%20%2B%20%5Bnew_filter%5D)%0A%0A%20%20%20%20add_combo_btn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22Add%20Combo%20Filter%22%2C%0A%20%20%20%20%20%20%20%20on_click%3Dlambda%20_%3A%20add_combo_filter()%2C%0A%20%20%20%20%20%20%20%20kind%3D%22neutral%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20combo_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bcombo_type_select%2C%20combo_racer_select%2C%20add_combo_btn%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22end%22%2C%20%20%23%20Aligns%20items%20vertically%20to%20bottom%20(so%20button%20lines%20up%20with%20inputs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%20%20%23%20Aligns%20items%20horizontally%20to%20the%20left%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20align%3D%22start%22%2C%20%20%23%20Aligns%20the%20whole%20stack%20to%20the%20left%0A%20%20%20%20)%0A%20%20%20%20return%20(combo_ui%2C)%0A%0A%0A%40app.cell%0Adef%20cell_combo_filter_display(get_combo_filters%2C%20mo%2C%20set_combo_filters)%3A%0A%20%20%20%20import%20functools%0A%0A%20%20%20%20%23%201.%20Define%20Remove%20Handler%0A%20%20%20%20def%20_remove_id(target_id)%3A%0A%20%20%20%20%20%20%20%20current%20%3D%20get_combo_filters()%0A%20%20%20%20%20%20%20%20%23%20Filter%20by%20ID%20(robust%20string%20comparison)%0A%20%20%20%20%20%20%20%20new_list%20%3D%20%5Bc%20for%20c%20in%20current%20if%20str(c%5B%22id%22%5D)%20!%3D%20str(target_id)%5D%0A%20%20%20%20%20%20%20%20set_combo_filters(new_list)%0A%0A%20%20%20%20%23%202.%20Render%20Buttons%20from%20State%0A%20%20%20%20current_filters%20%3D%20get_combo_filters()%0A%20%20%20%20filter_buttons%20%3D%20%5B%5D%0A%0A%20%20%20%20for%20combo%20in%20current_filters%3A%0A%20%20%20%20%20%20%20%20c_id%20%3D%20str(combo%5B%22id%22%5D)%0A%20%20%20%20%20%20%20%20is_include%20%3D%20combo%5B%22type%22%5D%20%3D%3D%20%22Must%20Include%20All%22%0A%0A%20%20%20%20%20%20%20%20%23%20Symbol%20%26%20Color%20Logic%0A%20%20%20%20%20%20%20%20if%20is_include%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20symbol%20%3D%20%22%E2%9C%85%22%0A%20%20%20%20%20%20%20%20%20%20%20%20kind_val%20%3D%20%22success%22%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20symbol%20%3D%20%22%F0%9F%9A%AB%22%0A%20%20%20%20%20%20%20%20%20%20%20%20kind_val%20%3D%20%22danger%22%0A%0A%20%20%20%20%20%20%20%20label%20%3D%20f%22%7Bsymbol%7D%20%7B'%2C%20'.join(combo%5B'racers'%5D)%7D%20%20%5Bx%5D%22%0A%20%20%20%20%20%20%20%20handler%20%3D%20functools.partial(lambda%20_%2C%20fid%3A%20_remove_id(fid)%2C%20fid%3Dc_id)%0A%0A%20%20%20%20%20%20%20%20btn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20%20%20%20%20label%3Dlabel%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on_click%3Dhandler%2C%20%20%23%20%3C---%20FIXED%3A%20using%20the%20bound%20handler%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3Dkind_val%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%22Click%20to%20remove%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20filter_buttons.append(btn)%0A%0A%20%20%20%20%23%203.%20Output%20UI%0A%20%20%20%20if%20not%20filter_buttons%3A%0A%20%20%20%20%20%20%20%20active_filters_display%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%3Cspan%20style%3D'color%3A%23999%3B%20font-style%3Aitalic%3B%20font-size%3A0.9rem'%3ENo%20active%20filters%3C%2Fspan%3E%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20active_filters_display%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20filter_buttons%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20wrap%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20gap%3D0.5%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(active_filters_display%2C)%0A%0A%0A%40app.cell%0Adef%20cell_autoracer_btn(mo)%3A%0A%20%20%20%20select_auto_racers_btn%20%3D%20mo.ui.run_button(%0A%20%20%20%20%20%20%20%20label%3D%22%F0%9F%A4%96%20Select%20automatic%20racers%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22neutral%22%2C%0A%20%20%20%20%20%20%20%20tooltip%3D%22Select%20all%20racers%20that%20do%20not%20require%20human%2FAI%20decisions.%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(select_auto_racers_btn%2C)%0A%0A%0A%40app.cell%0Adef%20cell_general_filters_ui(df_races%2C%20mo)%3A%0A%20%20%20%20%23%201.%20Define%20UI%20Elements%0A%20%20%20%20unique_boards%20%3D%20sorted(df_races%5B%22board%22%5D.unique().to_list())%0A%0A%20%20%20%20board_filter%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dunique_boards%2C%0A%20%20%20%20%20%20%20%20value%3Dunique_boards%2C%0A%20%20%20%20%20%20%20%20label%3D%22Filter%20Boards%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20racer_count_filter%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dsorted(df_races%5B%22racer_count%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20value%3Dsorted(df_races%5B%22racer_count%22%5D.unique().to_list())%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20Count%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%202.%20Display%20them%0A%20%20%20%20filter_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bboard_filter%2C%20racer_count_filter%5D)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Return%20widgets%20so%20other%20cells%20can%20access%20.value%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_general_filters_ui(df_races%2C%20mo)%3A%0A%20%20%20%20%23%201.%20Define%20UI%20Elements%0A%20%20%20%20%23%20We%20use%20sorted%20unique%20values%20for%20the%20options%0A%20%20%20%20unique_boards_opts%20%3D%20sorted(df_races%5B%22board%22%5D.unique().to_list())%0A%20%20%20%20unique_counts_opts%20%3D%20sorted(df_races%5B%22racer_count%22%5D.unique().to_list())%0A%0A%20%20%20%20%23%20Create%20the%20widgets%0A%20%20%20%20board_filter_widget%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dunique_boards_opts%2C%0A%20%20%20%20%20%20%20%20value%3Dunique_boards_opts%2C%0A%20%20%20%20%20%20%20%20label%3D%22Filter%20Boards%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20racer_count_widget%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dunique_counts_opts%2C%0A%20%20%20%20%20%20%20%20value%3Dunique_counts_opts%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20Count%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%202.%20Layout%0A%20%20%20%20general_filters_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bboard_filter_widget%2C%20racer_count_widget%5D)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Return%20the%20WIDGET%20OBJECTS%20so%20the%20next%20cell%20can%20read%20their%20.value%0A%20%20%20%20return%20board_filter_widget%2C%20racer_count_widget%0A%0A%0A%40app.cell%0Adef%20cell_apply_all_filters(%0A%20%20%20%20board_filter_widget%2C%0A%20%20%20%20df_races_clean%2C%0A%20%20%20%20get_combo_filters%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20racer_count_widget%2C%0A)%3A%0A%20%20%20%20%23%201.%20Start%20with%20General%20Filters%20(reading%20.value%20is%20allowed%20here%20because%20widgets%20were%20created%20in%20a%20different%20cell)%0A%20%20%20%20%23%20We%20use%20'current_mask'%20to%20build%20the%20filter%20expression%20incrementally%0A%20%20%20%20current_mask%20%3D%20(pl.col(%22board%22).is_in(board_filter_widget.value))%20%26%20(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_count%22).is_in(racer_count_widget.value)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%202.%20Apply%20Combo%20Filters%0A%20%20%20%20%23%20We%20iterate%20over%20the%20list%20of%20active%20combo%20filters%0A%20%20%20%20active_combos%20%3D%20get_combo_filters()%0A%20%20%20%20for%20combo_item%20in%20active_combos%3A%0A%20%20%20%20%20%20%20%20target_racers%20%3D%20combo_item%5B%22racers%22%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Check%20if%20row%20has%20ALL%20these%20racers%0A%20%20%20%20%20%20%20%20%23%20Using%20list.contains%20for%20each%20racer%20and%20combining%20with%20AND%0A%20%20%20%20%20%20%20%20has_all_racers%20%3D%20pl.all_horizontal(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bpl.col(%22racer_names%22).list.contains(r_name)%20for%20r_name%20in%20target_racers%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20combo_item%5B%22type%22%5D%20%3D%3D%20%22Must%20Include%20All%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20current_mask%20%3D%20current_mask%20%26%20has_all_racers%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%22Must%20Exclude%20Combination%22%20means%3A%20It%20is%20NOT%20the%20case%20that%20(Has%20A%20AND%20Has%20B)%0A%20%20%20%20%20%20%20%20%20%20%20%20current_mask%20%3D%20current_mask%20%26%20(~has_all_racers)%0A%0A%20%20%20%20%23%203.%20Execute%20Filter%0A%20%20%20%20%23%20We%20produce%20a%20NEW%20dataframe%20with%20a%20UNIQUE%20global%20name%0A%20%20%20%20df_races_final_selection%20%3D%20df_races_clean.filter(current_mask)%0A%0A%20%20%20%20%23%204.%20Rich%20Status%20Display%0A%20%20%20%20n_selected_racers%20%3D%20len(%0A%20%20%20%20%20%20%20%20racer_count_widget.value%2C%0A%20%20%20%20)%20%20%23%20Assuming%20you%20can%20access%20this%20or%20pass%20it%0A%20%20%20%20%23%20Actually%2C%20better%20to%20read%20from%20the%20dataframe%20or%20the%20widgets%20directly%20available%20in%20this%20cell%0A%0A%20%20%20%20selected_boards%20%3D%20board_filter_widget.value%0A%20%20%20%20selected_counts%20%3D%20racer_count_widget.value%0A%20%20%20%20n_combos%20%3D%20len(active_combos)%0A%0A%20%20%20%20summary_md%20%3D%20f%22%22%22%0A%20%20%20%20**Analysis%20Scope%3A**%0A%20%20%20%20-%20**Races%20Found%3A**%20%7Bdf_races_final_selection.height%7D%20(of%20%7Bdf_races_clean.height%7D)%0A%20%20%20%20-%20**Boards%3A**%20%7B%22%2C%20%22.join(selected_boards)%20if%20len(selected_boards)%20%3C%204%20else%20f%22%7Blen(selected_boards)%7D%20boards%22%7D%0A%20%20%20%20-%20**Player%20Counts%3A**%20%7B%22%2C%20%22.join(map(str%2C%20selected_counts))%7D%0A%20%20%20%20-%20**Active%20Constraints%3A**%20%7Bn_combos%7D%20combo%20filters%0A%20%20%20%20%22%22%22%0A%0A%20%20%20%20status_display%20%3D%20mo.callout(mo.md(summary_md)%2C%20kind%3D%22info%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20automatic_racers_list%2C%0A%20%20%20%20df_racer_results%2C%0A%20%20%20%20df_races%2C%0A%20%20%20%20get_combo_filters%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20select_auto_racers_btn%2C%0A%20%20%20%20set_last_run_config%2C%0A)%3A%0A%20%20%20%20%23%201.%20Prepare%20Options%20from%20RAW%20Data%0A%20%20%20%20all_racers%20%3D%20sorted(df_racer_results.get_column(%22racer_name%22).unique().to_list())%0A%20%20%20%20all_boards%20%3D%20sorted(df_races.get_column(%22board%22).unique().to_list())%0A%20%20%20%20all_counts%20%3D%20sorted(df_races.get_column(%22racer_count%22).unique().to_list())%0A%0A%20%20%20%20%23%202.%20Handle%20Auto-Select%20Logic%0A%20%20%20%20%23%20We%20can%20safely%20read%20.value%20because%20the%20button%20was%20defined%20in%20a%20previous%20cell%0A%20%20%20%20if%20select_auto_racers_btn.value%3A%0A%20%20%20%20%20%20%20%20_current_selection%20%3D%20%5Br%20for%20r%20in%20automatic_racers_list%20if%20r%20in%20all_racers%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20_current_selection%20%3D%20all_racers%0A%0A%20%20%20%20%23%203.%20Define%20Filter%20Widgets%0A%20%20%20%20ui_racers%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_racers%2C%0A%20%20%20%20%20%20%20%20value%3D_current_selection%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racers%20(roster%20pool)%22%2C%0A%20%20%20%20)%0A%20%20%20%20ui_counts%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_counts%2C%0A%20%20%20%20%20%20%20%20value%3Dall_counts%2C%0A%20%20%20%20%20%20%20%20label%3D%22Racer%20count(s)%22%2C%0A%20%20%20%20)%0A%20%20%20%20ui_boards%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Dall_boards%2C%0A%20%20%20%20%20%20%20%20value%3Dall_boards%2C%0A%20%20%20%20%20%20%20%20label%3D%22Board(s)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20matchup_metric_toggle%20%3D%20mo.ui.switch(value%3DTrue%2C%20label%3D%22Show%20Percentage%20Shift%22)%0A%20%20%20%20dynamic_zoom_toggle%20%3D%20mo.ui.switch(label%3D%22%F0%9F%94%8D%20Rank-based%20view%22%2C%20value%3DFalse)%0A%0A%20%20%20%20%23%204.%20Define%20%22Run%20Analysis%22%20Button%20with%20Callback%0A%20%20%20%20def%20_submit_filters(_)%3A%0A%20%20%20%20%20%20%20%20set_last_run_config(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racers%22%3A%20ui_racers.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22boards%22%3A%20ui_boards.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22counts%22%3A%20ui_counts.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22combo_filters%22%3A%20get_combo_filters()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20run_computation_btn%20%3D%20mo.ui.button(%0A%20%20%20%20%20%20%20%20label%3D%22%F0%9F%9A%80%20Run%20Analysis%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22success%22%2C%0A%20%20%20%20%20%20%20%20on_click%3D_submit_filters%2C%0A%20%20%20%20%20%20%20%20tooltip%3D%22Click%20to%20process%20data%20with%20current%20filters.%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20%20%20%20%20run_computation_btn%2C%0A%20%20%20%20%20%20%20%20ui_boards%2C%0A%20%20%20%20%20%20%20%20ui_counts%2C%0A%20%20%20%20%20%20%20%20ui_racers%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20cell_show_filters(%0A%20%20%20%20active_filters_display%2C%0A%20%20%20%20combo_ui%2C%0A%20%20%20%20get_combo_filters%2C%0A%20%20%20%20last_run_config%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20run_computation_btn%2C%0A%20%20%20%20select_auto_racers_btn%2C%0A%20%20%20%20ui_boards%2C%0A%20%20%20%20ui_counts%2C%0A%20%20%20%20ui_racers%2C%0A)%3A%0A%20%20%20%20stale_warning%20%3D%20None%20%20%23%20Initialize%20to%20None%2C%20not%20empty%20markdown%0A%0A%20%20%20%20if%20last_run_config()%20is%20not%20None%3A%0A%0A%20%20%20%20%20%20%20%20def%20_norm_combos(cs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20sorted((c%5B%22type%22%5D%2C%20tuple(c%5B%22racers%22%5D))%20for%20c%20in%20(cs%20or%20%5B%5D))%0A%0A%20%20%20%20%20%20%20%20run_cfg%20%3D%20last_run_config()%0A%20%20%20%20%20%20%20%20is_stale%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20ui_racers.value%20!%3D%20run_cfg%5B%22racers%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20or%20ui_boards.value%20!%3D%20run_cfg%5B%22boards%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20or%20ui_counts.value%20!%3D%20run_cfg%5B%22counts%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20or%20_norm_combos(get_combo_filters())%20!%3D%20_norm_combos(run_cfg.get(%22combos%22))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20is_stale%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20FIX%3A%20Removed%20the%20trailing%20comma%20that%20made%20this%20a%20Tuple%0A%20%20%20%20%20%20%20%20%20%20%20%20stale_warning%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3A%20%23DC143C%3B%20margin-bottom%3A%200.75rem%3B%22%3E%E2%9A%A0%EF%B8%8F%20%3Cb%3EFilters%20Changed%3A%3C%2Fb%3E%20The%20dashboard%20below%20is%20showing%20old%20data.%20Click%20%3Cb%3E%F0%9F%9A%80%20Run%20Analysis%3C%2Fb%3E%20to%20update.%3C%2Fdiv%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%20Layout%0A%20%20%20%20header%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%3Chr%20style%3D%22margin%3A%201.25rem%200%3B%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%3Ch2%20style%3D%22margin%3A%200%200%200.5rem%200%3B%22%3EAggregated%20Dashboard%3C%2Fh2%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22color%3A%20%23aaa%3B%20margin-bottom%3A%200.75rem%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20Filter%20races%20by%20roster%2C%20board%2C%20and%20player%20count.%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%22%22%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Combine%20everything%0A%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20header%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Row%201%3A%20Basic%20Filters%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bui_racers%2C%20select_auto_racers_btn%2C%20ui_counts%2C%20ui_boards%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Row%202%3A%20Combo%20Filters%20(Accordion%20%2B%20Display)%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.accordion(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Advanced%20Combination%20Filters%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20combo_ui%2C%20%20%23%20The%20%22Add%22%20interface%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22---%22)%2C%20%20%23%20Separator%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20active_filters_display%2C%20%20%23%20The%20list%20of%20removal%20buttons%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Row%203%3A%20Run%20Button%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Brun_computation_btn%5D%2C%20justify%3D%22end%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stale_warning%20if%20stale_warning%20else%20mo.md(%22%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20cell_filter_data(%0A%20%20%20%20df_racer_results%2C%0A%20%20%20%20df_races_clean%2C%0A%20%20%20%20last_run_config%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pl%2C%0A)%3A%0A%20%20%20%20%23%201.%20Initialize%20Outputs%0A%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.head(0)%0A%20%20%20%20df_races_f%20%3D%20df_races_clean.head(0)%0A%20%20%20%20_selected_boards%20%3D%20%5B%5D%0A%20%20%20%20_selected_counts%20%3D%20%5B%5D%0A%20%20%20%20selected_racers%20%3D%20%5B%5D%0A%0A%20%20%20%20_error_msg%20%3D%20None%0A%0A%20%20%20%20%23%202.%20Logic%20Block%0A%20%20%20%20if%20last_run_config()%20is%20None%3A%0A%20%20%20%20%20%20%20%20mo.output.replace(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%3Cdiv%20style%3D%22color%3A%20%23DC143C%3B%20margin-bottom%3A%200.75rem%3B%22%3E%E2%84%B9%EF%B8%8F%20%3Cb%3EWaiting%20for%20Input%3A%3C%2Fb%3E%20Adjust%20filters%20above%20and%20click%20%3Cb%3E%F0%9F%9A%80%20Run%20Analysis%3C%2Fb%3E%20to%20generate%20stats.%3Cdiv%3E'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%23%203.%20Unwrap%20Config%0A%20%20%20%20%20%20%20%20selected_racers%20%3D%20list(last_run_config()%5B%22racers%22%5D)%0A%20%20%20%20%20%20%20%20_selected_counts%20%3D%20list(last_run_config()%5B%22counts%22%5D)%0A%20%20%20%20%20%20%20%20_selected_boards%20%3D%20list(last_run_config()%5B%22boards%22%5D)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Validation%0A%20%20%20%20%20%20%20%20if%20len(_selected_boards)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_error_msg%20%3D%20%22Select%20at%20least%20one%20board.%22%0A%20%20%20%20%20%20%20%20elif%20len(_selected_counts)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_error_msg%20%3D%20%22Select%20at%20least%20one%20racer%20count.%22%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_min_req%20%3D%20max(_selected_counts)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(selected_racers)%20%3C%20_min_req%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_error_msg%20%3D%20f%22Need%20at%20least%20%7B_min_req%7D%20racers%20selected%2C%20but%20only%20%7Blen(selected_racers)%7D%20selected.%22%0A%0A%20%20%20%20%20%20%20%20%23%205.%20Apply%20Filters%0A%20%20%20%20%20%20%20%20if%20_error_msg%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_base_filter_mask%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22board%22).is_in(_selected_boards)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22racer_count%22).is_in(_selected_counts)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22error_code%22).is_null()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20pl.col(%22total_turns%22).gt(1)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20B.%20Combo%20Filters%0A%20%20%20%20%20%20%20%20%20%20%20%20_active_combos%20%3D%20last_run_config().get(%22combo_filters%22%2C%20%5B%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20_combo%20in%20_active_combos%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_targets%20%3D%20_combo%5B%22racers%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_has_all%20%3D%20pl.all_horizontal(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bpl.col(%22racer_names%22).list.contains(r)%20for%20r%20in%20_targets%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20_combo%5B%22type%22%5D%20%3D%3D%20%22Must%20Include%20All%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_base_filter_mask%20%3D%20_base_filter_mask%20%26%20_has_all%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_base_filter_mask%20%3D%20_base_filter_mask%20%26%20(~_has_all)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20_races_bc%20%3D%20df_races_clean.filter(_base_filter_mask)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20C.%20Roster%20Check%0A%20%20%20%20%20%20%20%20%20%20%20%20_roster_ok%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_races_bc.select(%22config_hash%22%2C%20%22racer_count%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22inner%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%5B%22config_hash%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).n_unique().alias(%22n_present%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.is_in(selected_racers)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.all()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22all_in_pool%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22all_in_pool%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22n_present%22)%20%3D%3D%20pl.col(%22racer_count%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.select(%5B%22config_hash%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20_eligible_hashes%20%3D%20_roster_ok.get_column(%22config_hash%22).unique()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20D.%20Final%20Data%20Assignment%0A%20%20%20%20%20%20%20%20%20%20%20%20df_races_f%20%3D%20df_races_clean.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22config_hash%22).is_in(_eligible_hashes)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22config_hash%22).is_in(_eligible_hashes)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20df_races_f.height%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_error_msg%20%3D%20%22No%20data%20matches%20filters.%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_races_f%20%3D%20df_races_clean.head(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_f%20%3D%20df_racer_results.head(0)%0A%0A%20%20%20%20%20%20%20%20%23%206.%20Display%20Error%20if%20needed%0A%20%20%20%20%20%20%20%20if%20_error_msg%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.output.replace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%3Cdiv%20style%3D'color%3A%23ff6b6b%3B%20font-weight%3A600%3B%20margin-top%3A0.5rem%3B'%3E%E2%9A%A0%20%7B_error_msg%7D%3C%2Fdiv%3E%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%23%207.%20Final%20Return%0A%20%20%20%20return%20df_racer_results_f%2C%20df_races_f%0A%0A%0A%40app.cell%0Adef%20_(df_racer_results_f%2C%20df_races_f%2C%20mo%2C%20pl)%3A%0A%20%20%20%20if%20df_races_f.height%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20mo.stop(True)%0A%0A%20%20%20%20df_working%20%3D%20df_races_f%0A%20%20%20%20df_racer_results_filtered%20%3D%20df_racer_results_f%0A%0A%20%20%20%20def%20_calculate_all_data()%3A%0A%20%20%20%20%20%20%20%20%23%200.%20PREP%3A%20Extract%20Duration%20Info%20First%0A%20%20%20%20%20%20%20%20race_time_info%20%3D%20df_working.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22turns_on_winning_round%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22total_turns%22).alias(%22race_global_turns%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20results_augmented%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_racer_results_filtered.join(race_time_info%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_self_ability_movement%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22neg_self_ability_movement%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_other_ability_movement%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22neg_other_ability_movement%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22ability_own_turn_count%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22ability_self_target_count%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22ability_trigger_count%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22rolling_turns%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22sum_dice_rolled%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22recovery_turns%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_main_moves%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_self_main_move%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_other_main_move%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%20DURATION%20LOGIC%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22finish_position%22)%20%3D%3D%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.col(%22turns_on_winning_round%22)%20*%20pl.col(%22racer_count%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22race_global_turns%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22effective_global_duration%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20----------------------%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22turns_taken%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22recovery_turns%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22skipped_main_moves%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22active_turns_count%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20-----------------------------------------------------------------%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20BASE%20CALCS%20%2B%20DICE%20ATTRIBUTION%20(Corrected)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20-----------------------------------------------------------------%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22active_turns_count%22)%20%2F%20pl.col(%22turns_taken%22).replace(0%2C%201))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22active_turns_pct%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Identify%20if%20Dicemonger%20is%20in%20this%20specific%20race%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.eq(%22Dicemonger%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.any()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22dicemonger_in_race%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20A.%20Calculate%20%22Pure%20Baseline%22%20(Avg%20Dice%20ignoring%20Dicemonger%20games)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20For%20Magician%3A%20This%20is%20his%20Avg%20in%20non-Dicemonger%20games.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20For%20Others%3A%20This%20will%20likely%20converge%20to%203.5%2C%20but%20we%20calculate%20it%20to%20be%20precise.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22sum_dice_rolled%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.filter(~pl.col(%22dicemonger_in_race%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.sum()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22rolling_turns%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.filter(~pl.col(%22dicemonger_in_race%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.sum()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.over(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.fill_null(3.5)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22global_avg_dice_pure%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20DICE%20LUCK%3A%20Self-Actualization%20(vs%203.5)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Dicemonger%3A%20Gets%20his%20own%20actual%20luck%20(Actual%20-%203.5).%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Magician%20(No%20Dicemonger)%3A%20Gets%20actual%20luck%20(Actual%20-%203.5).%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20Magician%20(With%20Dicemonger)%3A%20Gets%20%22Standard%22%20luck%20(PureBaseline%20-%203.5).%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Everyone%20else%3A%200.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_self_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22racer_name%22)%20%3D%3D%20%22Dicemonger%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22sum_dice_rolled%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20(pl.col(%22rolling_turns%22)%20*%203.5)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22racer_name%22)%20%3D%3D%20%22Magician%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(~pl.col(%22dicemonger_in_race%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22sum_dice_rolled%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20(pl.col(%22rolling_turns%22)%20*%203.5)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.when(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22racer_name%22)%20%3D%3D%20%22Magician%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%26%20(pl.col(%22dicemonger_in_race%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Grant%20%22Standard%20Performance%22%20to%20stabilize%20the%20average%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22global_avg_dice_pure%22)%20-%203.5)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*%20pl.col(%22rolling_turns%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.clip(0%2C%209999)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).fill_nan(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22pos_self_ability_movement%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20Dicemonger%20Attribution%3A%20Calculate%20marginal%20gain%20vs%20%22Pure%20Baseline%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22sum_dice_rolled%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22rolling_turns%22).replace(0%2C%201)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22global_avg_dice_pure%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*%20pl.col(%22rolling_turns%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22marginal_gain_dice%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Dicemonger%20Attribution%3A%20Give%20Dicemonger%20credit%20for%20the%20BOOST%20(Actual%20-%20Pure)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22racer_name%22)%20%3D%3D%20%22Dicemonger%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_other_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22marginal_gain_dice%22).sum().over(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22marginal_gain_dice%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22pos_other_ability_movement%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22pos_other_ability_movement%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%205.%20Net%20Self%20Movement%20(Finalized)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_self_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22neg_self_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22net_self_movement%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%200.5.%20CALCULATE%20SKIPPED%20TURN%20COSTS%20---%0A%20%20%20%20%20%20%20%20%23%20We%20calculate%20individual%20speeds%20to%20get%20the%20global%20average%0A%20%20%20%20%20%20%20%20results_augmented%20%3D%20results_augmented.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22sum_dice_rolled%22)%20%2B%20pl.col(%22pos_self_ability_movement%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22active_turns_count%22).replace(0%2C%201)%20%20%23%20Avoid%20div%2F0%0A%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22raw_speed_per_active_turn%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20GLOBAL%20CONSTANT%3A%20Used%20for%20skip%20penalties%20to%20avoid%20circular%20logic%0A%20%20%20%20%20%20%20%20global_avg_active_speed%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20results_augmented.select(pl.col(%22raw_speed_per_active_turn%22).mean()).item()%0A%20%20%20%20%20%20%20%20%20%20%20%20or%203.5%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%201.%20TRUTH%0A%20%20%20%20%20%20%20%20global_win_rates%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20results_augmented.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22finish_position%22)%20%3D%3D%201).sum().alias(%22total_wins%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.len().alias(%22total_races%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22total_wins%22)%20%2F%20pl.col(%22total_races%22)).alias(%22global_win_rate%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20BASELINE%0A%20%20%20%20%20%20%20%20df_baselines%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20results_augmented.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(~pl.col(%22finish_position%22)%20%3D%3D%201)%20%26%20(~pl.col(%22eliminated%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22config_hash%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22turns_taken%22).median().alias(%22median_turns_baseline%22))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20stats_results%20%3D%20results_augmented.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_baselines%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22median_turns_baseline%22).fill_null(pl.col(%22turns_taken%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22turns_taken%22)%20%3C%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(None)%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22turns_taken%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22total_turns_clean%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20RACE%20ENV%0A%20%20%20%20%20%20%20%20race_agg_stats%20%3D%20stats_results.group_by(%22config_hash%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_trigger_count%22).sum()%20%2F%20pl.col(%22racer_id%22).count()).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_triggers%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22recovery_turns%22).sum()%20%2F%20pl.col(%22turns_taken%22).sum()).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_trip_rate%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20stats_races%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df_working.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tightness_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22volatility_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(race_time_info%2C%20on%3D%5B%22config_hash%22%2C%20%22racer_count%22%5D%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(race_agg_stats%2C%20on%3D%22config_hash%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_null(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20ENRICHMENT%20(The%20Final%20Calculation)%0A%20%20%20%20%20%20%20%20%23%20We%20integrate%20the%20Inchworm%20correction%20directly%20into%20the%20cost%20assignment%0A%20%20%20%20%20%20%20%20stats_results%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20A.%20Calculate%20Costs%20(including%20Special%20Mechanics)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_self_main_move%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*%20pl.lit(global_avg_active_speed)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22cost_skip_self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22racer_name%22)%20%3D%3D%20%22Inchworm%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_other_main_move%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*%20(pl.lit(global_avg_active_speed)%20-%202.5)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22skipped_other_main_move%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*%20pl.lit(global_avg_active_speed)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22cost_skip_other%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20B.%20Normalization%20(using%20the%20costs%20calculated%20above)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_self_ability_movement%22)%20%20%23%20%2BSelf%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22total_turns_clean%22).replace(0%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22norm_pos_self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22neg_self_ability_movement%22)%20%20%23%20-Self%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20pl.col(%22cost_skip_self%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22total_turns_clean%22).replace(0%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22norm_neg_self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_other_ability_movement%22)%20%20%23%20%2BOther%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22effective_global_duration%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22total_turns_clean%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).replace(0%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22norm_pos_other%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22neg_other_ability_movement%22)%20%20%23%20-Other%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20pl.col(%22cost_skip_other%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22effective_global_duration%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22total_turns_clean%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).replace(0%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22norm_neg_other%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22pos_self_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22neg_self_ability_movement%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22total_turns_clean%22).replace(0%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%203.5%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22speed_raw_calc%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20C.%20Net%20Movement%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_pos_self%22).fill_null(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22norm_neg_self%22).fill_null(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-%20pl.col(%22norm_pos_other%22).fill_null(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20pl.col(%22norm_neg_other%22).fill_null(0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22relative_speed_calc%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%205.%20CONSISTENCY%0A%20%20%20%20%20%20%20%20racer_mu_sigma%20%3D%20stats_results.group_by(%22racer_name%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22mean_vp_mu%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).std().fill_null(0).alias(%22std_vp_sigma%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20consistency_calc%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.join(racer_mu_sigma%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22std_vp_sigma%22)%20%3D%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.then(True)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22final_vp%22)%20-%20pl.col(%22mean_vp_mu%22)).abs()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%3D%20pl.col(%22std_vp_sigma%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22is_consistent%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22is_consistent%22).mean().alias(%22consistency_score%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22std_vp_sigma%22).first().alias(%22std_dev_val%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%206.%20BASE%20STATS%0A%20%20%20%20%20%20%20%20base_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stats_races.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22tightness_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22volatility_score%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_triggers%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_avg_trip_rate%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_global_turns%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22mean_vp%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22finish_position%22)%20%3D%3D%201).sum().alias(%22cnt_1st%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22finish_position%22)%20%3D%3D%202).sum().alias(%22cnt_2nd%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.len().alias(%22races_run%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22tightness_score%22).mean().alias(%22avg_race_tightness%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22volatility_score%22).mean().alias(%22avg_race_volatility%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_avg_triggers%22).mean().alias(%22avg_env_triggers%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_avg_trip_rate%22).mean().alias(%22avg_env_trip_rate%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).mean().alias(%22avg_game_duration%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22speed_raw_calc%22).mean().alias(%22avg_speed_raw%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22relative_speed_calc%22).mean().alias(%22avg_net_movement%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22active_turns_pct%22).mean().alias(%22avg_active_turns_pct%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_pos_self%22).mean().alias(%22avg_pos_self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_neg_self%22).mean().alias(%22avg_neg_self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_pos_other%22).mean().alias(%22avg_pos_other%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_neg_other%22).mean().alias(%22avg_neg_other%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_trigger_count%22)%20%2F%20pl.col(%22total_turns_clean%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22triggers_per_turn%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_self_target_count%22)%20%2F%20pl.col(%22total_turns_clean%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22self_targets_per_turn%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22ability_own_turn_count%22)%20%2F%20pl.col(%22total_turns_clean%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22own_turn_triggers_per_turn%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%207.%20CORRELATIONS%0A%20%20%20%20%20%20%20%20stats_results_corr%20%3D%20stats_results.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22sum_dice_rolled%22)%20%2F%20pl.col(%22rolling_turns%22).replace(0%2C%201)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22avg_dice_val%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20corr_df%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results_corr.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22avg_dice_val%22%2C%20%22final_vp%22).abs().alias(%22dice_sensitivity%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22net_self_movement%22%2C%20%22final_vp%22).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22ability_move_dependency%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.corr(%22racer_id%22%2C%20%22final_vp%22)%20*%20-1).alias(%22start_pos_bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22midgame_relative_pos%22%2C%20%22final_vp%22).alias(%22midgame_bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22ability_trigger_count%22%2C%20%22final_vp%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.abs()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22trigger_dependency%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20final_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20base_stats.join(corr_df%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(consistency_calc%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20global_win_rates.select(%5B%22racer_name%22%2C%20%22global_win_rate%22%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22racer_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cnt_1st%22)%20%2F%20pl.col(%22races_run%22)).alias(%22pct_1st%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cnt_2nd%22)%20%2F%20pl.col(%22races_run%22)).alias(%22pct_2nd%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22consistency_score%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22global_win_rate%22).fill_null(0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22std_dev_val%22).fill_null(0).alias(%22std_vp_sigma%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20B.%20MATRICES%0A%20%20%20%20%20%20%20%20global_means%20%3D%20final_stats.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%22racer_name%22%2C%20pl.col(%22mean_vp%22).alias(%22my_global_avg%22)%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20subjects%20%3D%20stats_results.select(%5B%22config_hash%22%2C%20%22racer_name%22%2C%20%22final_vp%22%5D)%0A%20%20%20%20%20%20%20%20opponents%20%3D%20stats_results.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5Bpl.col(%22config_hash%22)%2C%20pl.col(%22racer_name%22).alias(%22opponent_name%22)%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20matchup_df%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20subjects.join(opponents%2C%20on%3D%22config_hash%22%2C%20how%3D%22inner%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.filter(pl.col(%22racer_name%22)%20!%3D%20pl.col(%22opponent_name%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.group_by(%5B%22racer_name%22%2C%20%22opponent_name%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.col(%22final_vp%22).mean().alias(%22avg_vp_with_opponent%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.join(global_means%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22avg_vp_with_opponent%22)%20-%20pl.col(%22my_global_avg%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22residual_matchup%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22avg_vp_with_opponent%22)%20-%20pl.col(%22my_global_avg%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22my_global_avg%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22percentage_shift%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20C.%20ABILITIES%20BREAKDOWN%0A%20%20%20%20%20%20%20%20df_abilities_agg%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20stats_results.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_pos_self%22).mean().alias(%22%2B%20Self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_neg_self%22).mean().alias(%22-%20Self%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_pos_other%22).mean().alias(%22%2B%20Others%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22norm_neg_other%22).mean().alias(%22-%20Others%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%20D.%20RAW%20DISTRIBUTION%20DATA%20(NO%20FILTERING%20HERE)%20---%0A%20%20%20%20%20%20%20%20race_vp_agg%20%3D%20results_augmented.group_by(%22config_hash%22).agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).sum().alias(%22total_race_vp%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20dist_base_raw%20%3D%20stats_races.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20race_vp_agg%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22inner%22%2C%0A%20%20%20%20%20%20%20%20).select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22config_hash%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22race_global_turns%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22total_race_vp%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22stats%22%3A%20final_stats%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22matchup_df%22%3A%20matchup_df%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22results_raw%22%3A%20stats_results%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22races_raw%22%3A%20stats_races%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22abilities_df%22%3A%20df_abilities_agg%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22dist_raw%22%3A%20dist_base_raw%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20chart_height_slider%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D400%2C%0A%20%20%20%20%20%20%20%20stop%3D1200%2C%0A%20%20%20%20%20%20%20%20value%3D900%2C%0A%20%20%20%20%20%20%20%20step%3D50%2C%0A%20%20%20%20)%0A%0A%20%20%20%20with%20mo.status.spinner(%0A%20%20%20%20%20%20%20%20title%3Df%22Aggregating%20data%20for%20%7Bdf_working.height%7D%20races...%22%2C%0A%20%20%20%20)%20as%20_spinner%3A%0A%20%20%20%20%20%20%20%20dashboard_data%20%3D%20_calculate_all_data()%0A%0A%20%20%20%20mo.output.replace(mo.md(f%22%E2%9C%85%20**%7Bdf_working.height%7D**%20races%20analyzed.%22))%0A%20%20%20%20return%20chart_height_slider%2C%20dashboard_data%0A%0A%0A%40app.cell%0Adef%20_(BG_COLOR%2C%20alt%2C%20np%2C%20pl)%3A%0A%20%20%20%20def%20get_contrasting_stroke(hex_color)%3A%0A%20%20%20%20%20%20%20%20if%20not%20hex_color%20or%20not%20hex_color.startswith(%22%23%22)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22white%22%0A%20%20%20%20%20%20%20%20hex_color%20%3D%20hex_color.lstrip(%22%23%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20r%2C%20g%2C%20b%20%3D%20tuple(int(hex_color%5Bi%20%3A%20i%20%2B%202%5D%2C%2016)%20for%20i%20in%20(0%2C%202%2C%204))%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22black%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20((0.299%20*%20r%20%2B%200.587%20*%20g%20%2B%200.114%20*%20b)%20%2F%20255)%20%3E%200.6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20%22white%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20except%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22white%22%0A%0A%20%20%20%20def%20build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats_df%2C%0A%20%20%20%20%20%20%20%20racers%2C%0A%20%20%20%20%20%20%20%20colors%2C%0A%20%20%20%20%20%20%20%20x_col%2C%0A%20%20%20%20%20%20%20%20y_col%2C%0A%20%20%20%20%20%20%20%20title%2C%0A%20%20%20%20%20%20%20%20x_title%2C%0A%20%20%20%20%20%20%20%20y_title%2C%0A%20%20%20%20%20%20%20%20*%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3A%20bool%2C%0A%20%20%20%20%20%20%20%20reverse_x%3DFalse%2C%0A%20%20%20%20%20%20%20%20quad_labels%3DNone%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3DNone%2C%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20PLOT_BG%20%3D%20%22%23232826%22%0A%20%20%20%20%20%20%20%20racer_to_hex%20%3D%20dict(zip(racers%2C%20colors))%0A%20%20%20%20%20%20%20%20racer_to_stroke%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20r%3A%20get_contrasting_stroke(c)%20for%20r%2C%20c%20in%20racer_to_hex.items()%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%23%201.%20Prepare%20Data%20%26%20Domains%0A%20%20%20%20%20%20%20%20if%20use_rank_scale%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_apply_rank_transform(df%2C%20col)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20series%20%3D%20df%5Bcol%5D.drop_nulls()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20series.len()%20%3C%203%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%2C%20col%2C%20%5B%5D%2C%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vals%20%3D%20series.to_numpy()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sorted_vals%20%3D%20np.sort(vals)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sorted_ranks%20%3D%20np.linspace(0%2C%201%2C%20len(vals))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20new_col%20%3D%20f%22%7Bcol%7D_rank%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20def%20get_rank_pos(x)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20float(np.interp(x%2C%20sorted_vals%2C%20sorted_ranks))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20transformed_df%20%3D%20df.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(col)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.map_elements(get_rank_pos%2C%20return_dtype%3Dpl.Float64)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.alias(new_col)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ticks%20%3D%20np.unique(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20np.percentile(vals%2C%20%5B0%2C%2020%2C%2040%2C%2060%2C%2080%2C%20100%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20).tolist()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vis_ticks%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20float(np.interp(t%2C%20sorted_vals%2C%20sorted_ranks))%20for%20t%20in%20ticks%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20transformed_df%2C%20new_col%2C%20ticks%2C%20vis_ticks%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_x%2C%20plot_x%2C%20ticks_x%2C%20vis_ticks_x%20%3D%20_apply_rank_transform(stats_df%2C%20x_col)%0A%20%20%20%20%20%20%20%20%20%20%20%20chart_df%2C%20plot_y%2C%20ticks_y%2C%20vis_ticks_y%20%3D%20_apply_rank_transform(df_x%2C%20y_col)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Rank%20domains%20are%20always%20%5B0%2C%201%5D%20(plus%20padding)%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_x%20%3D%20%5B-0.05%2C%201.05%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_y%20%3D%20%5B-0.05%2C%201.05%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Custom%20Axis%20Labels%20for%20Rank%20Mode%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_x%20%3D%20alt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20grid%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelExpr%3Df%22datum.value%20%3D%3D%20%7Bvis_ticks_x%5B0%5D%7D%20%3F%20'%7Bticks_x%5B0%5D%3A.2f%7D'%20%3A%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22abs(datum.value%20-%20%7Bvt%7D)%20%3C%200.001%20%3F%20'%7Brt%3A.2f%7D'%20%3A%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20vt%2C%20rt%20in%20zip(vis_ticks_x%5B1%3A%5D%2C%20ticks_x%5B1%3A%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20format(datum.value%2C%20'.2f')%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_y%20%3D%20alt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20grid%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelExpr%3Df%22datum.value%20%3D%3D%20%7Bvis_ticks_y%5B0%5D%7D%20%3F%20'%7Bticks_y%5B0%5D%3A.2f%7D'%20%3A%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22abs(datum.value%20-%20%7Bvt%7D)%20%3C%200.001%20%3F%20'%7Brt%3A.2f%7D'%20%3A%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20vt%2C%20rt%20in%20zip(vis_ticks_y%5B1%3A%5D%2C%20ticks_y%5B1%3A%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20format(datum.value%2C%20'.2f')%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20mid_x%2C%20mid_y%20%3D%200.5%2C%200.5%0A%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Absolute%20Mode%0A%20%20%20%20%20%20%20%20%20%20%20%20plot_x%2C%20plot_y%20%3D%20x_col%2C%20y_col%0A%20%20%20%20%20%20%20%20%20%20%20%20chart_df%20%3D%20stats_df%0A%20%20%20%20%20%20%20%20%20%20%20%20vals_x%2C%20vals_y%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stats_df%5Bx_col%5D.drop_nulls().to_list()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stats_df%5By_col%5D.drop_nulls().to_list()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20vals_x%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20alt.Chart(stats_df).mark_text(text%3D%22No%20Data%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20min_x_val%2C%20max_x_val%20%3D%20min(vals_x)%2C%20max(vals_x)%0A%20%20%20%20%20%20%20%20%20%20%20%20min_y_val%2C%20max_y_val%20%3D%20min(vals_y)%2C%20max(vals_y)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Avoid%20singular%20matrix%20if%20all%20values%20are%20same%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20min_x_val%20%3D%3D%20max_x_val%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20max_x_val%20%2B%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_x_val%20-%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20min_y_val%20%3D%3D%20max_y_val%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20max_y_val%20%2B%3D%200.01%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20min_y_val%20-%3D%200.01%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20pad_x%20%3D%20(max_x_val%20-%20min_x_val)%20*%200.15%0A%20%20%20%20%20%20%20%20%20%20%20%20pad_y%20%3D%20(max_y_val%20-%20min_y_val)%20*%200.15%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_x%20%3D%20%5Bmin_x_val%20-%20pad_x%2C%20max_x_val%20%2B%20pad_x%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20dom_y%20%3D%20%5Bmin_y_val%20-%20pad_y%2C%20max_y_val%20%2B%20pad_y%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20axis_x%2C%20axis_y%20%3D%20alt.Axis(grid%3DFalse)%2C%20alt.Axis(grid%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20mid_x%2C%20mid_y%20%3D%20(min_x_val%20%2B%20max_x_val)%20%2F%202%2C%20(min_y_val%20%2B%20max_y_val)%20%2F%202%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Build%20Scales%0A%20%20%20%20%20%20%20%20scale_x%20%3D%20alt.Scale(domain%3Ddom_x%2C%20reverse%3Dreverse_x%2C%20zero%3DFalse%2C%20nice%3DFalse)%0A%20%20%20%20%20%20%20%20scale_y%20%3D%20alt.Scale(domain%3Ddom_y%2C%20zero%3DFalse%2C%20nice%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Add%20Stroke%20Data%0A%20%20%20%20%20%20%20%20chart_df%20%3D%20chart_df.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_name%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.map_elements(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lambda%20n%3A%20racer_to_stroke.get(n%2C%20%22white%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return_dtype%3Dpl.String%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22txt_stroke%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%204.%20Reference%20Lines%0A%20%20%20%20%20%20%20%20h_line%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22y%22%3A%20%5Bmid_y%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_rule(strokeDash%3D%5B4%2C%204%5D%2C%20color%3D%22%23888%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(y%3Dalt.Y(%22y%3AQ%22%2C%20scale%3Dscale_y))%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20v_line%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22x%22%3A%20%5Bmid_x%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_rule(strokeDash%3D%5B4%2C%204%5D%2C%20color%3D%22%23888%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(x%3Dalt.X(%22x%3AQ%22%2C%20scale%3Dscale_x))%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%205.%20Points%20%26%20Labels%0A%20%20%20%20%20%20%20%20points%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(chart_df)%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_circle(size%3D250%2C%20opacity%3D0.9)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(f%22%7Bplot_x%7D%3AQ%22%2C%20title%3Dx_title%2C%20scale%3Dscale_x%2C%20axis%3Daxis_x)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(f%22%7Bplot_y%7D%3AQ%22%2C%20title%3Dy_title%2C%20scale%3Dscale_y%2C%20axis%3Daxis_y)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3Dracers%2C%20range%3Dcolors)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(f%22%7Bx_col%7D%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3Dx_title)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(f%22%7By_col%7D%3AQ%22%2C%20format%3D%22.2f%22%2C%20title%3Dy_title)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20(extra_tooltips%20or%20%5B%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20text_outline%20%3D%20points.mark_text(%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline%3D%22middle%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dy%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dx%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontSize%3D15%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontWeight%3D800%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20stroke%3DPLOT_BG%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20strokeWidth%3D3%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20opacity%3D1%2C%0A%20%20%20%20%20%20%20%20).encode(text%3D%22racer_name%3AN%22%2C%20color%3Dalt.value(PLOT_BG))%0A%0A%20%20%20%20%20%20%20%20text_fill%20%3D%20points.mark_text(%0A%20%20%20%20%20%20%20%20%20%20%20%20align%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20baseline%3D%22middle%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dy%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20dx%3D-22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontSize%3D15%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20fontWeight%3D800%2C%0A%20%20%20%20%20%20%20%20).encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3Dracers%2C%20range%3Dcolors)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%206.%20Quadrant%20Labels%20(Fixed%20Positioning)%0A%20%20%20%20%20%20%20%20label_layers%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20if%20quad_labels%20and%20len(quad_labels)%20%3D%3D%204%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Calculate%20positions%20based%20on%20the%20definitive%20domains%20we%20calculated%20earlier%0A%20%20%20%20%20%20%20%20%20%20%20%20x_min%2C%20x_max%20%3D%20dom_x%0A%20%20%20%20%20%20%20%20%20%20%20%20y_min%2C%20y_max%20%3D%20dom_y%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%205%25%20padding%20from%20the%20edges%0A%20%20%20%20%20%20%20%20%20%20%20%20x_range%20%3D%20x_max%20-%20x_min%0A%20%20%20%20%20%20%20%20%20%20%20%20y_range%20%3D%20y_max%20-%20y_min%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20px%20%3D%20x_range%20*%200.05%0A%20%20%20%20%20%20%20%20%20%20%20%20py%20%3D%20y_range%20*%200.05%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Define%20coordinates%20(Left%2FRight%2C%20Top%2FBottom)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Note%3A%20If%20reverse_x%20is%20True%2C%20%22Left%22%20visually%20is%20x_max%20numerically%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20reverse_x%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20left_x%20%3D%20x_max%20-%20px%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20right_x%20%3D%20x_min%20%2B%20px%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20left_x%20%3D%20x_min%20%2B%20px%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20right_x%20%3D%20x_max%20-%20px%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20top_y%20%3D%20y_max%20-%20py%0A%20%20%20%20%20%20%20%20%20%20%20%20bottom_y%20%3D%20y_min%20%2B%20py%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Labels%3A%20TL%2C%20TR%2C%20BL%2C%20BR%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20quad_labels%20input%20order%3A%20%5BTL%2C%20TR%2C%20BL%2C%20BR%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20labels_config%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(left_x%2C%20top_y%2C%20quad_labels%5B0%5D%2C%20%22left%22%2C%20%22top%22)%2C%20%20%23%20Top-Left%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(right_x%2C%20top_y%2C%20quad_labels%5B1%5D%2C%20%22right%22%2C%20%22top%22)%2C%20%20%23%20Top-Right%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20left_x%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bottom_y%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20quad_labels%5B2%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bottom%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%20%20%23%20Bottom-Left%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20right_x%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bottom_y%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20quad_labels%5B3%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22right%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bottom%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%20%20%23%20Bottom-Right%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20text_props%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22fontWeight%22%3A%20%22bold%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22opacity%22%3A%200.6%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22fontSize%22%3A%2014%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22color%22%3A%20%22%23e0e0e0%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20_lbl(x%2C%20y%2C%20t%2C%20align%2C%20baseline)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22x%22%3A%20%5Bx%5D%2C%20%22y%22%3A%20%5By%5D%2C%20%22t%22%3A%20%5Bt%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.mark_text(align%3Dalign%2C%20baseline%3Dbaseline%2C%20**text_props)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22x%3AQ%22%2C%20scale%3Dscale_x)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22y%3AQ%22%2C%20scale%3Dscale_y)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22t%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20label_layers%20%3D%20%5B_lbl(*cfg)%20for%20cfg%20in%20labels_config%5D%0A%0A%20%20%20%20%20%20%20%20layers%20%3D%20%5Bpoints%2C%20text_outline%2C%20text_fill%5D%20%2B%20label_layers%20%2B%20%5Bh_line%2C%20v_line%5D%0A%20%20%20%20%20%20%20%20xzoom%20%3D%20alt.selection_interval(bind%3D%22scales%22%2C%20encodings%3D%5B%22x%22%5D%2C%20zoom%3D%22wheel!%22)%0A%20%20%20%20%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.layer(*layers)%0A%20%20%20%20%20%20%20%20%20%20%20%20.resolve_scale(x%3D%22shared%22%2C%20y%3D%22shared%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.add_params(xzoom)%0A%20%20%20%20%20%20%20%20%20%20%20%20.properties(width%3D%22container%22%2C%20height%3D800%2C%20background%3DBG_COLOR)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20return%20(build_quadrant_chart%2C)%0A%0A%0A%40app.cell%0Adef%20cell_prepare_aggregated_data(alt)%3A%0A%20%20%20%20METRIC_ORDER%20%3D%20%5B%22%2B%20Self%22%2C%20%22-%20Others%22%2C%20%22-%20Self%22%2C%20%22%2B%20Others%22%5D%0A%0A%20%20%20%20BAR_CHART_COLORS%20%3D%20alt.Scale(%0A%20%20%20%20%20%20%20%20domain%3DMETRIC_ORDER%2C%0A%20%20%20%20%20%20%20%20range%3D%5B%22%2340B0A6%22%2C%20%22%23D81B60%22%2C%20%22%231E88E5%22%2C%20%22%23FFC107%22%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20X_AXIS_TICK_STEP%20%3D%200.5%0A%20%20%20%20return%20BAR_CHART_COLORS%2C%20METRIC_ORDER%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BAR_CHART_COLORS%2C%0A%20%20%20%20BG_COLOR%2C%0A%20%20%20%20METRIC_ORDER%2C%0A%20%20%20%20alt%2C%0A%20%20%20%20build_quadrant_chart%2C%0A%20%20%20%20chart_height_slider%2C%0A%20%20%20%20dashboard_data%2C%0A%20%20%20%20df_races_f%2C%0A%20%20%20%20dynamic_zoom_toggle%2C%0A%20%20%20%20get_racer_color%2C%0A%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pl%2C%0A)%3A%0A%20%20%20%20if%20df_races_f.height%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20mo.stop(True)%0A%0A%20%20%20%20if%20dashboard_data%20is%20None%3A%0A%20%20%20%20%20%20%20%20mo.stop(True)%0A%0A%20%20%20%20stats%20%3D%20dashboard_data%5B%22stats%22%5D%0A%20%20%20%20matchup_df%20%3D%20dashboard_data%5B%22matchup_df%22%5D%0A%20%20%20%20proc_results%20%3D%20dashboard_data%5B%22results_raw%22%5D%0A%20%20%20%20proc_races%20%3D%20dashboard_data%5B%22races_raw%22%5D%0A%20%20%20%20abilities_df%20%3D%20dashboard_data%5B%22abilities_df%22%5D%0A%0A%20%20%20%20%23%20Raw%20dist%20data%0A%20%20%20%20dist_raw%20%3D%20dashboard_data%5B%22dist_raw%22%5D%0A%0A%20%20%20%20%23%20---%201.%20HELPERS%20---%0A%20%20%20%20r_list%20%3D%20stats%5B%22racer_name%22%5D.unique().to_list()%0A%20%20%20%20c_list%20%3D%20%5Bget_racer_color(r)%20for%20r%20in%20r_list%5D%0A%0A%20%20%20%20%23%20---%20CONSTANTS%20---%0A%20%20%20%20%23%20Reducing%20fixed%20height%20to%20fit%20smaller%20screens%20better%0A%20%20%20%20CHART_HEIGHT%20%3D%20chart_height_slider.value%0A%0A%20%20%20%20%23%20---%202.%20ABILITY%20SHIFT%20CHART%20---%0A%20%20%20%20df_racer%20%3D%20abilities_df.with_columns(%0A%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22%2B%20Self%22).abs()%20%2B%20pl.col(%22-%20Others%22).abs())%0A%20%20%20%20%20%20%20%20%20%20%20%20-%20(pl.col(%22-%20Self%22).abs()%20%2B%20pl.col(%22%2B%20Others%22).abs())%0A%20%20%20%20%20%20%20%20).alias(%22net_benefit_score%22)%2C%0A%20%20%20%20).sort(%22net_benefit_score%22%2C%20descending%3DTrue)%0A%20%20%20%20y_sort_order%20%3D%20df_racer%5B%22racer_name%22%5D.to_list()%0A%20%20%20%20df_long%20%3D%20df_racer.melt(%0A%20%20%20%20%20%20%20%20id_vars%3D%5B%22racer_name%22%5D%2C%0A%20%20%20%20%20%20%20%20value_vars%3DMETRIC_ORDER%2C%0A%20%20%20%20%20%20%20%20variable_name%3D%22metric%22%2C%0A%20%20%20%20%20%20%20%20value_name%3D%22magnitude%22%2C%0A%20%20%20%20)%0A%20%20%20%20df_long%20%3D%20df_long.with_columns(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22metric%22).is_in(%5B%22%2B%20Self%22%2C%20%22-%20Others%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(-pl.col(%22magnitude%22).abs())%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.col(%22magnitude%22).abs())%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22magnitude_signed%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.when(pl.col(%22metric%22).is_in(%5B%22%2B%20Self%22%2C%20%22-%20Self%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.then(pl.lit(0))%0A%20%20%20%20%20%20%20%20%20%20%20%20.otherwise(pl.lit(1))%0A%20%20%20%20%20%20%20%20%20%20%20%20.alias(%22stack_order%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%20%20%20%20neg_sums%20%3D%20(%0A%20%20%20%20%20%20%20%20df_long.filter(pl.col(%22magnitude_signed%22)%20%3C%200)%0A%20%20%20%20%20%20%20%20.group_by(%22racer_name%22)%0A%20%20%20%20%20%20%20%20.agg(pl.col(%22magnitude_signed%22).sum().alias(%22left_edge%22))%0A%20%20%20%20)%0A%20%20%20%20df_racer%20%3D%20df_racer.join(neg_sums%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22).with_columns(%0A%20%20%20%20%20%20%20%20pl.col(%22left_edge%22).fill_null(0)%2C%0A%20%20%20%20)%0A%20%20%20%20global_min_edge%20%3D%20df_racer%5B%22left_edge%22%5D.min()%0A%20%20%20%20global_max_val%20%3D%20df_long%5B%22magnitude_signed%22%5D.max()%0A%20%20%20%20domain_min%20%3D%20global_min_edge%20*%201.1%20if%20global_min_edge%20%3C%200%20else%20-1.0%0A%20%20%20%20domain_max%20%3D%20global_max_val%20*%201.05%0A%20%20%20%20y_axis_config%20%3D%20alt.Y(%22racer_name%3AN%22%2C%20sort%3Dy_sort_order%2C%20axis%3DNone)%0A%0A%20%20%20%20bars%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(df_long)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dy_axis_config%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22magnitude_signed%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Movement%20Impact%20(Normalized)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3D%5Bdomain_min%2C%20domain_max%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(grid%3DFalse%2C%20labelColor%3D%22%23E0E0E0%22%2C%20titleColor%3D%22%23E0E0E0%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3DBAR_CHART_COLORS%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sort%3DMETRIC_ORDER%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Ability%20Type%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20orient%3D%22none%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legendX%3D60%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legendY%3DCHART_HEIGHT%20-%20180%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20direction%3D%22vertical%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20titleColor%3D%22%23E0E0E0%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelColor%3D%22%23E0E0E0%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20order%3Dalt.Order(%22stack_order%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22magnitude%3AQ%22%2C%20format%3D%22.2f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20text_labels%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(df_racer)%0A%20%20%20%20%20%20%20%20.mark_text(align%3D%22right%22%2C%20baseline%3D%22middle%22%2C%20dx%3D-8%2C%20fontSize%3D12%2C%20fontWeight%3D700)%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dy_axis_config%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22left_edge%3AQ%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20text%3D%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3Dr_list%2C%20range%3Dc_list)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20final_ability_chart%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.layer(%0A%20%20%20%20%20%20%20%20%20%20%20%20bars%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(pl.DataFrame(%7B%22x%22%3A%20%5B0%5D%7D))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_rule(color%3D%22%23888%22%2C%20strokeDash%3D%5B2%2C%202%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(x%3D%22x%3AQ%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20text_labels%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.resolve_scale(color%3D%22independent%22)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D%22container%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3DCHART_HEIGHT%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3Dalt.TitleParams(%22Racer%20Ability%20Speed%20Profile%22%2C%20color%3D%22%23E0E0E0%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3D%22transparent%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%203.%20QUADRANT%20CHARTS%20---%0A%20%20%20%20c_consist%20%3D%20build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22consistency_score%22%2C%0A%20%20%20%20%20%20%20%20%22mean_vp%22%2C%0A%20%20%20%20%20%20%20%20%22Consistency%22%2C%0A%20%20%20%20%20%20%20%20%22Stability%22%2C%0A%20%20%20%20%20%20%20%20%22Avg%20VP%22%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Wildcard%22%2C%20%22Reliable%20Winner%22%2C%20%22Erratic%22%2C%20%22Reliable%20Loser%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3D%5Balt.Tooltip(%22std_vp_sigma%3AQ%22%2C%20format%3D%22.2f%22)%5D%2C%0A%20%20%20%20).properties(height%3DCHART_HEIGHT)%0A%0A%20%20%20%20c_momentum%20%3D%20build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22start_pos_bias%22%2C%0A%20%20%20%20%20%20%20%20%22midgame_bias%22%2C%0A%20%20%20%20%20%20%20%20%22Momentum%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Start%20Pos%20Bias%22%2C%0A%20%20%20%20%20%20%20%20%22Mid-Game%20Bias%22%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Late%20Bloomer%22%2C%20%22Snowballer%22%2C%20%22Comeback%20King%22%2C%20%22Frontrunner%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20extra_tooltips%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22pct_1st%3AQ%22%2C%20format%3D%22.1%25%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22mean_vp%3AQ%22%2C%20format%3D%22.2f%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20).properties(height%3DCHART_HEIGHT)%0A%0A%20%20%20%20c_excitement%20%3D%20build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22avg_race_tightness%22%2C%0A%20%20%20%20%20%20%20%20%22avg_race_volatility%22%2C%0A%20%20%20%20%20%20%20%20%22Excitement%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Tightness%22%2C%0A%20%20%20%20%20%20%20%20%22Volatility%22%2C%0A%20%20%20%20%20%20%20%20reverse_x%3DTrue%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Rubber%20Band%22%2C%20%22Thriller%22%2C%20%22Procession%22%2C%20%22Stalemate%22%5D%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20).properties(height%3DCHART_HEIGHT)%0A%0A%20%20%20%20c_engine%20%3D%20build_quadrant_chart(%0A%20%20%20%20%20%20%20%20stats%2C%0A%20%20%20%20%20%20%20%20r_list%2C%0A%20%20%20%20%20%20%20%20c_list%2C%0A%20%20%20%20%20%20%20%20%22dice_sensitivity%22%2C%0A%20%20%20%20%20%20%20%20%22trigger_dependency%22%2C%0A%20%20%20%20%20%20%20%20%22Engine%20Profile%22%2C%0A%20%20%20%20%20%20%20%20%22Dice%20Sensitivity%22%2C%0A%20%20%20%20%20%20%20%20%22Ability%20Efficacy%22%2C%0A%20%20%20%20%20%20%20%20use_rank_scale%3Ddynamic_zoom_toggle.value%2C%0A%20%20%20%20%20%20%20%20quad_labels%3D%5B%22Technician%22%2C%20%22Unstable%22%2C%20%22Independent%22%2C%20%22Gambler%22%5D%2C%0A%20%20%20%20).properties(height%3DCHART_HEIGHT)%0A%0A%20%20%20%20%23%20---%204.%20GLOBAL%20DYNAMICS%20---%0A%20%20%20%20color_turns%20%3D%20%22%2340B0A6%22%0A%20%20%20%20color_vp%20%3D%20%22%23D81B60%22%0A%20%20%20%20player_count_scale%20%3D%20alt.Scale(%0A%20%20%20%20%20%20%20%20range%3D%5B%22%2340B0A6%22%2C%20%22%23FFC107%22%2C%20%22%23D81B60%22%2C%20%22%231E88E5%22%2C%20%22%239C27B0%22%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20race_meta%20%3D%20df_races_f.select(%5B%22config_hash%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20joined_env%20%3D%20proc_results.join(race_meta%2C%20on%3D%22config_hash%22%2C%20how%3D%22inner%22)%0A%0A%20%20%20%20race_level_agg%20%3D%20proc_races.group_by(%5B%22board%22%2C%20%22racer_count%22%5D).agg(%0A%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).mean().alias(%22Avg%20Turns%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22tightness_score%22).mean().alias(%22Tightness%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22volatility_score%22).mean().alias(%22Volatility%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_avg_trip_rate%22).mean().alias(%22Trip%20Rate%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22race_avg_triggers%22).mean().alias(%22Abilities%20Triggered%22)%2C%0A%20%20%20%20)%0A%20%20%20%20result_level_agg%20%3D%20(%0A%20%20%20%20%20%20%20%20joined_env.group_by(%5B%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22sum_dice_rolled%22%2C%20%22final_vp%22).alias(%22Dice%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22net_self_movement%22%2C%20%22final_vp%22).alias(%22Ability%20Dep%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.corr(%22racer_id%22%2C%20%22final_vp%22)%20*%20-1).alias(%22Start%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.corr(%22midgame_relative_pos%22%2C%20%22final_vp%22).alias(%22MidGame%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.fill_nan(0)%0A%20%20%20%20)%0A%0A%20%20%20%20global_wide%20%3D%20race_level_agg.join(%0A%20%20%20%20%20%20%20%20result_level_agg%2C%0A%20%20%20%20%20%20%20%20on%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%0A%20%20%20%20%20%20%20%20how%3D%22inner%22%2C%0A%20%20%20%20).fill_nan(0)%0A%0A%20%20%20%20c_global_1%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(%0A%20%20%20%20%20%20%20%20%20%20%20%20global_wide.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Avg%20VP%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Avg%20Turns%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Tightness%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Volatility%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Trip%20Rate%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20).unpivot(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20index%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20variable_name%3D%22metric%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value_name%3D%22val%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22board%3AN%22%2C%20title%3D%22Board%22%2C%20axis%3Dalt.Axis(labelAngle%3D0))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xOffset%3Dalt.XOffset(%22racer_count%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22val%3AQ%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22racer_count%3AN%22%2C%20title%3D%22Players%22%2C%20scale%3Dplayer_count_scale)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20column%3Dalt.Column(%22metric%3AN%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22val%3AQ%22%2C%20format%3D%22.3f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.resolve_scale(y%3D%22independent%22)%0A%20%20%20%20%20%20%20%20.properties(width%3D120%2C%20height%3D200%2C%20background%3D%22transparent%22)%0A%20%20%20%20)%0A%20%20%20%20c_global_2%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(%0A%20%20%20%20%20%20%20%20%20%20%20%20global_wide.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Dice%20Dep%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Ability%20Dep%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Start%20Bias%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22MidGame%20Bias%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Abilities%20Triggered%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20).unpivot(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20index%3D%5B%22board%22%2C%20%22racer_count%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20variable_name%3D%22metric%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value_name%3D%22val%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22board%3AN%22%2C%20title%3D%22Board%22%2C%20axis%3Dalt.Axis(labelAngle%3D0))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xOffset%3Dalt.XOffset(%22racer_count%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22val%3AQ%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22racer_count%3AN%22%2C%20title%3D%22Players%22%2C%20scale%3Dplayer_count_scale)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20column%3Dalt.Column(%22metric%3AN%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22board%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_count%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22metric%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22val%3AQ%22%2C%20format%3D%22.3f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.resolve_scale(y%3D%22independent%22)%0A%20%20%20%20%20%20%20%20.properties(width%3D120%2C%20height%3D200%2C%20background%3D%22transparent%22)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%204.5%20DISTRIBUTIONS%20---%0A%20%20%20%20q_low%2C%20q_high%20%3D%200.02%2C%200.98%0A%20%20%20%20bounds%20%3D%20dist_raw.select(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).quantile(q_low).alias(%22t_min%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).quantile(q_high).alias(%22t_max%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22total_race_vp%22).quantile(q_low).alias(%22v_min%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22total_race_vp%22).quantile(q_high).alias(%22v_max%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20).to_dicts()%5B0%5D%0A%0A%20%20%20%20dist_viz%20%3D%20dist_raw.filter(%0A%20%20%20%20%20%20%20%20pl.col(%22race_global_turns%22).is_between(bounds%5B%22t_min%22%5D%2C%20bounds%5B%22t_max%22%5D)%0A%20%20%20%20%20%20%20%20%26%20pl.col(%22total_race_vp%22).is_between(bounds%5B%22v_min%22%5D%2C%20bounds%5B%22v_max%22%5D)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20n_bins%20%3D%2020%0A%20%20%20%20turns_min%20%3D%20float(dist_viz%5B%22race_global_turns%22%5D.min())%0A%20%20%20%20turns_max%20%3D%20float(dist_viz%5B%22race_global_turns%22%5D.max())%0A%20%20%20%20vp_min%20%3D%20float(dist_viz%5B%22total_race_vp%22%5D.min())%0A%20%20%20%20vp_max%20%3D%20float(dist_viz%5B%22total_race_vp%22%5D.max())%0A%20%20%20%20turns_step%20%3D%20(turns_max%20-%20turns_min)%20%2F%20n_bins%20if%20turns_max%20%3E%20turns_min%20else%201.0%0A%20%20%20%20vp_step%20%3D%20(vp_max%20-%20vp_min)%20%2F%20n_bins%20if%20vp_max%20%3E%20vp_min%20else%201.0%0A%0A%20%20%20%20def%20add_bins(df%2C%20col%2C%20min_v%2C%20step_v%2C%20prefix)%3A%0A%20%20%20%20%20%20%20%20idx%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20((pl.col(col)%20-%20min_v)%20%2F%20step_v).floor().cast(pl.Int64).clip(0%2C%20n_bins%20-%201)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20start%20%3D%20(pl.lit(min_v)%20%2B%20idx%20*%20pl.lit(step_v)).round(0).cast(pl.Int64)%0A%20%20%20%20%20%20%20%20end%20%3D%20(start%20%2B%20pl.lit(step_v)).round(0).cast(pl.Int64)%0A%20%20%20%20%20%20%20%20label%20%3D%20start.cast(pl.Utf8)%20%2B%20pl.lit(%22-%22)%20%2B%20end.cast(pl.Utf8)%0A%20%20%20%20%20%20%20%20return%20%5Bidx.alias(f%22%7Bprefix%7D_idx%22)%2C%20label.alias(f%22%7Bprefix%7D_label%22)%5D%0A%0A%20%20%20%20dist_binned%20%3D%20dist_viz.with_columns(%0A%20%20%20%20%20%20%20%20add_bins(dist_viz%2C%20%22race_global_turns%22%2C%20turns_min%2C%20turns_step%2C%20%22turns%22)%0A%20%20%20%20%20%20%20%20%2B%20add_bins(dist_viz%2C%20%22total_race_vp%22%2C%20vp_min%2C%20vp_step%2C%20%22vp%22)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20def%20make_long_dist(df%2C%20group_cols)%3A%0A%20%20%20%20%20%20%20%20group_cols_eff%20%3D%20%5B%22_grp%22%5D%20if%20len(group_cols)%20%3D%3D%200%20else%20group_cols%0A%20%20%20%20%20%20%20%20if%20len(group_cols)%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20df.with_columns(pl.lit(1).alias(%22_grp%22))%0A%0A%20%20%20%20%20%20%20%20t%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df.group_by(group_cols_eff%20%2B%20%5B%22turns_idx%22%2C%20%22turns_label%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.len().alias(%22count%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22count%22)%20%2F%20pl.col(%22count%22).sum().over(group_cols_eff)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22turns_idx%22).alias(%22bin_index%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22turns_label%22).alias(%22bin_label%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.lit(%22Game%20Length%20(Turns)%22).alias(%22series_type%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.lit(1).alias(%22direction%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20v%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20df.group_by(group_cols_eff%20%2B%20%5B%22vp_idx%22%2C%20%22vp_label%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(pl.len().alias(%22count%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22count%22)%20%2F%20pl.col(%22count%22).sum().over(group_cols_eff)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22vp_idx%22).alias(%22bin_index%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22vp_label%22).alias(%22bin_label%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.lit(%22Total%20VP%22).alias(%22series_type%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.lit(-1).alias(%22direction%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20out%20%3D%20pl.concat(%0A%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20t.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20group_cols_eff%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_index%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_label%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22series_type%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22direction%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20group_cols_eff%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_index%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_label%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22series_type%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22direction%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20return%20out.drop(%22_grp%22)%20if%20%22_grp%22%20in%20out.columns%20else%20out%0A%0A%20%20%20%20df_dist_global%20%3D%20make_long_dist(dist_binned%2C%20%5B%5D)%0A%20%20%20%20df_dist_faceted%20%3D%20make_long_dist(dist_binned%2C%20%5B%22board%22%2C%20%22racer_count%22%5D)%0A%0A%20%20%20%20df_turns%20%3D%20df_dist_global.filter(pl.col(%22direction%22)%20%3D%3D%201)%0A%20%20%20%20df_vp%20%3D%20df_dist_global.filter(pl.col(%22direction%22)%20%3D%3D%20-1)%0A%0A%20%20%20%20c_dist_global_top%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(df_turns)%0A%20%20%20%20%20%20%20%20.mark_bar(color%3Dcolor_turns)%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_label%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sort%3Dalt.SortField(%22bin_index%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20orient%3D%22top%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Game%20Length%20(Turns)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelAngle%3D-45%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelOverlap%3D%22parity%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22pct%3AQ%22%2C%20axis%3Dalt.Axis(format%3D%22%25%22%2C%20title%3DNone))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%22bin_label%22%2C%20alt.Tooltip(%22pct%22%2C%20format%3D%22.1%25%22)%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(width%3D%22container%22%2C%20height%3D140)%0A%20%20%20%20)%0A%0A%20%20%20%20c_dist_global_bottom%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(df_vp)%0A%20%20%20%20%20%20%20%20.mark_bar(color%3Dcolor_vp)%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_label%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sort%3Dalt.SortField(%22bin_index%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20orient%3D%22bottom%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Total%20VP%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelAngle%3D-45%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelOverlap%3D%22parity%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(reverse%3DTrue)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(format%3D%22%25%22%2C%20title%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%22bin_label%22%2C%20alt.Tooltip(%22pct%22%2C%20format%3D%22.1%25%22)%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(width%3D%22container%22%2C%20height%3D140)%0A%20%20%20%20)%0A%0A%20%20%20%20c_dist_global%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.vconcat(c_dist_global_top%2C%20c_dist_global_bottom%2C%20spacing%3D10)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Global%20Distribution%3A%20Game%20Length%20(Top)%20vs%20Total%20VP%20(Bottom)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3D%22transparent%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20autosize%3D%7B%22contains%22%3A%20%22padding%22%7D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.configure_view(stroke%3DNone)%0A%20%20%20%20%20%20%20%20.configure(autosize%3D%7B%22type%22%3A%20%22fit-x%22%2C%20%22contains%22%3A%20%22padding%22%7D)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%20DEFINITION%20FIXED%3A%20Defined%20BEFORE%20usage%20---%0A%20%20%20%20scale_facet%20%3D%20alt.Scale(%0A%20%20%20%20%20%20%20%20domain%3D%5B%22Game%20Length%20(Turns)%22%2C%20%22Total%20VP%22%5D%2C%0A%20%20%20%20%20%20%20%20range%3D%5Bcolor_turns%2C%20color_vp%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20c_dist_faceted%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(df_dist_faceted)%0A%20%20%20%20%20%20%20%20.transform_calculate(pct_signed%3D%22datum.pct%20*%20datum.direction%22)%0A%20%20%20%20%20%20%20%20.mark_bar()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bin_index%3AO%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(labels%3DFalse%2C%20ticks%3DFalse)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22pct_signed%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3Dalt.Axis(format%3D%22%25%22%2C%20labels%3DFalse)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3D%5B-0.3%2C%200.3%5D%2C%20clamp%3DTrue)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22series_type%3AN%22%2C%20scale%3Dscale_facet%2C%20legend%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%22series_type%22%2C%20%22bin_label%22%2C%20alt.Tooltip(%22pct%22%2C%20format%3D%22.1%25%22)%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(width%3D300%2C%20height%3D200)%0A%20%20%20%20)%0A%0A%20%20%20%20c_dist_faceted%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.layer(%0A%20%20%20%20%20%20%20%20%20%20%20%20c_dist_faceted%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart().mark_rule(color%3D%22%23FFF%22%2C%20opacity%3D0.3).encode(y%3Dalt.datum(0))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20data%3Ddf_dist_faceted%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.facet(%0A%20%20%20%20%20%20%20%20%20%20%20%20row%3Dalt.Row(%22board%3AN%22%2C%20title%3D%22Board%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20column%3Dalt.Column(%22racer_count%3AN%22%2C%20title%3D%22Player%20Count%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(background%3D%22transparent%22)%0A%20%20%20%20%20%20%20%20.configure_view(stroke%3DNone)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%205.%20MATCHUPS%20%26%20ENV%20---%0A%20%20%20%20use_pct%20%3D%20matchup_metric_toggle.value%0A%20%20%20%20metric_col%20%3D%20%22percentage_shift%22%20if%20use_pct%20else%20%22residual_matchup%22%0A%20%20%20%20c_matrix%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(matchup_df)%0A%20%20%20%20%20%20%20%20.mark_rect()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22opponent_name%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22racer_name%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7Bmetric_col%7D%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20range%3D%5B%22%23AD1457%22%2C%20%22%23F06292%22%2C%20%22%233E3B45%22%2C%20%22%2342A5F5%22%2C%20%22%230D47A1%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domainMid%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(format%3D(%22%2B.1%25%22%20if%20use_pct%20else%20%22%2B.2f%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22opponent_name%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22percentage_shift%3AQ%22%2C%20format%3D%22%2B.1%25%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Matchup%20Matrix%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D%22container%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3DCHART_HEIGHT%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3DBG_COLOR%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20racer_baselines%20%3D%20joined_env.group_by(%22racer_name%22).agg(%0A%20%20%20%20%20%20%20%20pl.col(%22final_vp%22).mean().alias(%22racer_global_avg_vp%22)%2C%0A%20%20%20%20)%0A%20%20%20%20env_stats%20%3D%20(%0A%20%20%20%20%20%20%20%20joined_env.group_by(%5B%22racer_name%22%2C%20%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.agg(pl.col(%22final_vp%22).mean().alias(%22cond_avg_vp%22))%0A%20%20%20%20%20%20%20%20.join(racer_baselines%2C%20on%3D%22racer_name%22%2C%20how%3D%22left%22)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cond_avg_vp%22)%20-%20pl.col(%22racer_global_avg_vp%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%20pl.col(%22racer_global_avg_vp%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22relative_shift%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(pl.col(%22cond_avg_vp%22)%20-%20pl.col(%22racer_global_avg_vp%22)).alias(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22absolute_shift%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22racer_count%22).cast(pl.String)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22p%5Cn%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20pl.col(%22board%22).cast(pl.String)%0A%20%20%20%20%20%20%20%20%20%20%20%20).alias(%22env_label%22)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20env_sort_order%20%3D%20(%0A%20%20%20%20%20%20%20%20env_stats.select(%5B%22board%22%2C%20%22racer_count%22%2C%20%22env_label%22%5D)%0A%20%20%20%20%20%20%20%20.unique()%0A%20%20%20%20%20%20%20%20.sort(%5B%22board%22%2C%20%22racer_count%22%5D)%0A%20%20%20%20%20%20%20%20.get_column(%22env_label%22)%0A%20%20%20%20%20%20%20%20.to_list()%0A%20%20%20%20)%0A%0A%20%20%20%20c_env%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(env_stats)%0A%20%20%20%20%20%20%20%20.mark_rect()%0A%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22env_label%3AN%22%2C%20sort%3Denv_sort_order)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22racer_name%3AN%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%7B('relative_shift'%20if%20use_pct%20else%20'absolute_shift')%7D%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20range%3D%5B%22%23AD1457%22%2C%20%22%23F06292%22%2C%20%22%233E3B45%22%2C%20%22%2342A5F5%22%2C%20%22%230D47A1%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domainMid%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(format%3D(%22.0%25%22%20if%20use_pct%20else%20%22%2B.2f%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22racer_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22env_label%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20alt.Tooltip(%22relative_shift%3AQ%22%2C%20format%3D%22%2B.1%25%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Env%20Adaptability%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D%22container%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3DCHART_HEIGHT%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20background%3DBG_COLOR%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%206.%20TABLES%20---%0A%20%20%20%20master_df%20%3D%20stats.sort(%22mean_vp%22%2C%20descending%3DTrue)%0A%20%20%20%20df_overview%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22mean_vp%22).round(2).alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22consistency_score%22)%20*%20100).round(1).alias(%22Consist%25%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22pct_1st%22)%20*%20100).round(1).alias(%221st%25%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22pct_2nd%22)%20*%20100).round(1).alias(%222nd%25%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22races_run%22).alias(%22%23%20Races%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_movement%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_speed_raw%22).round(2).alias(%22Speed%20(Raw)%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_net_movement%22).round(2).alias(%22%2BRel%20Abil%20Speed%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22avg_active_turns_pct%22)%20*%20100).round(1).alias(%22Rolling%20Turns%20%25%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_pos_self%22).round(2).alias(%22Abil%20%2BSelf%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_neg_self%22).round(2).alias(%22Abil%20-Self%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_abilities%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22triggers_per_turn%22).round(2).alias(%22Trig%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22self_targets_per_turn%22).round(2).alias(%22Self-Targ%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22own_turn_triggers_per_turn%22).round(2).alias(%22OwnTurn%20Trig%2FTurn%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_pos_other%22).round(2).alias(%22Abil%20%2BOther%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_neg_other%22).round(2).alias(%22Abil%20-Other%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_dynamics%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_race_volatility%22).cast(pl.Float64).round(2).alias(%22Volatility%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_race_tightness%22).cast(pl.Float64).round(2).alias(%22Tightness%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_game_duration%22).round(1).alias(%22Avg%20Game%20Len%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22avg_env_triggers%22).round(1).alias(%22Race%20Trigs%22)%2C%0A%20%20%20%20%20%20%20%20(pl.col(%22avg_env_trip_rate%22)%20*%20100).round(1).alias(%22Race%20Trip%25%22)%2C%0A%20%20%20%20)%0A%20%20%20%20df_vp%20%3D%20master_df.select(%0A%20%20%20%20%20%20%20%20pl.col(%22racer_name%22).alias(%22Racer%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22mean_vp%22).round(2).alias(%22Avg%20VP%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22dice_sensitivity%22).round(2).alias(%22Dice%20Sens%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22trigger_dependency%22).round(2).alias(%22Ability%20Trig%20Sens%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22start_pos_bias%22).round(2).alias(%22Start%20Bias%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22midgame_bias%22).round(2).alias(%22MidGame%20Bias%22)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%207.%20UI%20COMPOSITION%20---%0A%20%20%20%20desc_ability%20%3D%20mo.md(%22%22%22%0A%20%20%20%20*%20**Left%20Side%20(Beneficial)%3A**%20%60%2BSelf%60%20(Speed%20Boosts)%20and%20%60-Others%60%20(Pushing%20others%2FTripping).%20%20%0A%20%20%20%20*%20**Right%20Side%20(Cost%2FAltruism)%3A**%20%60-Self%60%20(Investments%2FCooldowns)%20and%20%60%2BOthers%60%20(Helping).%20%20%0A%20%20%20%20*%20**Sorting%3A**%20Racers%20are%20ordered%20by%20Net%20Benefit%20(Total%20Good%20-%20Total%20Cost).%0A%20%20%20%20%22%22%22)%0A%0A%20%20%20%20desc_consist%20%3D%20mo.md(%22%22%22%0A%20%20%20%20*%20**Y-Axis%20(Avg%20VP)%3A**%20How%20many%20points%20they%20score%20on%20average.%20%20%0A%20%20%20%20*%20**X-Axis%20(Stability)%3A**%20How%20reliably%20they%20hit%20that%20average.%20High%20stability%20means%20low%20variance.%0A%20%20%20%20%22%22%22)%0A%0A%20%20%20%20desc_momentum%20%3D%20mo.md(%22%22%22%0A%20%20%20%20*%20**Start%20Bias%3A**%20Does%20starting%20earlier%20help%20them%20win%20more%20VP%3F.%20%20%0A%20%20%20%20*%20**Mid-Game%20Bias%3A**%20How%20many%20VPs%20do%20they%20gain%20from%20from%20a%20leading%20position%20after%202%2F3%20of%20the%20race.%0A%20%20%20%20%22%22%22)%0A%0A%20%20%20%20desc_excitement%20%3D%20mo.md(%22%22%22%0A%20%20%20%20*%20**Tightness%3A**%20How%20close%20the%20racers%20are%20together%20throughout%20the%20race%20(Right%20%3D%20Closer).%20%20%0A%20%20%20%20*%20**Volatility%3A**%20How%20much%20the%20lead%20changes%20(Top%20%3D%20More%20Chaos).%0A%20%20%20%20%22%22%22)%0A%0A%20%20%20%20desc_engine%20%3D%20mo.md(%22%22%22%0A%20%20%20%20*%20**Y-Axis%20(Ability%20Sensitivity)%3A**%20Correlation%20between%20using%20abilities%20and%20VP.%20High%20%3D%20Ability%20trigger%20counts%20decide%20how%20many%20VP%20are%20earned.%0A%20%20%20%20*%20**X-Axis%20(Dice%20Sensitivity)%3A**%20Correlation%20between%20rolls%20and%20VP.%20High%20%3D%20Needs%20high%20(or%20low)%20rolls%20to%20get%20VP.%0A%20%20%20%20%22%22%22)%0A%0A%20%20%20%20global_ui%20%3D%20mo.vstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_global_1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_global_2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_dist_global)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_dist_faceted)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20chart_height_slider_ui%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20chart_height_slider%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22chart%20height%20(px)%22)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20justify%3D%22start%22%2C%0A%20%20%20%20)%0A%20%20%20%20chart_config_ui%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5Bdynamic_zoom_toggle%2C%20chart_height_slider_ui%5D%2C%0A%20%20%20%20%20%20%20%20gap%3D12%2C%0A%20%20%20%20)%0A%20%20%20%20left_charts_ui%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8E%AF%20Consistency%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c_consist.interactive()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chart_config_ui%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20desc_consist%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%A1%20Ability%20Speed%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bfinal_ability_chart%2C%20chart_height_slider_ui%2C%20desc_ability%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8A%20Momentum%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bc_momentum.interactive()%2C%20chart_config_ui%2C%20desc_momentum%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%94%A5%20Excitement%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bc_excitement.interactive()%2C%20chart_config_ui%2C%20desc_excitement%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%99%EF%B8%8F%20Engine%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bc_engine.interactive()%2C%20chart_config_ui%2C%20desc_engine%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8D%20Global%22%3A%20global_ui%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20right_ui%20%3D%20mo.ui.tabs(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8F%86%20Overview%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_overview%2C%20page_size%3D50%2C%20selection%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Overview**%3A%20Summary%20stats.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%94%EF%B8%8F%20Interactions%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_matrix)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Matchups**%3A%20Subject%20vs%20Opponent.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8C%8D%20Environments%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20matchup_metric_toggle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.altair_chart(c_env)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Environment**%3A%20Board%2FPlayer%20Count%20effects.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%8F%83%20Movement%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_movement%2C%20page_size%3D50%2C%20selection%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Movement**%3A%20Speed%20%26%20Efficiency.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%92%8E%20VP%20Analysis%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_vp%2C%20page_size%3D50%2C%20selection%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**VP%20Analysis**%3A%20Correlations.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%E2%9A%A1%20Abilities%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_abilities%2C%20page_size%3D50%2C%20selection%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Abilities**%3A%20Triggers%20%26%20Control.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%F0%9F%94%A5%20Dynamics%22%3A%20mo.vstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(df_dynamics%2C%20page_size%3D50%2C%20selection%3DNone)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22**Dynamics**%3A%20Chaos%20%26%20Duration.%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20---%208.%20FINAL%20LAYOUT%20---%0A%0A%20%20%20%20%23%20Left%20Column%3A%20Charts%0A%20%20%20%20left_style%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22flex%22%3A%20%221%201%201100px%22%2C%0A%20%20%20%20%20%20%20%20%22min-width%22%3A%20%220%22%2C%0A%20%20%20%20%20%20%20%20%22overflow-x%22%3A%20%22auto%22%2C%0A%20%20%20%20%20%20%20%20%22max-width%22%3A%20%221100px%22%2C%20%20%23%20Constrains%20width%20to%20keep%20charts%20square-ish%0A%20%20%20%20%20%20%20%20%22width%22%3A%20%22100%25%22%2C%0A%20%20%20%20%20%20%20%20%22margin%22%3A%20%220%20auto%22%2C%20%20%23%20Centers%20the%20column%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%20Right%20Column%3A%20Tables%0A%20%20%20%20right_style%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22flex%22%3A%20%221%201%20950px%22%2C%0A%20%20%20%20%20%20%20%20%22min-width%22%3A%20%220%22%2C%0A%20%20%20%20%20%20%20%20%22overflow-x%22%3A%20%22auto%22%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20final_output%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5Bleft_charts_ui.style(left_style)%2C%20right_ui.style(right_style)%5D%2C%0A%20%20%20%20%20%20%20%20wrap%3DTrue%2C%0A%20%20%20%20%20%20%20%20gap%3D2%2C%0A%20%20%20%20%20%20%20%20align%3D%22start%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Explicitly%20return%2Fevaluate%20the%20output%20to%20display%20it%0A%20%20%20%20final_output%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "read",
            "version": "0.20.2",
            "serverToken": "unused",
            "config": {"ai": {"custom_providers": {}, "models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false, "signature_hint_on_typing": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": false, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": false}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": false, "auto_reload": "off", "default_csv_encoding": "utf-8", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"app_title": "Magical Athlete Simulator", "css_file": "docs/magical_athlete_analysis.css", "sql_output": "auto", "width": "full"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
